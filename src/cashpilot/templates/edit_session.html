{% extends "base.html" %}

{% block title %}{{ _('Close Session') }} - CashPilot{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Form -->
    <div class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">{{ _('Close Cash Session') }}</h2>
                <p class="text-sm text-base-content opacity-75 mb-4">
                    {{ _('Cashier:') }} <strong>{{ session.cashier_name }}</strong> |
                    {{ _('Status:') }} <strong>{{ session.status }}</strong>
                </p>

                <form method="POST" action="/sessions/{{ session.id }}" class="space-y-4">
                    <input type="hidden" name="_method" value="PUT" />

                    <!-- Final Cash -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Final Cash Count (â‚²)') }}</span>
                        </label>
                        <input type="text" name="final_cash" class="input input-bordered"
                               placeholder="1250000" inputmode="decimal" required/>
                        <label class="label">
                            <span class="label-text-alt">{{ _('Total counted in drawer') }}</span>
                        </label>
                    </div>

                    <!-- Envelope Amount -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Envelope Amount (â‚²)') }}</span>
                        </label>
                        <input type="text" name="envelope_amount" class="input input-bordered"
                               placeholder="0" inputmode="decimal" required/>
                        <label class="label">
                            <span class="label-text-alt">{{ _('Cash removed from register (if any)') }}</span>
                        </label>
                    </div>

                    <!-- Payment Methods Section -->
                    <div class="divider">{{ _('Payment Methods') }}</div>

                    <!-- Credit Card -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Credit Card Total (â‚²)') }}</span>
                        </label>
                        <input type="text" name="credit_card_total" class="input input-bordered"
                               placeholder="0" inputmode="decimal" required/>
                    </div>

                    <!-- Debit Card -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Debit Card Total (â‚²)') }}</span>
                        </label>
                        <input type="text" name="debit_card_total" class="input input-bordered"
                               placeholder="0" inputmode="decimal"/>
                    </div>

                    <!-- Bank Transfer -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Bank Transfer Total (â‚²)') }}</span>
                        </label>
                        <input type="text" name="bank_transfer_total" class="input input-bordered"
                               placeholder="0" inputmode="decimal"/>
                    </div>

                    <!-- Expenses -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Expenses (â‚²)') }}</span>
                        </label>
                        <input type="text" name="expenses" class="input input-bordered"
                               placeholder="0" inputmode="decimal"/>
                        <label class="label">
                            <span class="label-text-alt">{{ _('Business expenses during shift') }}</span>
                        </label>
                    </div>

                    <!-- Closed Time (NEW) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Closed At (Time)') }}</span>
                        </label>
                        <input type="time" name="closed_time" class="input input-bordered" id="closed-time"/>
                        <label class="label">
                            <span class="label-text-alt">{{ _('Leave blank for current time') }}</span>
                        </label>
                    </div>

                    <!-- Additional Info -->
                    <div class="divider">{{ _('Additional Info') }}</div>

                    <!-- Closing Ticket -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Closing Ticket #') }}</span>
                        </label>
                        <input type="text" name="closing_ticket" class="input input-bordered"
                               placeholder="{{ _('e.g., T-20251112-001') }}"/>
                        <label class="label">
                            <span class="label-text-alt">{{ _('Optional: POS ticket number') }}</span>
                        </label>
                    </div>

                    <!-- Notes -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">{{ _('Notes') }}</span>
                        </label>
                        <textarea name="notes" class="textarea textarea-bordered h-24"
                                  placeholder="{{ _('Any discrepancies or notes...') }}"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-control mt-6">
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success flex-1">{{ _('Close Session') }}</button>
                            <a href="/sessions/{{ session.id }}" class="btn btn-outline flex-1">{{ _('Cancel') }}</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar: Reconciliation Preview & Opening Info -->
    <div class="lg:col-span-1 space-y-4">
        <!-- Opening Summary -->
        <div class="card bg-base-100 shadow-xl text-base-content">
            <div class="card-body">
                <h3 class="card-title text-lg">{{ _('Opening Info') }}</h3>
                <div class="space-y-2 text-sm">
                    <div>
                        <span class="label-text-alt">{{ _('Session Date:') }}</span>
                        <p class="font-semibold">{{ session.session_date.strftime('%Y-%m-%d') }}</p>
                    </div>
                    <div>
                        <span class="label-text-alt">{{ _('Opened At:') }}</span>
                        <p class="font-semibold">{{ session.opened_time.strftime('%H:%M') }}</p>
                    </div>
                    <div>
                        <span class="label-text-alt">{{ _('Initial Cash:') }}</span>
                        <p class="font-semibold">â‚² {{ "{:,.0f}".format(session.initial_cash) }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reconciliation Preview (JavaScript updates) -->
        <div class="card bg-success text-success-content shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-lg">{{ _('Reconciliation Preview') }}</h3>
                <div class="space-y-2 text-sm" id="preview">
                    <p class="opacity-75">{{ _('Fill form fields to see preview...') }}</p>
                </div>
            </div>
        </div>

        <!-- Quick Reference -->
        <div class="card bg-accent text-accent-content shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-sm">ðŸ“‹ {{ _('Formula') }}</h3>
                <div class="text-xs space-y-1">
                    <p><strong>{{ _('Cash Sales:') }}</strong> (final - initial) + envelope</p>
                    <p><strong>{{ _('Total Sales:') }}</strong> cash + card methods</p>
                    <p><strong>{{ _('Net Earnings:') }}</strong> total - expenses</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-populate closed_time + live preview -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();

    // Set closed_time to current time
    const timeInput = document.getElementById('closed-time');
    if (timeInput && !timeInput.value) {
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
    }
});

document.querySelectorAll('input[type="text"]').forEach(input => {
    input.addEventListener('input', updatePreview);
});

function updatePreview() {
    const finalCash = parseInt(document.querySelector('[name="final_cash"]').value?.replace(/\D/g, '')) || 0;
    const initialCash = {{ session.initial_cash }};
    const envelope = parseInt(document.querySelector('[name="envelope_amount"]').value?.replace(/\D/g, '')) || 0;
    const creditCard = parseInt(document.querySelector('[name="credit_card_total"]').value?.replace(/\D/g, '')) || 0;
    const debitCard = parseInt(document.querySelector('[name="debit_card_total"]').value?.replace(/\D/g, '')) || 0;
    const bankTransfer = parseInt(document.querySelector('[name="bank_transfer_total"]').value?.replace(/\D/g, '')) || 0;
    const expenses = parseInt(document.querySelector('[name="expenses"]').value?.replace(/\D/g, '')) || 0;

    const cashSales = (finalCash - initialCash) + envelope;
    const totalSales = cashSales + creditCard + debitCard + bankTransfer;
    const netEarnings = totalSales - expenses;

    const formatterPY = new Intl.NumberFormat('es-PY', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });

    const preview = document.getElementById('preview');
    preview.innerHTML = `
        <div><span>{{ _('Cash Sales:') }}</span> <p class="font-bold">â‚² ${formatterPY.format(cashSales)}</p></div>
        <div><span>{{ _('Total Sales:') }}</span> <p class="font-bold">â‚² ${formatterPY.format(totalSales)}</p></div>
        <div><span>{{ _('Net Earnings:') }}</span> <p class="font-bold">â‚² ${formatterPY.format(netEarnings)}</p></div>
    `;
}

// Initial preview
updatePreview();
</script>
{% endblock %}