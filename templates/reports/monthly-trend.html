<!-- File: templates/reports/monthly-trend.html -->
{% extends "base.html" %}

{% block title %}{{ _('Monthly Revenue Trend') }} - CashPilot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-primary/10 rounded-lg">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-base-content">{{ _('Monthly Revenue Trend') }}</h1>
                    <p class="text-xs md:text-sm text-base-content/60 mt-0.5">{{ _('Compare daily revenue across months to identify peak/low days and month-over-month growth patterns') }}</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a id="switchToWeekly" href="#" class="btn btn-outline btn-sm gap-2 hidden">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                {{ _('View Weekly') }}
            </a>
            <a href="/reports" class="btn btn-outline btn-sm gap-2" data-back>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                {{ _('Back') }}
            </a>
        </div>
    </div>

    <!-- Controls Section -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-4">
        <!-- Business Selector (Most Important) -->
        <div class="mb-4">
            <label for="businessId" class="label py-1">
                <span class="label-text text-xs font-bold uppercase tracking-wider text-base-content/70">{{ _('Business') }}</span>
            </label>
            <select id="businessId" class="select select-bordered w-full focus:select-primary focus:ring-2 focus:ring-primary/20 transition-all" aria-label="{{ _('Select business to analyze') }}">
                <option value="">{{ _('Select Business') }}</option>
                {% for business in businesses %}
                <option value="{{ business.id }}">{{ business.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="divider my-3 text-xs text-base-content/50">{{ _('Select time period') }}</div>

        <!-- Selected Period Display -->
        <div id="selectedPeriodBanner" class="hidden mb-3 p-3 bg-info/10 border border-info/30 rounded-lg">
            <div class="flex items-center gap-2 text-sm">
                <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="font-medium text-info">{{ _('Viewing') }}:</span>
                <span id="selectedPeriodText" class="text-base-content font-semibold"></span>
            </div>
        </div>

        <!-- Quick Month Buttons -->
        <div class="flex flex-wrap gap-2 mb-4">
            <button class="btn btn-sm btn-outline quick-month-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="0" aria-label="{{ _('Show current month') }}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                {{ _('This Month') }}
            </button>
            <button class="btn btn-sm btn-outline quick-month-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="1" aria-label="{{ _('Show last month') }}">
                {{ _('Last Month') }}
            </button>
            <button class="btn btn-sm btn-outline quick-month-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="2" aria-label="{{ _('Show 2 months ago') }}">
                {{ _('2 Months Ago') }}
            </button>
            <button class="btn btn-sm btn-outline quick-month-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="3" aria-label="{{ _('Show 3 months ago') }}">
                {{ _('3 Months Ago') }}
            </button>
        </div>

        <!-- Custom Month Selector -->
        <details class="collapse collapse-arrow bg-base-200/50 rounded-lg border border-base-300">
            <summary class="collapse-title text-sm font-medium cursor-pointer hover:bg-base-200 transition-all">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>{{ _('Pick Custom Month') }}</span>
                </div>
            </summary>
            <div class="collapse-content pt-3">
                <div class="form-control">
                    <label for="reportMonth" class="label py-1">
                        <span class="label-text text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Select Month') }}</span>
                    </label>
                    <input type="month" id="reportMonth" class="input input-bordered w-full focus:input-primary focus:ring-2 focus:ring-primary/20 transition-all" aria-describedby="monthDisplay" />
                    <label class="label pt-2" id="month-display-container">
                        <span class="label-text-alt text-base-content/60" id="monthDisplay">{{ _('Select a month to view') }}</span>
                    </label>
                </div>
            </div>
        </details>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden">
        <div class="flex items-center justify-center py-12">
            <div class="text-center">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="text-base-content/60 mt-4">{{ _('Loading report data...') }}</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
        <div class="alert alert-error shadow-lg">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <h3 class="font-bold">{{ _('Error Loading Report') }}</h3>
                    <div class="text-sm" id="errorMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div id="reportContent" class="hidden space-y-6">
        <!-- Early Month Warning -->
        <div id="earlyMonthWarning" class="hidden alert alert-warning shadow-lg">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div>
                    <h3 class="font-bold text-sm">{{ _("Limited Data Available") }}</h3>
                    <div class="text-sm" id="earlyMonthWarningText"></div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="bg-gradient-to-br from-primary/5 to-base-100 border border-primary/20 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-2 text-sm text-base-content/70">
                <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ _('Line chart: current vs previous month (day-by-day). Bar chart: 6-month revenue trend.') }}</span>
            </div>
        </div>

        <div class="flex gap-4 overflow-x-auto pb-2">
            <!-- Highest Revenue Week -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Highest Revenue Week') }}</h3>
                </div>
                <p class="text-xl font-bold text-base-content truncate whitespace-nowrap" id="highestDay">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap" id="highestDayRevenue">-</p>
            </div>

            <!-- Lowest Revenue Week -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17L8 12m0 0l5-5m-5 5h12"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Lowest Revenue Week') }}</h3>
                </div>
                <p class="text-xl font-bold text-base-content truncate whitespace-nowrap" id="lowestDay">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap" id="lowestDayRevenue">-</p>
            </div>

            <!-- Month Total Sales -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Month Total') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums text-base-content truncate whitespace-nowrap" id="currentMonthTotal">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap">{{ _('Total sales this month') }}</p>
            </div>

            <!-- Month Cost -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Month Cost') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums text-base-content truncate whitespace-nowrap" id="currentMonthCost">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap" id="currentMonthCostShare">-</p>
            </div>

            <!-- Month Margin -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Month Margin') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums text-base-content truncate whitespace-nowrap" id="currentMonthMargin">-</p>
                <p class="text-sm font-mono tabular-nums text-base-content/60 mt-1 truncate whitespace-nowrap" id="currentMonthMarginPct">-</p>
            </div>

            <!-- Month-over-Month Growth -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Growth vs Previous') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums" id="monthGrowthPercent">-</p>
                <p class="text-sm font-mono tabular-nums text-base-content/60 mt-1 truncate whitespace-nowrap" id="monthGrowthDifference">-</p>
            </div>
        </div>

        <!-- Day Type Revenue Breakdown -->
        <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <h3 class="font-semibold text-base">{{ _('Revenue by Day Type') }}</h3>
                <span class="text-xs text-base-content/60 ml-2">{{ _('Thu/Fri = 25% discount days | Closed Sundays') }}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-3 bg-base-200/50 rounded-lg">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ _('Regular Days') }}</div>
                    <div class="text-xs text-base-content/50 mb-2">{{ _('Mon, Tue, Wed') }}</div>
                    <div class="text-2xl font-bold font-mono tabular-nums text-base-content" id="regularDaysRevenue">-</div>
                    <div class="text-xs text-base-content/60 mt-1" id="regularDaysMeta">-</div>
                </div>
                <div class="text-center p-3 bg-warning/10 rounded-lg border border-warning/30">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ _('Discount Days') }}</div>
                    <div class="text-xs text-base-content/50 mb-2">{{ _('Thu, Fri (-25%)') }}</div>
                    <div class="text-2xl font-bold font-mono tabular-nums text-warning" id="discountDaysRevenue">-</div>
                    <div class="text-xs text-base-content/60 mt-1" id="discountDaysMeta">-</div>
                </div>
                <div class="text-center p-3 bg-success/10 rounded-lg border border-success/30">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ _('Saturday') }}</div>
                    <div class="text-xs text-base-content/50 mb-2">{{ _('Weekend (full price)') }}</div>
                    <div class="text-2xl font-bold font-mono tabular-nums text-success" id="saturdayRevenue">-</div>
                    <div class="text-xs text-base-content/60 mt-1" id="saturdayMeta">-</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Running Total Progress Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">{{ _('Revenue Progress') }}</h2>
                    <div class="text-xs text-base-content/60">{{ _('Cumulative') }}</div>
                </div>
                <div class="relative" style="height: 280px;">
                    <canvas id="runningTotalChart"></canvas>
                </div>
            </div>

            <!-- Week-by-Week Comparison Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">{{ _('Week-by-Week Comparison') }}</h2>
                    <div class="text-xs text-base-content/60">{{ _('Current vs Previous') }}</div>
                </div>
                <div class="relative" style="height: 280px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Second Row: 3 Equal Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 6-Month Trend (Bar Chart) -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <h2 class="text-lg font-semibold mb-4">{{ _('6-Month Trend') }}</h2>
                <div class="relative" style="height: 280px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            
            <!-- Payment Methods Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <h2 class="text-lg font-semibold mb-4">{{ _('Payment Methods') }}</h2>
                <div class="relative" style="height: 280px;">
                    <canvas id="paymentMethodsChart"></canvas>
                </div>
            </div>

            <!-- Day Type Revenue Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <h2 class="text-lg font-semibold mb-4">{{ _('Revenue by Day Type') }}</h2>
                <div class="relative" style="height: 280px;">
                    <canvas id="dayTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Selected Month Details (Weekly View) -->
        <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">{{ _('Weekly Breakdown') }}</h2>
                <div class="text-sm" id="weekComparisonBadge"></div>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-sm table-zebra w-full">
                    <thead>
                        <tr>
                            <th>{{ _('Week') }}</th>
                            <th>{{ _('Date Range') }}</th>
                            <th class="text-right">{{ _('Revenue') }}</th>
                            <th class="text-right">{{ _('Cost') }}</th>
                            <th class="text-right">{{ _('Margin') }}</th>
                            <th class="text-right">{{ _('Margin %') }}</th>
                            <th class="text-right">{{ _('Growth') }}</th>
                            <th class="text-center">{{ _('Trend') }}</th>
                        </tr>
                    </thead>
                    <tbody id="currentMonthTable">
                        <!-- Populated by JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="font-semibold">
                            <td>{{ _('Total') }}</td>
                            <td>-</td>
                            <td class="text-right font-mono" id="monthTotalRevenue">-</td>
                            <td class="text-right font-mono" id="monthTotalCost">-</td>
                            <td class="text-right font-mono" id="monthTotalMargin">-</td>
                            <td class="text-right font-mono" id="monthTotalMarginPct">-</td>
                            <td class="text-right font-mono" id="monthTotalGrowth">-</td>
                            <td class="text-center" id="monthTotalTrend">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous" onerror="console.error('Failed to load Chart.js from CDN')"></script>
<script src="/static/js/currency-formatter.js"></script>

<script>
    // Wait for Chart.js to load before initializing
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load from CDN');
    }
    
    let trendChart = null;

    // Format currency values (Gs 2.500.000 - dot separator, no decimals)
    const formatCurrency = (value) => {
        const num = Math.round(parseFloat(value));
        return 'Gs ' + num.toLocaleString('es-PY').replace(/,/g, '.');
    };

    const formatCompactCurrency = (value) => {
        const num = Math.round(parseFloat(value));
        if (!Number.isFinite(num)) {
            return '-';
        }
        const abs = Math.abs(num);
        let formatted = null;
        if (abs >= 1_000_000_000) {
            formatted = (num / 1_000_000_000).toFixed(2).replace(/\.0+$/, '').replace(/(\.\d)0$/, '$1') + 'B';
        } else if (abs >= 1_000_000) {
            formatted = (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
        } else if (abs >= 1_000) {
            formatted = (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
        } else {
            formatted = num.toString();
        }
        return 'Gs ' + formatted;
    };

    const parseNumber = (value) => {
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
    };

    const getCostValue = (day) => {
        if (day.cost_total === null || day.cost_total === undefined) {
            return null;
        }
        return parseNumber(day.cost_total);
    };

    const getTicketValue = (day) => {
        if (day.ticket_count === null || day.ticket_count === undefined) {
            return null;
        }
        const parsed = parseInt(day.ticket_count, 10);
        return Number.isFinite(parsed) ? parsed : null;
    };

    const getMarginValue = (day) => {
        if (!day.has_data) {
            return null;
        }
        const revenue = parseNumber(day.revenue);
        const cost = getCostValue(day);
        if (revenue === null || cost === null) {
            return null;
        }
        return revenue - cost;
    };

    const getCostCoverage = (monthDays) => {
        const daysWithData = monthDays.filter(day => day.has_data);
        const daysWithCost = daysWithData.filter(day => getCostValue(day) !== null);
        return {
            daysWithData,
            daysWithCost,
            isComplete: daysWithData.length > 0 && daysWithCost.length === daysWithData.length,
        };
    };

    // Month names for display
    const monthNames = [
        '{{ _("January") }}', '{{ _("February") }}', '{{ _("March") }}', '{{ _("April") }}',
        '{{ _("May") }}', '{{ _("June") }}', '{{ _("July") }}', '{{ _("August") }}',
        '{{ _("September") }}', '{{ _("October") }}', '{{ _("November") }}', '{{ _("December") }}'
    ];

    const shortMonthNames = [
        '{{ _("Jan") }}', '{{ _("Feb") }}', '{{ _("Mar") }}', '{{ _("Apr") }}', '{{ _("May") }}', '{{ _("Jun") }}',
        '{{ _("Jul") }}', '{{ _("Aug") }}', '{{ _("Sep") }}', '{{ _("Oct") }}', '{{ _("Nov") }}', '{{ _("Dec") }}'
    ];

    const translateDayName = (dayName) => {
        const translations = {
            'Monday': '{{ _("Monday") }}',
            'Tuesday': '{{ _("Tuesday") }}',
            'Wednesday': '{{ _("Wednesday") }}',
            'Thursday': '{{ _("Thursday") }}',
            'Friday': '{{ _("Friday") }}',
            'Saturday': '{{ _("Saturday") }}',
            'Sunday': '{{ _("Sunday") }}'
        };
        return translations[dayName] || dayName;
    };

    function formatShortDate(dateStr) {
        if (!dateStr) {
            return '-';
        }
        const parts = String(dateStr).split('-');
        if (parts.length !== 3) {
            return dateStr;
        }
        const day = parseInt(parts[2], 10);
        const monthIndex = parseInt(parts[1], 10) - 1;
        if (!Number.isFinite(day) || monthIndex < 0 || monthIndex >= shortMonthNames.length) {
            return dateStr;
        }
        return `${day} ${shortMonthNames[monthIndex]}`;
    }

    function getISOWeek(dateStr) {
        const parts = dateStr.split('-');
        const d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return { year: d.getFullYear(), week: weekNo };
    }

    // Initialize month picker with current month
    function initializeMonthPickers() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const monthStr = `${year}-${month}`;
        document.getElementById('reportMonth').value = monthStr;
        updateMonthDisplay();
    }

    // Update month display
    function updateMonthDisplay() {
        const monthInput = document.getElementById('reportMonth');
        const monthDisplay = document.getElementById('monthDisplay');
        
        if (monthInput.value) {
            const [year, month] = monthInput.value.split('-');
            const monthName = monthNames[parseInt(month) - 1];
            monthDisplay.textContent = `${monthName} ${year}`;
        } else {
            monthDisplay.textContent = '{{ _("Select a month to view") }}';
        }
        updateSwitchToWeeklyLink();
    }

    function updateSwitchToWeeklyLink() {
        const switchLink = document.getElementById('switchToWeekly');
        if (!switchLink) {
            return;
        }
        const businessId = document.getElementById('businessId').value;
        const monthValue = document.getElementById('reportMonth').value;
        if (!businessId || !monthValue) {
            switchLink.classList.add('hidden');
            switchLink.setAttribute('href', '#');
            return;
        }
        const parts = monthValue.split('-');
        if (parts.length !== 2) {
            switchLink.classList.add('hidden');
            switchLink.setAttribute('href', '#');
            return;
        }
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        if (!Number.isFinite(year) || !Number.isFinite(month)) {
            switchLink.classList.add('hidden');
            switchLink.setAttribute('href', '#');
            return;
        }
        const monthStr = String(month).padStart(2, '0');
        const { year: isoYear, week } = getISOWeek(`${year}-${monthStr}-01`);
        switchLink.href = `/reports/weekly-trend?year=${isoYear}&week=${week}&business_id=${businessId}`;
        switchLink.classList.remove('hidden');
    }

    // Month change handler
    document.getElementById('reportMonth').addEventListener('change', () => {
        updateMonthDisplay();
        if (document.getElementById('businessId').value) {
            generateReport();
        }
    });

    // Business change handler - auto-generate
    document.getElementById('businessId').addEventListener('change', () => {
        updateSwitchToWeeklyLink();
        if (document.getElementById('businessId').value) {
            generateReport();
        }
    });

    // Quick month button handlers
    document.querySelectorAll('.quick-month-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.quick-month-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline');
            });
            
            // Add active class to clicked button
            btn.classList.remove('btn-outline');
            btn.classList.add('btn-primary');
            
            const offset = parseInt(btn.dataset.offset);
            const today = new Date();
            const targetDate = new Date(today.getFullYear(), today.getMonth() - offset, 1);
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const monthStr = `${year}-${month}`;
            document.getElementById('reportMonth').value = monthStr;
            updateMonthDisplay();
            
            // Auto-generate if business is selected
            if (document.getElementById('businessId').value) {
                generateReport();
            }
        });
    });

    async function generateReport() {
        const businessId = document.getElementById('businessId').value;
        const monthStr = document.getElementById('reportMonth').value;

        if (!businessId) {
            showError('{{ _("Please select a business") }}');
            return;
        }

        if (!monthStr) {
            showError('{{ _("Please select a month") }}');
            return;
        }

        // Parse year and month from input
        const [year, month] = monthStr.split('-').map(num => parseInt(num, 10));

        // Update URL with parameters
        const newUrl = `${window.location.pathname}?year=${year}&month=${month}&business_id=${businessId}`;
        window.history.pushState({year, month, businessId}, '', newUrl);

        // Show loading state
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('errorState').classList.add('hidden');
        document.getElementById('reportContent').classList.add('hidden');

        try {
            const response = await fetch(
                `/reports/monthly-trend/data?year=${year}&month=${month}&business_id=${businessId}`,
                {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                    },
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to load report');
            }

            const data = await response.json();
            displayReport(data, year, month);
        } catch (error) {
            console.error('Error loading report:', error);
            showError(error.message);
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
        }
    }

    function displayReport(data, year, month) {
        // Update selected period banner
        const monthName = monthNames[month - 1];
        document.getElementById('selectedPeriodText').textContent = `${monthName} ${year}`;
        document.getElementById('selectedPeriodBanner').classList.remove('hidden');

        const groupWeeksForSummary = (days) => {
            const weeks = [];
            let currentWeek = [];
            days.forEach((day) => {
                const dayDate = new Date(`${day.date}T00:00:00`);
                let dayOfWeek = dayDate.getDay();
                if (dayOfWeek === 0) dayOfWeek = 7;
                if (dayOfWeek === 1 && currentWeek.length > 0) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentWeek.push(day);
            });
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            return weeks;
        };

        const daysWithData = data.current_month.filter(d => d.has_data).length;
        const monthTotalValue = parseNumber(data.current_month_total) || 0;
        const summaryWeeks = groupWeeksForSummary(data.current_month);

        // Display summary cards
        const highestDayEl = document.getElementById('highestDay');
        const lowestDayEl = document.getElementById('lowestDay');

        const weeksWithData = summaryWeeks
            .map((week, index) => {
                const weekTotal = week.reduce(
                    (sum, day) => sum + (day.has_data ? parseNumber(day.revenue) : 0),
                    0
                );
                const hasData = week.some(day => day.has_data);
                if (!hasData) {
                    return null;
                }
                const startDate = new Date(`${week[0].date}T00:00:00`);
                const endDate = new Date(`${week[week.length - 1].date}T00:00:00`);
                const label = `${startDate.getDate()}-${endDate.getDate()} ${shortMonthNames[startDate.getMonth()]}`;
                return { index, weekTotal, label };
            })
            .filter(Boolean);

        if (weeksWithData.length > 0) {
            const highestWeek = weeksWithData.reduce((max, item) =>
                item.weekTotal > max.weekTotal ? item : max
            );
            const lowestWeek = weeksWithData.reduce((min, item) =>
                item.weekTotal < min.weekTotal ? item : min
            );
            const highestShare = monthTotalValue > 0 ? (highestWeek.weekTotal / monthTotalValue) * 100 : null;
            const lowestShare = monthTotalValue > 0 ? (lowestWeek.weekTotal / monthTotalValue) * 100 : null;
            const highestShareText = highestShare !== null ? ` · ${highestShare.toFixed(1)}%` : '';
            const lowestShareText = lowestShare !== null ? ` · ${lowestShare.toFixed(1)}%` : '';

            highestDayEl.textContent = highestWeek.label;
            document.getElementById('highestDayRevenue').textContent = `${formatCompactCurrency(highestWeek.weekTotal)}${highestShareText}`;

            lowestDayEl.textContent = lowestWeek.label;
            document.getElementById('lowestDayRevenue').textContent = `${formatCompactCurrency(lowestWeek.weekTotal)}${lowestShareText}`;
        } else {
            highestDayEl.textContent = '-';
            document.getElementById('highestDayRevenue').textContent = '-';
            lowestDayEl.textContent = '-';
            document.getElementById('lowestDayRevenue').textContent = '-';
        }
        
        // Calculate day-type revenue breakdown
        let regularDaysRev = 0; // Mon, Tue, Wed
        let discountDaysRev = 0; // Thu, Fri (25% discount)
        let saturdayRev = 0; // Sat
        let regularDaysCost = 0;
        let discountDaysCost = 0;
        let saturdayCost = 0;
        let regularCostComplete = true;
        let discountCostComplete = true;
        let saturdayCostComplete = true;
        let regularTickets = 0;
        let discountTickets = 0;
        let saturdayTickets = 0;

        data.current_month.forEach(day => {
            if (!day.has_data) return;
            const dayDate = new Date(day.date + 'T00:00:00');
            const dayOfWeek = dayDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            const revenue = parseFloat(day.revenue);
            const costValue = getCostValue(day);
            const ticketValue = getTicketValue(day);
            
            if (dayOfWeek >= 1 && dayOfWeek <= 3) { // Mon, Tue, Wed
                regularDaysRev += revenue;
                if (costValue === null) {
                    regularCostComplete = false;
                } else {
                    regularDaysCost += costValue;
                }
                if (ticketValue !== null) {
                    regularTickets += ticketValue;
                }
            } else if (dayOfWeek === 4 || dayOfWeek === 5) { // Thu, Fri
                discountDaysRev += revenue;
                if (costValue === null) {
                    discountCostComplete = false;
                } else {
                    discountDaysCost += costValue;
                }
                if (ticketValue !== null) {
                    discountTickets += ticketValue;
                }
            } else if (dayOfWeek === 6) { // Sat
                saturdayRev += revenue;
                if (costValue === null) {
                    saturdayCostComplete = false;
                } else {
                    saturdayCost += costValue;
                }
                if (ticketValue !== null) {
                    saturdayTickets += ticketValue;
                }
            }
            // Sunday (0) is excluded - closed
        });
        
        const totalRev = regularDaysRev + discountDaysRev + saturdayRev;
        
        const buildMetaLine = (revenue, cost, costComplete, tickets) => {
            const percentText = totalRev > 0 ? `${((revenue / totalRev) * 100).toFixed(1)}% {{ _("of total") }}` : '-';
            const marginText = costComplete ? formatCurrency(revenue - cost) : '-';
            const ticketsText = tickets > 0 ? tickets.toLocaleString('es-PY') : '-';
            return `${percentText} · {{ _("Margin") }}: ${marginText} · {{ _("Tickets") }}: ${ticketsText}`;
        };

        document.getElementById('regularDaysRevenue').textContent = formatCurrency(regularDaysRev);
        document.getElementById('regularDaysMeta').textContent = buildMetaLine(
            regularDaysRev,
            regularDaysCost,
            regularCostComplete,
            regularTickets
        );
        
        document.getElementById('discountDaysRevenue').textContent = formatCurrency(discountDaysRev);
        document.getElementById('discountDaysMeta').textContent = buildMetaLine(
            discountDaysRev,
            discountDaysCost,
            discountCostComplete,
            discountTickets
        );
        
        document.getElementById('saturdayRevenue').textContent = formatCurrency(saturdayRev);
        document.getElementById('saturdayMeta').textContent = buildMetaLine(
            saturdayRev,
            saturdayCost,
            saturdayCostComplete,
            saturdayTickets
        );
        
        // Show early month warning if less than 7 days of data
        const earlyMonthWarning = document.getElementById('earlyMonthWarning');
        if (daysWithData < 7) {
            const warningText = document.getElementById('earlyMonthWarningText');
            warningText.textContent = `{{ _("Only") }} ${daysWithData} {{ _("days of data available. Monthly trends are more reliable after at least 7 days.") }}`;
            earlyMonthWarning.classList.remove('hidden');
        } else {
            earlyMonthWarning.classList.add('hidden');
        }
        
        const currentMonthTotalEl = document.getElementById('currentMonthTotal');
        const monthCostEl = document.getElementById('currentMonthCost');
        const monthCostShareEl = document.getElementById('currentMonthCostShare');
        const marginTotalEl = document.getElementById('currentMonthMargin');
        const marginPctEl = document.getElementById('currentMonthMarginPct');
        const growthPercentEl = document.getElementById('monthGrowthPercent');
        const growthDiffEl = document.getElementById('monthGrowthDifference');
        const costCoverage = getCostCoverage(data.current_month);
        const valueClass = 'text-xl md:text-2xl font-bold font-mono tabular-nums truncate whitespace-nowrap';
        const subClass = 'text-sm font-mono tabular-nums mt-1 truncate whitespace-nowrap';

        currentMonthTotalEl.textContent = formatCompactCurrency(data.current_month_total);

        if (costCoverage.daysWithData.length === 0) {
            monthCostEl.textContent = '-';
            monthCostEl.className = `${valueClass} text-base-content/60`;
            monthCostShareEl.textContent = '{{ _("No data") }}';
            monthCostShareEl.className = 'text-sm text-base-content/60 mt-1 truncate whitespace-nowrap';

            marginTotalEl.textContent = '-';
            marginTotalEl.className = `${valueClass} text-base-content/60`;
            marginPctEl.textContent = '{{ _("No data") }}';
            marginPctEl.className = `${subClass} text-base-content/60`;
        } else if (costCoverage.daysWithCost.length === 0) {
            monthCostEl.textContent = '-';
            monthCostEl.className = `${valueClass} text-base-content/60`;
            monthCostShareEl.textContent = '{{ _("Cost data missing") }}';
            monthCostShareEl.className = 'text-sm text-warning/80 mt-1 truncate whitespace-nowrap';

            marginTotalEl.textContent = '-';
            marginTotalEl.className = `${valueClass} text-base-content/60`;
            marginPctEl.textContent = '{{ _("Cost data missing") }}';
            marginPctEl.className = `${subClass} text-warning/80`;
        } else {
            const revenueWithCost = costCoverage.daysWithCost.reduce(
                (sum, day) => sum + parseNumber(day.revenue),
                0
            );
            const costTotal = costCoverage.daysWithCost.reduce(
                (sum, day) => sum + getCostValue(day),
                0
            );
            const marginTotal = revenueWithCost - costTotal;
            const marginPct = revenueWithCost > 0 ? (marginTotal / revenueWithCost) * 100 : null;
            const costRatio = revenueWithCost > 0 ? (costTotal / revenueWithCost) * 100 : null;
            const marginColor = marginTotal > 0 ? 'text-success' : marginTotal < 0 ? 'text-error' : 'text-base-content/60';

            monthCostEl.textContent = formatCompactCurrency(costTotal);
            monthCostEl.className = `${valueClass} text-base-content`;
            marginTotalEl.textContent = formatCompactCurrency(marginTotal);
            marginTotalEl.className = `${valueClass} ${marginColor}`;

            const marginPctText = marginPct !== null ? `${marginPct > 0 ? '+' : ''}${marginPct.toFixed(1)}%` : '-';

            if (costCoverage.isComplete) {
                marginPctEl.textContent = `${marginPctText} · {{ _("Cost data complete") }}`;
                marginPctEl.className = `${subClass} ${marginColor}`;
                monthCostShareEl.textContent = costRatio !== null
                    ? `${costRatio.toFixed(1)}% {{ _("of sales") }}`
                    : '-';
                monthCostShareEl.className = 'text-sm text-base-content/60 mt-1 truncate whitespace-nowrap';
            } else {
                marginPctEl.textContent = `${marginPctText} · {{ _("Cost data incomplete") }} (${costCoverage.daysWithCost.length}/${costCoverage.daysWithData.length})`;
                marginPctEl.className = `${subClass} text-warning/80`;
                monthCostShareEl.textContent = '{{ _("Cost data incomplete") }}';
                monthCostShareEl.className = 'text-sm text-warning/80 mt-1 truncate whitespace-nowrap';
            }
        }

        if (data.month_over_month_growth !== null && data.month_over_month_growth !== undefined) {
            const growth = parseFloat(data.month_over_month_growth);
            const isPositive = growth > 0;
            const isNegative = growth < 0;
            const colorClass = isPositive ? 'text-success' : isNegative ? 'text-error' : 'text-base-content/60';
            const arrow = isPositive ? '↑' : isNegative ? '↓' : '→';

            growthPercentEl.className = `text-xl md:text-2xl font-bold font-mono tabular-nums ${colorClass}`;
            growthPercentEl.textContent = `${arrow} ${growth > 0 ? '+' : ''}${growth}%`;

            const diff = parseFloat(data.month_over_month_difference);
            const diffText = diff > 0 ? `+${formatCompactCurrency(Math.abs(diff))}` :
                            diff < 0 ? `-${formatCompactCurrency(Math.abs(diff))}` :
                            formatCompactCurrency(0);
            growthDiffEl.className = `text-sm font-mono tabular-nums mt-1 ${colorClass}`;
            growthDiffEl.textContent = diffText;
        } else {
            growthPercentEl.className = 'text-xl md:text-2xl font-bold text-base-content/60';
            growthPercentEl.textContent = '-';
            growthDiffEl.textContent = '{{ _("No previous data") }}';
        }

        // Display current month table - grouped by calendar weeks (Mon-Sun)
        const tableBody = document.getElementById('currentMonthTable');
        tableBody.innerHTML = '';
        
        // Group days into proper calendar weeks (Monday = start)
        const weeks = [];
        let currentWeek = [];
        
        data.current_month.forEach((day) => {
            const dayDate = new Date(day.date + 'T00:00:00');
            let dayOfWeek = dayDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Convert Sunday (0) to 7 so Monday becomes 1
            if (dayOfWeek === 0) dayOfWeek = 7;
            
            // If this is Monday and we have data in current week, start new week
            if (dayOfWeek === 1 && currentWeek.length > 0) {
                weeks.push(currentWeek);
                currentWeek = [];
            }
            
            currentWeek.push(day);
        });
        
        // Push the last week
        if (currentWeek.length > 0) {
            weeks.push(currentWeek);
        }
        
        // Get previous month weeks for comparison
        const previousMonthWeeks = [];
        if (data.previous_months && data.previous_months.length > 0) {
            const prevMonth = data.previous_months[data.previous_months.length - 1];
            let prevWeek = [];
            prevMonth.forEach((day) => {
                const dayDate = new Date(day.date + 'T00:00:00');
                let dayOfWeek = dayDate.getDay();
                if (dayOfWeek === 0) dayOfWeek = 7;
                
                if (dayOfWeek === 1 && prevWeek.length > 0) {
                    previousMonthWeeks.push(prevWeek);
                    prevWeek = [];
                }
                prevWeek.push(day);
            });
            if (prevWeek.length > 0) {
                previousMonthWeeks.push(prevWeek);
            }
        }
        
        // Display each week
        weeks.forEach((week, weekIndex) => {
            const row = document.createElement('tr');
            
            // Calculate week totals
            const weekRevenue = week.reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0);
            const weekCostCoverage = getCostCoverage(week);
            const weekCost = weekCostCoverage.isComplete
                ? weekCostCoverage.daysWithCost.reduce((sum, day) => sum + getCostValue(day), 0)
                : null;
            const weekMargin = weekCost !== null ? weekRevenue - weekCost : null;
            const weekMarginPct = weekMargin !== null && weekRevenue > 0
                ? (weekMargin / weekRevenue) * 100
                : null;
            
            // Calculate week-over-week growth (compare to same week in previous month)
            let weekGrowth = null;
            let hasGrowthData = false;
            
            if (previousMonthWeeks[weekIndex]) {
                const prevWeekRevenue = previousMonthWeeks[weekIndex].reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0);
                if (prevWeekRevenue > 0) {
                    weekGrowth = ((weekRevenue - prevWeekRevenue) / prevWeekRevenue * 100);
                    hasGrowthData = true;
                }
            }
            
            const growthClass = hasGrowthData && weekGrowth > 0 ? 'text-success' : 
                               hasGrowthData && weekGrowth < 0 ? 'text-error' : 
                               'text-base-content/60';
            
            const growthText = hasGrowthData ? 
                `${weekGrowth > 0 ? '+' : ''}${weekGrowth.toFixed(1)}%` : 
                '-';
            
            const trendArrow = hasGrowthData ? (weekGrowth > 0 ? '↑' : weekGrowth < 0 ? '↓' : '→') : '→';
            
            // Week number cell
            const weekCell = document.createElement('td');
            weekCell.className = 'font-medium';
            weekCell.textContent = `{{ _("Week") }} ${weekIndex + 1}`;
            row.appendChild(weekCell);
            
            // Date range cell
            const startDate = week[0].date;
            const endDate = week[week.length - 1].date;
            const dateRangeCell = document.createElement('td');
            dateRangeCell.textContent = `${startDate} - ${endDate}`;
            row.appendChild(dateRangeCell);
            
            // Revenue cell
            const revenueCell = document.createElement('td');
            revenueCell.className = 'text-right font-mono';
            revenueCell.textContent = formatCurrency(weekRevenue);
            row.appendChild(revenueCell);

            // Cost cell
            const costCell = document.createElement('td');
            costCell.className = `text-right ${weekCost !== null ? 'font-mono' : 'text-base-content/40'}`;
            costCell.textContent = weekCost !== null ? formatCurrency(weekCost) : '-';
            row.appendChild(costCell);

            // Margin cell
            const marginCell = document.createElement('td');
            const marginColor = weekMargin > 0 ? 'text-success' : weekMargin < 0 ? 'text-error' : 'text-base-content/60';
            marginCell.className = `text-right font-mono ${weekMargin !== null ? marginColor : 'text-base-content/40'}`;
            marginCell.textContent = weekMargin !== null ? formatCurrency(weekMargin) : '-';
            row.appendChild(marginCell);

            // Margin percent cell
            const marginPctCell = document.createElement('td');
            marginPctCell.className = `text-right font-mono ${weekMarginPct !== null ? marginColor : 'text-base-content/40'}`;
            marginPctCell.textContent = weekMarginPct !== null
                ? `${weekMarginPct > 0 ? '+' : ''}${weekMarginPct.toFixed(1)}%`
                : '-';
            row.appendChild(marginPctCell);
            
            // Growth percent cell
            const growthCell = document.createElement('td');
            growthCell.className = `text-right font-mono ${growthClass}`;
            growthCell.textContent = growthText;
            row.appendChild(growthCell);
            
            // Trend arrow cell
            const trendCell = document.createElement('td');
            trendCell.className = 'text-center text-lg';
            trendCell.textContent = trendArrow;
            row.appendChild(trendCell);
            
            tableBody.appendChild(row);
        });

        const totalRevenue = data.current_month.reduce(
            (sum, day) => sum + (day.has_data ? parseNumber(day.revenue) : 0),
            0
        );
        const totalCost = costCoverage.isComplete
            ? costCoverage.daysWithCost.reduce((sum, day) => sum + getCostValue(day), 0)
            : null;
        const totalMargin = totalCost !== null ? totalRevenue - totalCost : null;
        const totalMarginPct = totalMargin !== null && totalRevenue > 0
            ? (totalMargin / totalRevenue) * 100
            : null;

        document.getElementById('monthTotalRevenue').textContent = totalRevenue > 0 ? formatCurrency(totalRevenue) : '-';
        document.getElementById('monthTotalCost').textContent = totalCost !== null ? formatCurrency(totalCost) : '-';
        document.getElementById('monthTotalMargin').textContent = totalMargin !== null ? formatCurrency(totalMargin) : '-';
        document.getElementById('monthTotalMarginPct').textContent = totalMarginPct !== null
            ? `${totalMarginPct > 0 ? '+' : ''}${totalMarginPct.toFixed(1)}%`
            : '-';
        const monthGrowthValue = parseNumber(data.month_over_month_growth);
        document.getElementById('monthTotalGrowth').textContent = monthGrowthValue !== null
            ? `${monthGrowthValue > 0 ? '+' : ''}${monthGrowthValue}%`
            : '-';
        const monthTrendArrow = monthGrowthValue > 0 ? '↑' : monthGrowthValue < 0 ? '↓' : '→';
        document.getElementById('monthTotalTrend').textContent = monthGrowthValue !== null
            ? monthTrendArrow
            : '-';
        
        // Add first week vs last week comparison
        if (weeks.length >= 2) {
            const firstWeekRev = weeks[0].reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0);
            const lastWeekRev = weeks[weeks.length - 1].reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0);
            
            if (firstWeekRev > 0) {
                const weekDiff = ((lastWeekRev - firstWeekRev) / firstWeekRev * 100).toFixed(1);
                const badge = document.getElementById('weekComparisonBadge');
                
                if (weekDiff > 5) {
                    badge.innerHTML = `<span class="badge badge-success gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>{{ _("Strong finish") }} +${weekDiff}%</span>`;
                } else if (weekDiff < -5) {
                    badge.innerHTML = `<span class="badge badge-error gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17L8 12m0 0l5-5m-5 5h12"/></svg>{{ _("Fade detected") }} ${weekDiff}%</span>`;
                } else {
                    badge.innerHTML = `<span class="badge badge-ghost gap-1">{{ _("Consistent") }} ${weekDiff > 0 ? '+' : ''}${weekDiff}%</span>`;
                }
            }
        }

        // Create chart
        createChart(data, year, month);

        // Show report content
        document.getElementById('reportContent').classList.remove('hidden');
    }

    let comparisonChart = null;
    let runningTotalChart = null;
    let paymentMethodsChart = null;
    let dayTypeChart = null;
    function createChart(data, year, month) {
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded. Cannot create charts.');
            showError('Chart library failed to load. Please refresh the page.');
            return;
        }

        const groupWeeks = (days) => {
            const weeks = [];
            let currentWeek = [];
            days.forEach((day) => {
                const dayDate = new Date(`${day.date}T00:00:00`);
                let dayOfWeek = dayDate.getDay();
                if (dayOfWeek === 0) dayOfWeek = 7;
                if (dayOfWeek === 1 && currentWeek.length > 0) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentWeek.push(day);
            });
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            return weeks;
        };

        const currentWeeks = groupWeeks(data.current_month);
        const previousWeeks = data.previous_months && data.previous_months.length > 0
            ? groupWeeks(data.previous_months[data.previous_months.length - 1])
            : [];
        const weeklyLabels = currentWeeks.map((week) => {
            if (!week || week.length === 0) {
                return '-';
            }
            const startDate = new Date(`${week[0].date}T00:00:00`);
            const endDate = new Date(`${week[week.length - 1].date}T00:00:00`);
            const startDay = startDate.getDate();
            const endDay = endDate.getDate();
            const monthLabel = shortMonthNames[startDate.getMonth()];
            return `${startDay}-${endDay} ${monthLabel}`;
        });
        const currentWeekTotals = currentWeeks.map(
            (week) => week.reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0)
        );
        const previousWeekTotals = previousWeeks.map(
            (week) => week.reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0)
        );
        
        // Chart 1: Running Total Progress (Cumulative)
        const runningTotalCtx = document.getElementById('runningTotalChart');
        
        if (runningTotalChart) {
            runningTotalChart.destroy();
        }

        // Generate labels and cumulative data
        const labels = weeklyLabels;
        const currentCumulative = [];
        const previousCumulative = [];

        let currentSum = 0;
        currentWeekTotals.forEach((weekTotal) => {
            currentSum += weekTotal;
            currentCumulative.push(currentSum);
        });

        let prevSum = 0;
        if (previousWeekTotals.length > 0) {
            previousWeekTotals.forEach((weekTotal) => {
                prevSum += weekTotal;
                previousCumulative.push(prevSum);
            });
        }
        
        // Build datasets
        const datasets = [];
        
        if (previousWeekTotals.length > 0 && previousCumulative.length > 0) {
            datasets.push({
                label: '{{ _("Last Month") }}',
                data: previousCumulative,
                borderColor: 'rgb(156, 163, 175)',
                backgroundColor: 'rgba(156, 163, 175, 0.05)',
                borderWidth: 2,
                tension: 0.2,
                pointRadius: 2,
                pointHoverRadius: 4,
                borderDash: [5, 5],
                fill: false,
            });
        }
        
        datasets.push({
            label: '{{ _("This Month") }}',
            data: currentCumulative,
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            tension: 0.2,
            pointRadius: 3,
            pointHoverRadius: 5,
            fill: true,
        });
        
        runningTotalChart = new Chart(runningTotalCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            },
                            title: function(context) {
                                return `{{ _("Through week") }} ${context[0].label}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '{{ _("Week of Month") }}'
                        }
                    }
                }
            }
        });
        
        // Chart 2: Day-by-Day Comparison (Current vs Previous month)
        const comparisonCtx = document.getElementById('comparisonChart');
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }

        // Generate labels (weekly)
        const dailyLabels = weeklyLabels;
        
        // Build datasets array for daily comparison
        const dailyDatasets = [];
        
        if (previousWeekTotals.length > 0) {
            dailyDatasets.push({
                label: '{{ _("Last Month") }}',
                data: previousWeekTotals,
                borderColor: 'rgb(156, 163, 175)', // Gray
                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                spanGaps: true,
                borderDash: [5, 5], // Dashed line
            });
        }
        
        dailyDatasets.push({
            label: '{{ _("This Month") }}',
            data: currentWeekTotals,
            borderColor: 'rgb(99, 102, 241)', // Primary blue
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            spanGaps: true,
            fill: true,
        });
        
        comparisonChart = new Chart(comparisonCtx, {
            type: 'line',
            data: {
                labels: dailyLabels,
                datasets: dailyDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });

        // Chart 3: Payment Methods Donut
        const paymentMethodsCtx = document.getElementById('paymentMethodsChart');
        
        if (paymentMethodsChart) {
            paymentMethodsChart.destroy();
        }
        
        // Use payment method totals from API
        const cashTotal = parseFloat(data.current_month_cash_total || 0);
        const cardTotal = parseFloat(data.current_month_card_total || 0);
        const bankTransferTotal = parseFloat(data.current_month_bank_transfer_total || 0);
        const creditTotal = parseFloat(data.current_month_credit_total || 0);
        
        paymentMethodsChart = new Chart(paymentMethodsCtx, {
            type: 'doughnut',
            data: {
                labels: ['{{ _("Cash") }}', '{{ _("Card") }}', '{{ _("Bank Transfer") }}', '{{ _("Credit Sales") }}'],
                datasets: [{
                    data: [cashTotal, cardTotal, bankTransferTotal, creditTotal],
                    backgroundColor: [
                        'rgb(34, 197, 94)',   // Green for cash
                        'rgb(59, 130, 246)',  // Blue for card
                        'rgb(168, 85, 247)',  // Purple for bank transfer
                        'rgb(249, 115, 22)'   // Orange for credit
                    ],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 255, 255)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Chart 4: Day Type Revenue Donut
        const dayTypeCtx = document.getElementById('dayTypeChart');
        
        if (dayTypeChart) {
            dayTypeChart.destroy();
        }
        
        // Calculate day type revenue
        let regularDaysRev = 0;
        let discountDaysRev = 0;
        let saturdayRev = 0;
        
        data.current_month.forEach(day => {
            if (!day.has_data) return;
            const dayDate = new Date(day.date + 'T00:00:00');
            const dayOfWeek = dayDate.getDay();
            const revenue = parseFloat(day.revenue);
            
            if (dayOfWeek >= 1 && dayOfWeek <= 3) {
                regularDaysRev += revenue;
            } else if (dayOfWeek === 4 || dayOfWeek === 5) {
                discountDaysRev += revenue;
            } else if (dayOfWeek === 6) {
                saturdayRev += revenue;
            }
        });
        
        dayTypeChart = new Chart(dayTypeCtx, {
            type: 'doughnut',
            data: {
                labels: ['{{ _("Regular Days") }}', '{{ _("Discount Days") }}', '{{ _("Saturday") }}'],
                datasets: [{
                    data: [regularDaysRev, discountDaysRev, saturdayRev],
                    backgroundColor: [
                        'rgb(99, 102, 241)',  // Primary for regular
                        'rgb(245, 158, 11)',  // Warning/yellow for discount
                        'rgb(34, 197, 94)'    // Success/green for Saturday
                    ],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 255, 255)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Chart 6: 6-Month Trend (Bar chart showing monthly totals)
        const trendCtx = document.getElementById('trendChart');
        
        if (trendChart) {
            trendChart.destroy();
        }

        const monthLabels = [];
        const monthTotals = [];
        const monthColors = [];
        
        // Previous 5 months
        data.previous_months.forEach((monthData, index) => {
            const monthTotal = monthData.reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0);
            // Calculate month from current - need to figure out which month this is
            const monthOffset = data.previous_months.length - index;
            let targetMonth = month - monthOffset;
            let targetYear = year;
            while (targetMonth < 1) {
                targetMonth += 12;
                targetYear -= 1;
            }
            monthLabels.push(monthNames[targetMonth - 1].substring(0, 3));
            monthTotals.push(monthTotal);
            monthColors.push('rgba(156, 163, 175, 0.6)'); // Gray
        });
        
        // Current month
        const currentTotal = data.current_month.reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0);
        monthLabels.push('{{ _("Current") }}');
        monthTotals.push(currentTotal);
        monthColors.push('rgb(99, 102, 241)'); // Primary blue

        trendChart = new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: '{{ _("Monthly Total") }}',
                    data: monthTotals,
                    backgroundColor: monthColors,
                    borderColor: monthColors.map(c => c.replace('0.6', '1').replace('rgb', 'rgb')),
                    borderWidth: 2,
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorState').classList.remove('hidden');
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('reportContent').classList.add('hidden');
    }

    // Initialize on load
    initializeMonthPickers();
    
    // Auto-click "This Month" button on page load
    document.addEventListener('DOMContentLoaded', () => {
        const thisMonthBtn = document.querySelector('.quick-month-btn[data-offset="0"]');
        if (thisMonthBtn) {
            thisMonthBtn.classList.remove('btn-outline');
            thisMonthBtn.classList.add('btn-primary');
        }
    });
</script>
{% endblock %}
