<!-- File: templates/reports/business-stats.html -->
{% extends "reports/base.html" %}

{% block report_title %}{{ _('Business Statistics') }}{% endblock %}

{% block report_header %}{{ _('Business Statistics') }}{% endblock %}
{% block report_description %}{{ _('Multi-business statistics dashboard with daily metrics comparison') }}{% endblock %}

{% block report_content %}
<div class="space-y-4">
    <!-- Period Comparison Label & Hero Box Combined -->
    <div class="bg-gradient-to-br from-primary/10 to-base-100 border-2 border-primary/30 rounded-xl shadow-lg p-4 transition-all duration-200">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="px-2.5 py-1 bg-primary/20 rounded-md text-primary font-semibold text-xs uppercase tracking-wider">{{ _('Current') }}</span>
                <span class="text-sm font-bold text-base-content">{{ current_period_label }}</span>
                <span class="text-base-content/40">vs</span>
                <span class="px-2.5 py-1 bg-base-200 rounded-md text-base-content/70 font-semibold text-xs uppercase tracking-wider">{{ _('Previous') }}</span>
                <span class="text-sm font-bold text-base-content/70">{{ previous_period_label }}</span>
            </div>
            <div class="text-xs text-base-content/60 uppercase tracking-wider">{{ _('Cash') }} + {{ _('Cards') }} + {{ _('Credit Sales') }}</div>
        </div>
        <div class="text-xs text-base-content/60 uppercase tracking-wider mb-2">
            {{ comparison_label }}
        </div>
        <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-3">
            <div class="flex items-baseline gap-3">
                <h2 class="text-xs font-bold uppercase tracking-widest text-base-content/70">{{ _('Total Sales') }}</h2>
                <p class="stat-amount stat-amount--hero text-3xl font-bold font-mono text-primary tabular-nums" data-fit-amount="true" data-min-size="18">
                    Gs {{ totals_current.total_sales | format_currency_py }}
                </p>
                {% if totals_deltas.total_sales.direction == 'up' %}
                    <span class="text-success text-sm font-medium">↑ +{{ totals_deltas.total_sales.percent }}%</span>
                {% elif totals_deltas.total_sales.direction == 'down' %}
                    <span class="text-error text-sm font-medium">↓ {{ totals_deltas.total_sales.percent }}%</span>
                {% elif totals_deltas.total_sales.percent == 0 and totals_current.total_sales == 0 %}
                    <span class="text-base-content/40 text-xs italic">{{ _('No data') }}</span>
                {% else %}
                    <span class="text-base-content/50 text-sm">± {{ totals_deltas.total_sales.percent }}%</span>
                {% endif %}
            </div>
            <div class="text-xs text-base-content/50">
                {{ _('Previous') }}: <span class="font-mono tabular-nums">Gs {{ totals_previous.total_sales | format_currency_py }}</span>
            </div>
        </div>
    </div>

    <!-- Date Range Selector -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-3">
        {% if view == 'today' or totals_current.sessions_count_open > 0 %}
        <div role="alert" class="alert alert-warning mb-3 shadow-lg rounded-xl border-none">
            <svg class="stroke-current shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.07 19h13.86c1.1 0 1.79-1.18 1.24-2.15L13.24 4.94c-.55-.97-1.93-.97-2.48 0L3.83 16.85c-.55.97.14 2.15 1.24 2.15z" />
            </svg>
            {% if totals_current.sessions_count_open > 0 %}
                {% if totals_current.sessions_count_open == 1 %}
                    <span class="text-sm font-medium">{{ _('There is 1 open cash session. Totals reflect closed sessions only.') }}</span>
                {% else %}
                    <span class="text-sm font-medium">{{ _('There are %(open_count)s open cash sessions. Totals reflect closed sessions only.') % {'open_count': totals_current.sessions_count_open} }}</span>
                {% endif %}
            {% else %}
                <span class="text-sm font-medium">{{ _('Today is still in progress. Totals reflect closed sessions only.') }}</span>
            {% endif %}
        </div>
        {% endif %}
        {% if date_error %}
        <div role="alert" class="alert alert-error mb-3 shadow-lg rounded-xl border-none">
            <svg class="stroke-current shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm font-medium">{{ date_error }}</span>
        </div>
        {% endif %}
        <div class="flex flex-wrap gap-2 items-center">
            <a href="/reports/business-stats?view=today" 
               class="btn btn-sm {% if view == 'today' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Today') }}
            </a>
            <a href="/reports/business-stats?view=yesterday" 
               class="btn btn-sm {% if view == 'yesterday' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Yesterday') }}
            </a>
            <a href="/reports/business-stats?view=this_week" 
               class="btn btn-sm {% if view == 'this_week' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('This Week') }}
            </a>
            <a href="/reports/business-stats?view=last_week" 
               class="btn btn-sm {% if view == 'last_week' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Last Week') }}
            </a>
            <a href="/reports/business-stats?view=this_month" 
               class="btn btn-sm tooltip tooltip-top {% if view == 'this_month' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]"
               data-tip="{{ _('MTD means month-to-date (from the 1st to today).') }}">
                {{ _('This Month (MTD)') }}
            </a>
            <a href="/reports/business-stats?view=last_month" 
               class="btn btn-sm {% if view == 'last_month' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Last Month') }}
            </a>
            <a href="/reports/business-stats?view=custom" 
               class="btn btn-sm {% if view == 'custom' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Custom') }}
            </a>
            {% if view == 'custom' %}
            <form method="GET" action="/reports/business-stats" class="flex gap-2 items-center">
                <input type="hidden" name="view" value="custom">
                <label for="from_date" class="sr-only">{{ _('Start date for custom range') }}</label>
                <input id="from_date" type="date" name="from_date" value="{{ from_date or current_from.isoformat() }}" 
                       class="input input-sm input-bordered focus:ring-2 focus:ring-primary/20 transition-all" required>
                <span class="text-xs text-base-content/60">{{ _('to') }}</span>
                <label for="to_date" class="sr-only">{{ _('End date for custom range') }}</label>
                <input id="to_date" type="date" name="to_date" value="{{ to_date or current_to.isoformat() }}" 
                       class="input input-sm input-bordered focus:ring-2 focus:ring-primary/20 transition-all" required>
                <button type="submit" class="btn btn-sm btn-primary transition-all hover:scale-[1.02] active:scale-[0.98]">{{ _('Apply') }}</button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Helper macro for delta display - hides delta when business is closed -->
    {% macro delta_display(delta, current_value, previous_value) %}
        {% if current_value == 0 and previous_value == 0 %}
            {# Business closed for both periods - no delta shown #}
        {% elif current_value == 0 and previous_value > 0 %}
            {# Business closed today - hide delta indicator #}
        {% elif delta.direction == 'up' %}
            <span class="text-success text-xs font-medium" title="{{ _('up') }} {{ delta.percent }}%">
                ↑ +{{ delta.percent }}%
            </span>
        {% elif delta.direction == 'down' %}
            <span class="text-error text-xs font-medium" title="{{ _('down') }} {{ delta.percent|abs }}%">
                ↓ {{ delta.percent|abs }}%
            </span>
        {% else %}
            <span class="text-base-content/50 text-xs" title="{{ delta.percent }}%">
                ± {{ delta.percent }}%
            </span>
        {% endif %}
    {% endmacro %}

    <!-- Primary 5-Card Grid (Always visible desktop & mobile) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
        <!-- Card 1: Cash Sales -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Cash Sales') }}</h3>
            <p class="stat-amount text-xl font-bold font-mono tabular-nums mb-1" data-fit-amount="true" data-min-size="14">Gs {{ totals_current.cash_sales | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.cash_sales, totals_current.cash_sales, totals_previous.cash_sales) }}
            </div>
        </div>

        <!-- Card 2: Card Payments -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Cards') }}</h3>
            <p class="stat-amount text-xl font-bold font-mono tabular-nums mb-1" data-fit-amount="true" data-min-size="14">Gs {{ totals_current.card_payments_total | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.card_payments_total, totals_current.card_payments_total, totals_previous.card_payments_total) }}
            </div>
        </div>

        <!-- Card 3: Credit Sales -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Credit Sales') }}</h3>
            <p class="stat-amount text-xl font-bold font-mono tabular-nums mb-1" data-fit-amount="true" data-min-size="14">Gs {{ totals_current.credit_sales_total | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.credit_sales_total, totals_current.credit_sales_total, totals_previous.credit_sales_total) }}
            </div>
        </div>

        <!-- Card 4: Collections -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Collections') }}</h3>
            <p class="stat-amount text-xl font-bold font-mono tabular-nums mb-1" data-fit-amount="true" data-min-size="14">Gs {{ totals_current.credit_payments_collected | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.credit_payments_collected, totals_current.credit_payments_collected, totals_previous.credit_payments_collected) }}
            </div>
        </div>

        <!-- Card 5: Bank Transfers -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Bank Transfers') }}</h3>
            <p class="stat-amount text-xl font-bold font-mono tabular-nums mb-1" data-fit-amount="true" data-min-size="14">Gs {{ totals_current.bank_transfer_total | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.bank_transfer_total, totals_current.bank_transfer_total, totals_previous.bank_transfer_total) }}
            </div>
        </div>
    </div>

    <!-- Top Performers Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-2">
        <!-- Best Performer Card -->
        <div class="bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 border-2 border-yellow-500/30 rounded-xl shadow-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-yellow-700">{{ _('Best Performer') }}</h3>
            </div>
            <div id="bestPerformer">
                <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
            </div>
        </div>

        <!-- Lower Volume Card -->
        <div class="bg-gradient-to-br from-amber-500/10 to-amber-600/5 border-2 border-amber-500/30 rounded-xl shadow-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-amber-700">{{ _('Lower Volume') }}</h3>
            </div>
            <div id="worstPerformer">
                <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
            </div>
        </div>

        <!-- Most Improved Card -->
        <div class="bg-gradient-to-br from-green-500/10 to-green-600/5 border-2 border-green-500/30 rounded-xl shadow-lg p-4" id="mostImprovedCard">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="mostImprovedIcon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-green-700" id="mostImprovedTitle">{{ _('Most Improved') }}</h3>
            </div>
            <div id="mostImproved">
                <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
            </div>
        </div>

        <!-- Gross Margin Summary Card -->
        <div class="bg-gradient-to-br from-slate-500/10 to-slate-600/5 border-2 border-slate-500/30 rounded-xl shadow-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 1.343-3 3v6a3 3 0 006 0v-6c0-1.657-1.343-3-3-3zm0 0V6m6 5a6 6 0 10-12 0v6a6 6 0 0012 0v-6z"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-slate-700">{{ _('Gross Margin') }}</h3>
            </div>
            <div class="flex items-baseline justify-between gap-3">
                <div>
                    <p class="text-lg font-bold text-base-content">{{ _('All Businesses') }}</p>
                    <p class="stat-amount text-2xl font-bold font-mono text-slate-700" data-fit-amount="true" data-min-size="16">Gs {{ totals_current.gross_margin | format_currency_py }}</p>
                </div>
                <div class="text-right">
                    <span class="text-xs font-semibold uppercase tracking-wider text-base-content/60 whitespace-nowrap">{{ _('Gross Margin %') }}</span>
                    <p class="text-lg font-bold text-slate-700">{{ "%.1f"|format(totals_current.gross_margin_percent) }}%</p>
                </div>
            </div>
        </div>
    </div>
    <p class="text-xs text-base-content/50 mb-4">{{ _('Ranking based on total sales for the current period.') }}</p>

    <!-- Visualizations Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <!-- Stacked Bar Chart -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-4">{{ _('Revenue Breakdown by Business') }}</h3>
            <div style="height: 300px;">
                <canvas id="stackedBarChart"></canvas>
            </div>
        </div>

        <!-- Contribution Donut Chart -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-4">{{ _('Business Contribution to Total') }}</h3>
            <div style="height: 300px;">
                <canvas id="contributionDonutChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Margin & Cost Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <!-- Margin vs Cost (Current) -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-4">{{ _('Margin vs Cost (Current Period)') }}</h3>
            <div style="height: 300px;">
                <canvas id="marginCostChart"></canvas>
            </div>
        </div>

        <!-- Change vs Previous Period (Table) -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-4">{{ _('Change vs Previous Period') }}</h3>
            <div class="overflow-x-auto">
                <table class="table table-sm w-full business-table">
                    <thead>
                        <tr class="border-b border-base-300">
                            <th class="bg-base-50 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60">
                                {{ _('Business') }}
                            </th>
                            <th class="text-right bg-base-50 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60">
                                {{ _('Sales Δ') }}
                            </th>
                            <th class="text-right bg-base-50 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60">
                                {{ _('Cost Δ') }}
                            </th>
                            <th class="text-right bg-base-50 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60">
                                {{ _('Margin Δ') }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in businesses %}
                        {% set delta_sales = item.current.total_sales - item.previous.total_sales %}
                        {% set delta_cost = item.current.daily_cost_total - item.previous.daily_cost_total %}
                        {% set delta_margin = item.current.gross_margin - item.previous.gross_margin %}
                        <tr>
                            <td class="text-[11px] font-semibold">{{ item.business.name }}</td>
                            <td class="text-right text-[11px] font-mono tabular-nums">
                                <span class="{% if delta_sales > 0 %}text-success{% elif delta_sales < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                                    {% if delta_sales > 0 %}+{% endif %}Gs {{ delta_sales | format_currency_py }}
                                </span>
                            </td>
                            <td class="text-right text-[11px] font-mono tabular-nums">
                                <span class="text-base-content/70">
                                    {% if delta_cost > 0 %}+{% endif %}Gs {{ delta_cost | format_currency_py }}
                                </span>
                            </td>
                            <td class="text-right text-[11px] font-mono tabular-nums">
                                <span class="{% if delta_margin > 0 %}text-success{% elif delta_margin < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                                    {% if delta_margin > 0 %}+{% endif %}Gs {{ delta_margin | format_currency_py }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Business Details Section -->
    <div class="space-y-3">
        <h2 class="text-sm font-bold uppercase tracking-widest text-base-content/70">{{ _('By Business') }}</h2>
        <p class="text-xs text-base-content/50">{{ _('Gross margin = sales − cost of goods.') }}</p>

        <!-- Margin Insights Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
                <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-3">{{ _('Average Gross Margin %') }}</h3>
                <div id="avgMarginCard">
                    <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
                </div>
            </div>
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
                <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-3">{{ _('Tickets (Top / Lowest)') }}</h3>
                <div id="ticketExtremesCard">
                    <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
                </div>
            </div>
            <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
                <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-3">{{ _('Margin Range') }}</h3>
                <div id="marginRangeCard">
                    <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
                </div>
            </div>
        </div>

        <style>
            .stat-amount {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                display: block;
            }

            .business-table tbody tr:hover td {
                background-color: hsl(var(--p) / 0.06) !important;
            }

            .business-table tbody tr {
                border-bottom: 1px solid hsl(var(--b2));
            }

            .business-table tbody td:not(:last-child),
            .business-table thead th:not(:last-child) {
                border-right: 1px solid hsl(var(--bc) / 0.08);
            }

            .business-table thead th.sortable-header {
                position: relative;
                cursor: default;
                padding-right: 1.4rem;
                user-select: none;
            }

            .business-table thead th.sortable-header:hover {
                background-color: hsl(var(--b2));
            }

            .business-table thead th .sort-icon {
                position: absolute;
                right: 0.35rem;
                top: 50%;
                transform: translateY(-50%);
                opacity: 0.35;
                font-size: 0.7rem;
            }
        </style>
        
        <!-- Desktop Table View - visible on screens 1024px and wider -->
        <div class="hidden lg:block overflow-x-auto bg-base-100 border border-base-300 rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
            <table class="table table-sm w-full business-table">
                <thead>
                    <tr class="border-b border-base-300">
                        <th class="sticky left-0 z-30 bg-base-50 border-r border-base-300/50 w-14 min-w-[56px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 sortable-header text-center">
                            {{ _('Rank') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="sticky left-14 z-20 bg-base-50 border-r border-base-300/50 min-w-[220px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 sortable-header">
                            {{ _('Business') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[130px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Cash Sales') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[130px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Cards') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[90px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Tickets') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[160px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Total Sales') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[150px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Cost of Goods') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[150px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Gross Margin') }}
                            <span class="sort-icon">↕</span>
                        </th>
                        <th class="text-right min-w-[120px] px-3 py-2 text-[11px] font-semibold uppercase tracking-[0.14em] text-base-content/60 bg-base-50 sortable-header">
                            {{ _('Gross Margin %') }}
                            <span class="sort-icon">↕</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in businesses %}
                    {% set no_current_sessions = item.current.total_sales == 0 %}
                    <tr class="transition-all duration-200 cursor-default border-l-2 border-transparent hover:!border-primary/60">
                        <td class="sticky left-0 z-20 bg-base-100 border-r border-base-300/50 px-3 py-2 text-[11px] font-semibold text-base-content/70 text-center shadow-[2px_0_4px_-2px_rgba(0,0,0,0.06)]">
                            #{{ loop.index }}
                        </td>
                        <td class="sticky left-14 z-10 bg-base-100 border-r border-base-300/50 px-3 py-2 font-semibold text-[11px] transition-colors duration-150 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.06)]">
                            <span class="truncate block max-w-[220px] leading-4">{{ item.business.name }}</span>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-base-300/30 text-[11px]">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-[11px]">—</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-[11px]">Gs {{ item.current.cash_sales | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-base-300/30 text-[11px]">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-[11px]">—</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-[11px]">Gs {{ item.current.card_payments_total | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-base-300/30 text-[11px]">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-[11px]">—</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-[11px]">{{ item.current.invoice_count }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-base-300/30 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                {% if no_current_sessions %}
                                    <span class="text-base-content/30 text-[11px]">—</span>
                                {% else %}
                                    <span class="font-bold font-mono tabular-nums text-[11px]">Gs {{ item.current.total_sales | format_currency_py }}</span>
                                {% endif %}
                                <div class="text-xs">
                                    {{ delta_display(item.deltas.total_sales, item.current.total_sales, item.previous.total_sales) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-base-300/30 text-[11px]">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-[11px]">—</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-[11px]">Gs {{ item.current.daily_cost_total | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-base-300/30 text-[11px]">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-[11px]">—</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-[11px]">Gs {{ item.current.gross_margin | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 text-[11px]">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-[11px]">—</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-[11px]">{{ "%.1f"|format(item.current.gross_margin_percent) }}%</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    <!-- Totals Row -->
                    <tr class="bg-primary/10 font-bold border-t border-primary/30">
                        <td class="sticky left-0 z-20 bg-primary/10 border-r border-primary/30 px-3 py-2 text-[11px] uppercase tracking-[0.14em] text-center shadow-[2px_0_4px_-2px_rgba(0,0,0,0.06)]">
                            —
                        </td>
                        <td class="sticky left-14 z-10 bg-primary/10 border-r border-primary/30 px-3 py-2 text-[11px] uppercase tracking-[0.14em] shadow-[2px_0_4px_-2px_rgba(0,0,0,0.06)]">
                            {{ _('TOTAL') }}
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-primary/20 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">Gs {{ totals_current.cash_sales | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.cash_sales, totals_current.cash_sales, totals_previous.cash_sales) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-primary/20 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">Gs {{ totals_current.card_payments_total | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.card_payments_total, totals_current.card_payments_total, totals_previous.card_payments_total) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-primary/20 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">{{ totals_current.invoice_count }}</span>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-primary/20 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">Gs {{ totals_current.total_sales | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.total_sales, totals_current.total_sales, totals_previous.total_sales) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-primary/20 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">Gs {{ totals_current.daily_cost_total | format_currency_py }}</span>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 border-r border-primary/20 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">Gs {{ totals_current.gross_margin | format_currency_py }}</span>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-3 py-2 text-[11px]">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-[11px] text-primary">{{ "%.1f"|format(totals_current.gross_margin_percent) }}%</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Mobile/Tablet Card View - visible on screens smaller than 1024px -->
        <div class="lg:hidden space-y-3">
            {% for item in businesses %}
            {% set no_current_sessions = item.current.total_sales == 0 %}
            <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200 p-4">
                <h3 class="text-sm font-bold mb-3 pb-2 border-b border-base-300">{{ item.business.name }}</h3>
                
                <div class="space-y-2.5">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Cash Sales') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">—</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.cash_sales | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Cards') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">—</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.card_payments_total | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Tickets') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">—</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">{{ item.current.invoice_count }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Total Sales') }}</span>
                        <div class="flex items-center gap-2">
                            {% if no_current_sessions %}
                                <span class="text-sm text-base-content/40">—</span>
                            {% else %}
                                <span class="text-sm font-bold font-mono tabular-nums">Gs {{ item.current.total_sales | format_currency_py }}</span>
                            {% endif %}
                            {{ delta_display(item.deltas.total_sales, item.current.total_sales, item.previous.total_sales) }}
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Cost of Goods') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">—</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.daily_cost_total | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Gross Margin') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">—</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.gross_margin | format_currency_py }} ({{ "%.1f"|format(item.current.gross_margin_percent) }}%)</span>
                        {% endif %}
                    </div>
                </div>

                <!-- More Details Collapsible Section -->
                <div class="collapse collapse-arrow bg-base-200 rounded-lg mt-3">
                    <input
                        type="checkbox"
                        id="business-details-{{ loop.index0 }}"
                        aria-label="{{ _('Toggle more details for') }} {{ item.business.name }}"
                        aria-controls="business-details-panel-{{ loop.index0 }}">
                    <div class="collapse-title text-xs font-semibold text-primary py-2 px-0 min-h-0">
                        {{ _('More Details') }}
                    </div>
                    <div class="collapse-content px-0" id="business-details-panel-{{ loop.index0 }}">
                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Cash Profit') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums {% if item.current.cash_profit >= 0 %}text-success{% else %}text-error{% endif %}">
                                    {% if item.current.cash_profit >= 0 %}+{% endif %}Gs {{ item.current.cash_profit | format_currency_py }}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Total Expenses') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums text-error">−Gs {{ item.current.total_expenses | format_currency_py }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Sessions Open') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums">{{ item.current.sessions_count_open }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Sessions Closed') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums">{{ item.current.sessions_count_closed }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Need Review') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums {% if item.current.sessions_need_review > 0 %}text-warning{% endif %}">
                                    {{ item.current.sessions_need_review }}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Payment Mix') }}</p>
                                <p class="text-xs font-mono tabular-nums">
                                    {{ _('Cash') }}:{{ "%.0f"|format(item.current.payment_method_mix.cash_percent) }}% 
                                    {{ _('Card') }}:{{ "%.0f"|format(item.current.payment_method_mix.card_percent) }}% 
                                    {{ _('Bank') }}:{{ "%.0f"|format(item.current.payment_method_mix.bank_percent) }}%
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
        Chart.defaults.plugins.datalabels.display = false;
    }
    // Business data from template
    const businesses = [
        {% for item in businesses %}
        {
            name: "{{ item.business.name|e }}",
            currentTotal: {{ item.current.total_sales }},
            previousTotal: {{ item.previous.total_sales }},
            cashSales: {{ item.current.cash_sales }},
            cardPayments: {{ item.current.card_payments_total }},
            creditSales: {{ item.current.credit_sales_total }},
            bankTransfer: {{ item.current.bank_transfer_total }},
            costTotal: {{ item.current.daily_cost_total }},
            grossMargin: {{ item.current.gross_margin }},
            grossMarginPercent: {{ item.current.gross_margin_percent }},
            tickets: {{ item.current.invoice_count }},
            delta: {{ item.deltas.total_sales.percent }},
            direction: "{{ item.deltas.total_sales.direction }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    const totalSales = {{ totals_current.total_sales }};

    // Format currency
    function formatCurrency(value) {
        const num = Math.round(parseFloat(value));
        return 'Gs ' + num.toLocaleString('es-PY').replace(/,/g, '.');
    }

    // Get growth context label
    function getGrowthLabel(percent) {
        if (percent > 20) return "{{ _('Strong Growth') }}";
        if (percent > 10) return "{{ _('Growing') }}";
        if (percent > 3) return "{{ _('Slight Growth') }}";
        if (percent >= -3) return "{{ _('Stable') }}";
        if (percent >= -10) return "{{ _('Slight Decline') }}";
        if (percent >= -20) return "{{ _('Declining') }}";
        return "{{ _('Sharp Decline') }}";
    }

    // Calculate top performers
    const activeBusinesses = businesses.filter(b => b.currentTotal > 0);
    const sorted = [...activeBusinesses].sort((a, b) => b.currentTotal - a.currentTotal);
    const sortedByWorst = [...activeBusinesses].sort((a, b) => a.currentTotal - b.currentTotal);
    const withGrowth = businesses.filter(b => b.currentTotal > 0 && b.previousTotal > 0);
    const sortedByGrowth = [...withGrowth].sort((a, b) => b.delta - a.delta);

    function fitStatAmounts() {
        const items = document.querySelectorAll('[data-fit-amount="true"]');
        items.forEach((el) => {
            const minSize = parseFloat(el.dataset.minSize || '12');
            const maxSize = parseFloat(el.dataset.maxSize || '');
            if (!Number.isNaN(maxSize)) {
                el.style.fontSize = `${maxSize}px`;
            } else {
                el.style.fontSize = '';
            }
            let fontSize = parseFloat(window.getComputedStyle(el).fontSize);
            let guard = 0;
            while (el.scrollWidth > el.clientWidth && fontSize > minSize && guard < 20) {
                fontSize -= 1;
                el.style.fontSize = `${fontSize}px`;
                guard += 1;
            }
        });
    }

    // Display Best Performer
    if (sorted.length > 0 && sorted[0].currentTotal > 0) {
        const best = sorted[0];
        document.getElementById('bestPerformer').innerHTML = `
            <p class="text-lg font-bold text-base-content">${best.name}</p>
            <p class="stat-amount text-xl font-bold font-mono text-yellow-600" data-fit-amount="true" data-min-size="14">${formatCurrency(best.currentTotal)}</p>
            <p class="text-sm text-base-content/60 mt-1">${(best.currentTotal / totalSales * 100).toFixed(1)}% {{ _('of total') }}</p>
        `;
    } else {
        document.getElementById('bestPerformer').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No data") }}</p>';
    }

    // Display Worst Performer
    if (sortedByWorst.length > 0) {
        const worst = sortedByWorst[0];
        document.getElementById('worstPerformer').innerHTML = `
            <p class="text-lg font-bold text-base-content">${worst.name}</p>
            <p class="stat-amount text-xl font-bold font-mono text-amber-600" data-fit-amount="true" data-min-size="14">${formatCurrency(worst.currentTotal)}</p>
            <p class="text-sm text-base-content/60 mt-1">{{ _('Lower share of total') }} (${(worst.currentTotal / totalSales * 100).toFixed(1)}%)</p>
        `;
    } else {
        document.getElementById('worstPerformer').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No data") }}</p>';
    }

    // Display Most Improved
    if (sortedByGrowth.length > 0) {
        const improved = sortedByGrowth[0];
        const arrow = improved.delta > 0 ? '↑' : improved.delta < 0 ? '↓' : '→';
        const improvementLabel = improved.delta < 0
            ? "{{ _('Smallest Decline') }}"
            : "{{ _('Most Improved') }}";
        const improvementColor = improved.delta < 0 ? 'text-error' : 'text-green-600';
        const titleEl = document.getElementById('mostImprovedTitle');
        const iconEl = document.getElementById('mostImprovedIcon');
        const cardEl = document.getElementById('mostImprovedCard');
        if (titleEl) {
            titleEl.textContent = improvementLabel;
            titleEl.classList.toggle('text-green-700', improved.delta >= 0);
            titleEl.classList.toggle('text-slate-700', improved.delta < 0);
        }
        if (iconEl) {
            iconEl.classList.toggle('text-green-600', improved.delta >= 0);
            iconEl.classList.toggle('text-slate-600', improved.delta < 0);
        }
        if (cardEl) {
            cardEl.classList.toggle('bg-gradient-to-br', true);
            cardEl.classList.toggle('border-2', true);
            cardEl.classList.toggle('shadow-lg', true);

            cardEl.classList.toggle('from-green-500/10', improved.delta >= 0);
            cardEl.classList.toggle('to-green-600/5', improved.delta >= 0);
            cardEl.classList.toggle('border-green-500/30', improved.delta >= 0);

            cardEl.classList.toggle('from-slate-500/10', improved.delta < 0);
            cardEl.classList.toggle('to-slate-600/5', improved.delta < 0);
            cardEl.classList.toggle('border-slate-500/30', improved.delta < 0);
        }
        document.getElementById('mostImproved').innerHTML = `
            <p class="text-lg font-bold text-base-content">${improved.name}</p>
            <p class="text-xl font-bold font-mono ${improvementColor}">${arrow} ${improved.delta > 0 ? '+' : ''}${improved.delta}%</p>
            <p class="text-sm text-base-content/60 mt-1">${getGrowthLabel(improved.delta)}</p>
        `;
    } else {
        document.getElementById('mostImproved').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No comparison data") }}</p>';
    }

    // Stacked Bar Chart
    const stackedCtx = document.getElementById('stackedBarChart');
    if (stackedCtx && typeof Chart !== 'undefined') {
        new Chart(stackedCtx, {
            type: 'bar',
            data: {
                labels: sorted.map(b => b.name),
                datasets: [
                    {
                        label: '{{ _("Cash") }}',
                        data: sorted.map(b => b.cashSales),
                        backgroundColor: 'rgb(34, 197, 94)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Cards") }}',
                        data: sorted.map(b => b.cardPayments),
                        backgroundColor: 'rgb(59, 130, 246)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Bank Transfer") }}',
                        data: sorted.map(b => b.bankTransfer),
                        backgroundColor: 'rgb(168, 85, 247)',
                        borderColor: 'rgb(168, 85, 247)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Credit Sales") }}',
                        data: sorted.map(b => b.creditSales),
                        backgroundColor: 'rgb(249, 115, 22)',
                        borderColor: 'rgb(249, 115, 22)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return 'Gs ' + (value / 1000000).toFixed(1) + 'M';
                                }
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // Contribution Donut Chart
    const donutCtx = document.getElementById('contributionDonutChart');
    if (donutCtx && typeof Chart !== 'undefined') {
        const colors = [
            'rgb(99, 102, 241)',
            'rgb(34, 197, 94)',
            'rgb(249, 115, 22)',
            'rgb(236, 72, 153)',
            'rgb(168, 85, 247)',
            'rgb(59, 130, 246)',
            'rgb(251, 191, 36)',
            'rgb(20, 184, 166)',
            'rgb(239, 68, 68)',
            'rgb(107, 114, 128)'
        ];

        new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                labels: sorted.map(b => b.name),
                datasets: [{
                    data: sorted.map(b => b.currentTotal),
                    backgroundColor: colors.slice(0, sorted.length),
                    borderWidth: 2,
                    borderColor: 'rgb(255, 255, 255)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        display: true,
                        color: '#ffffff',
                        font: {
                            weight: '600',
                            size: 11
                        },
                        textStrokeColor: 'rgba(17, 24, 39, 0.65)',
                        textStrokeWidth: 2,
                        formatter: function(value, context) {
                            const data = context.dataset.data || [];
                            const total = data.reduce((a, b) => a + b, 0);
                            if (!total) return '';
                            const percent = (value / total) * 100;
                            return percent >= 4 ? percent.toFixed(0) + '%' : '';
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + formatCurrency(value) + ' (' + percent + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Margin insight cards
    const activeForMargin = activeBusinesses.filter(b => b.currentTotal > 0);
    const avgMargin = activeForMargin.length
        ? activeForMargin.reduce((sum, b) => sum + b.grossMarginPercent, 0) / activeForMargin.length
        : 0;

    const byTickets = [...activeBusinesses].sort((a, b) => b.tickets - a.tickets);
    const topTickets = byTickets[0];
    const lowTickets = byTickets[byTickets.length - 1];

    const byMarginPct = [...activeBusinesses].sort((a, b) => b.grossMarginPercent - a.grossMarginPercent);
    const bestMargin = byMarginPct[0];
    const worstMargin = byMarginPct[byMarginPct.length - 1];
    const marginRangeText = bestMargin && worstMargin
        ? `${worstMargin.grossMarginPercent.toFixed(1)}% - ${bestMargin.grossMarginPercent.toFixed(1)}%`
        : '';

    if (document.getElementById('avgMarginCard')) {
        document.getElementById('avgMarginCard').innerHTML = `
            <p class="text-2xl font-bold text-base-content">${avgMargin.toFixed(1)}%</p>
            <p class="text-sm text-base-content/60 mt-1">${activeForMargin.length} {{ _('businesses') }}</p>
        `;
    }

    if (document.getElementById('ticketExtremesCard')) {
        if (topTickets && lowTickets) {
            document.getElementById('ticketExtremesCard').innerHTML = `
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                        <p class="text-xs text-base-content/60 uppercase tracking-wider">{{ _('Top') }}</p>
                        <p class="text-sm font-semibold text-base-content leading-4">${topTickets.name}</p>
                        <p class="text-xs text-base-content/60 mt-1">${topTickets.tickets} {{ _('Tickets') }}</p>
                    </div>
                    <div class="flex-1 text-right">
                        <p class="text-xs text-base-content/60 uppercase tracking-wider">{{ _('Lowest') }}</p>
                        <p class="text-sm font-semibold text-base-content leading-4">${lowTickets.name}</p>
                        <p class="text-xs text-base-content/60 mt-1">${lowTickets.tickets} {{ _('Tickets') }}</p>
                    </div>
                </div>
            `;
        } else {
            document.getElementById('ticketExtremesCard').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No data") }}</p>';
        }
    }

    if (document.getElementById('marginRangeCard')) {
        if (bestMargin && worstMargin) {
            document.getElementById('marginRangeCard').innerHTML = `
                <p class="text-2xl font-bold text-base-content">${marginRangeText}</p>
                <p class="text-sm text-base-content/60 mt-1">${worstMargin.name} → ${bestMargin.name}</p>
            `;
        } else {
            document.getElementById('marginRangeCard').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No data") }}</p>';
        }
    }

    requestAnimationFrame(fitStatAmounts);

    // Margin vs Cost (Current Period)
    const marginCostCtx = document.getElementById('marginCostChart');
    if (marginCostCtx && typeof Chart !== 'undefined') {
        new Chart(marginCostCtx, {
            type: 'bar',
            data: {
                labels: sorted.map(b => b.name),
                datasets: [
                    {
                        label: '{{ _("Cost (Gs)") }}',
                        data: sorted.map(b => b.costTotal),
                        backgroundColor: 'rgb(100, 116, 139)',
                        borderColor: 'rgb(100, 116, 139)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Margin (Gs)") }}',
                        data: sorted.map(b => b.grossMargin),
                        backgroundColor: 'rgb(16, 185, 129)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return 'Gs ' + (value / 1000000).toFixed(1) + 'M';
                                }
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

});
</script>

{% endblock %}
