<!-- File: templates/reports/business-stats.html -->
{% extends "reports/base.html" %}

{% block report_title %}{{ _('Business Statistics') }}{% endblock %}

{% block report_header %}{{ _('Business Statistics') }}{% endblock %}
{% block report_description %}{{ _('Multi-business statistics dashboard with daily metrics comparison') }}{% endblock %}

{% block report_content %}
<div class="space-y-4">
    <!-- Period Comparison Label & Hero Box Combined -->
    <div class="bg-gradient-to-br from-primary/10 to-base-100 border-2 border-primary/30 rounded-xl shadow-lg p-4 transition-all duration-200">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="px-2.5 py-1 bg-primary/20 rounded-md text-primary font-semibold text-xs uppercase tracking-wider">{{ _('Current') }}</span>
                <span class="text-sm font-bold text-base-content">{{ current_period_label }}</span>
                <span class="text-base-content/40">vs</span>
                <span class="px-2.5 py-1 bg-base-200 rounded-md text-base-content/70 font-semibold text-xs uppercase tracking-wider">{{ _('Previous') }}</span>
                <span class="text-sm font-bold text-base-content/70">{{ previous_period_label }}</span>
            </div>
            <div class="text-xs text-base-content/60 uppercase tracking-wider">{{ _('Cash') }} + {{ _('Cards') }} + {{ _('Credit Sales') }}</div>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-3">
            <div class="flex items-baseline gap-3">
                <h2 class="text-xs font-bold uppercase tracking-widest text-base-content/70">{{ _('Total Sales') }}</h2>
                <p class="text-3xl font-bold font-mono text-primary tabular-nums">
                    Gs {{ totals_current.total_sales | format_currency_py }}
                </p>
                {% if totals_deltas.total_sales.direction == 'up' %}
                    <span class="text-success text-sm font-medium">â†‘ +{{ totals_deltas.total_sales.percent }}%</span>
                {% elif totals_deltas.total_sales.direction == 'down' %}
                    <span class="text-error text-sm font-medium">â†“ {{ totals_deltas.total_sales.percent }}%</span>
                {% elif totals_deltas.total_sales.percent == 0 and totals_current.total_sales == 0 %}
                    <span class="text-base-content/40 text-xs italic">{{ _('No data') }}</span>
                {% else %}
                    <span class="text-base-content/50 text-sm">Â± {{ totals_deltas.total_sales.percent }}%</span>
                {% endif %}
            </div>
            <div class="text-xs text-base-content/50">
                {{ _('Previous') }}: <span class="font-mono tabular-nums">Gs {{ totals_previous.total_sales | format_currency_py }}</span>
            </div>
        </div>
    </div>

    <!-- Date Range Selector -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-3">
        {% if date_error %}
        <div role="alert" class="alert alert-error mb-3 shadow-lg rounded-xl border-none">
            <svg class="stroke-current shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm font-medium">{{ date_error }}</span>
        </div>
        {% endif %}
        <div class="flex flex-wrap gap-2 items-center">
            <a href="/reports/business-stats?view=today" 
               class="btn btn-sm {% if view == 'today' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Today') }}
            </a>
            <a href="/reports/business-stats?view=yesterday" 
               class="btn btn-sm {% if view == 'yesterday' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Yesterday') }}
            </a>
            <a href="/reports/business-stats?view=week" 
               class="btn btn-sm {% if view == 'week' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Last 7 Days') }}
            </a>
            <a href="/reports/business-stats?view=month" 
               class="btn btn-sm {% if view == 'month' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Last 30 Days') }}
            </a>
            <a href="/reports/business-stats?view=custom" 
               class="btn btn-sm {% if view == 'custom' %}btn-primary{% else %}btn-outline{% endif %} transition-all hover:scale-[1.02] active:scale-[0.98]">
                {{ _('Custom') }}
            </a>
            {% if view == 'custom' %}
            <form method="GET" action="/reports/business-stats" class="flex gap-2 items-center">
                <input type="hidden" name="view" value="custom">
                <label for="from_date" class="sr-only">{{ _('Start date for custom range') }}</label>
                <input id="from_date" type="date" name="from_date" value="{{ from_date or current_from.isoformat() }}" 
                       class="input input-sm input-bordered focus:ring-2 focus:ring-primary/20 transition-all" required>
                <span class="text-xs text-base-content/60">{{ _('to') }}</span>
                <label for="to_date" class="sr-only">{{ _('End date for custom range') }}</label>
                <input id="to_date" type="date" name="to_date" value="{{ to_date or current_to.isoformat() }}" 
                       class="input input-sm input-bordered focus:ring-2 focus:ring-primary/20 transition-all" required>
                <button type="submit" class="btn btn-sm btn-primary transition-all hover:scale-[1.02] active:scale-[0.98]">{{ _('Apply') }}</button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Helper macro for delta display - hides delta when business is closed -->
    {% macro delta_display(delta, current_value, previous_value) %}
        {% if current_value == 0 and previous_value == 0 %}
            {# Business closed for both periods - no delta shown #}
        {% elif current_value == 0 and previous_value > 0 %}
            {# Business closed today - hide delta indicator #}
        {% elif delta.direction == 'up' %}
            <span class="text-success text-xs font-medium" title="{{ _('up') }} {{ delta.percent }}%">
                â†‘ +{{ delta.percent }}%
            </span>
        {% elif delta.direction == 'down' %}
            <span class="text-error text-xs font-medium" title="{{ _('down') }} {{ delta.percent|abs }}%">
                â†“ {{ delta.percent|abs }}%
            </span>
        {% else %}
            <span class="text-base-content/50 text-xs" title="{{ delta.percent }}%">
                Â± {{ delta.percent }}%
            </span>
        {% endif %}
    {% endmacro %}

    <!-- Primary 5-Card Grid (Always visible desktop & mobile) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
        <!-- Card 1: Cash Sales -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Cash Sales') }}</h3>
            <p class="text-xl font-bold font-mono tabular-nums mb-1">Gs {{ totals_current.cash_sales | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.cash_sales, totals_current.cash_sales, totals_previous.cash_sales) }}
            </div>
        </div>

        <!-- Card 2: Card Payments -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Cards') }}</h3>
            <p class="text-xl font-bold font-mono tabular-nums mb-1">Gs {{ totals_current.card_payments_total | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.card_payments_total, totals_current.card_payments_total, totals_previous.card_payments_total) }}
            </div>
        </div>

        <!-- Card 3: Credit Sales -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Credit Sales') }}</h3>
            <p class="text-xl font-bold font-mono tabular-nums mb-1">Gs {{ totals_current.credit_sales_total | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.credit_sales_total, totals_current.credit_sales_total, totals_previous.credit_sales_total) }}
            </div>
        </div>

        <!-- Card 4: Collections -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Collections') }}</h3>
            <p class="text-xl font-bold font-mono tabular-nums mb-1">Gs {{ totals_current.credit_payments_collected | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.credit_payments_collected, totals_current.credit_payments_collected, totals_previous.credit_payments_collected) }}
            </div>
        </div>

        <!-- Card 5: Bank Transfers -->
        <div class="bg-base-100 border border-primary/30 rounded-lg p-3 shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200">
            <h3 class="text-xs font-bold uppercase tracking-wider text-base-content/70 mb-2">{{ _('Bank Transfers') }}</h3>
            <p class="text-xl font-bold font-mono tabular-nums mb-1">Gs {{ totals_current.bank_transfer_total | format_currency_py }}</p>
            <div class="mt-1">
                {{ delta_display(totals_deltas.bank_transfer_total, totals_current.bank_transfer_total, totals_previous.bank_transfer_total) }}
            </div>
        </div>
    </div>

    <!-- Top Performers Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- Best Performer Card -->
        <div class="bg-gradient-to-br from-yellow-500/10 to-yellow-600/5 border-2 border-yellow-500/30 rounded-xl shadow-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-yellow-700">{{ _('Best Performer') }}</h3>
            </div>
            <div id="bestPerformer">
                <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
            </div>
        </div>

        <!-- Most Improved Card -->
        <div class="bg-gradient-to-br from-green-500/10 to-green-600/5 border-2 border-green-500/30 rounded-xl shadow-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-green-700">{{ _('Most Improved') }}</h3>
            </div>
            <div id="mostImproved">
                <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
            </div>
        </div>

        <!-- Needs Attention Card -->
        <div class="bg-gradient-to-br from-orange-500/10 to-orange-600/5 border-2 border-orange-500/30 rounded-xl shadow-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h3 class="font-bold text-sm uppercase tracking-wider text-orange-700">{{ _('Needs Attention') }}</h3>
            </div>
            <div id="needsAttention">
                <p class="text-base-content/60 text-sm italic">{{ _('Loading...') }}</p>
            </div>
        </div>
    </div>

    <!-- Visualizations Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <!-- Stacked Bar Chart -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-4">{{ _('Revenue Breakdown by Business') }}</h3>
            <div style="height: 300px;">
                <canvas id="stackedBarChart"></canvas>
            </div>
        </div>

        <!-- Contribution Donut Chart -->
        <div class="bg-base-100 border border-base-300 rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/70 mb-4">{{ _('Business Contribution to Total') }}</h3>
            <div style="height: 300px;">
                <canvas id="contributionDonutChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Business Details Section -->
    <div class="space-y-3">
        <h2 class="text-sm font-bold uppercase tracking-widest text-base-content/70">{{ _('By Business') }}</h2>
        
        <!-- Desktop Table View - visible on screens 1024px and wider -->
        <div class="hidden lg:block overflow-x-auto bg-base-100 border border-base-300 rounded-xl shadow-lg">
            <table class="table table-sm w-full">
                <thead>
                    <tr class="bg-gradient-to-r from-base-200 to-base-200/80 border-b-2 border-primary/20">
                        <th class="sticky left-0 z-20 bg-gradient-to-r from-base-200 to-base-200/80 border-r border-base-300/50 min-w-[200px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70">
                            {{ _('Business') }}
                        </th>
                        <th class="text-right min-w-[140px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70 border-r border-base-300/30">
                            {{ _('Cash Sales') }}
                        </th>
                        <th class="text-right min-w-[140px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70 border-r border-base-300/30">
                            {{ _('Credit Sales') }}
                        </th>
                        <th class="text-right min-w-[140px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70 border-r border-base-300/30">
                            {{ _('Cards') }}
                        </th>
                        <th class="text-right min-w-[140px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70 border-r border-base-300/30">
                            {{ _('Collections') }}
                        </th>
                        <th class="text-right min-w-[140px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70 border-r border-base-300/30">
                            {{ _('Bank Transfers') }}
                        </th>
                        <th class="text-right min-w-[180px] px-4 py-3 text-xs font-bold uppercase tracking-wider text-base-content/70">
                            {{ _('Total Sales') }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in businesses %}
                    {% set business_closed = item.current.total_sales == 0 and item.previous.total_sales > 0 %}
                    {% set no_current_sessions = item.current.total_sales == 0 %}
                    <tr class="hover:bg-primary/5 transition-all duration-200 border-b border-base-200/50 group">
                        <td class="sticky left-0 z-10 bg-base-100 group-hover:bg-primary/5 border-r border-base-300/50 px-4 py-3 font-semibold text-sm transition-colors duration-200 shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                            <div class="flex items-center gap-2">
                                {% if loop.index == 1 %}
                                <span class="badge badge-sm bg-yellow-500 text-yellow-50 border-none">ðŸ¥‡</span>
                                {% elif loop.index == 2 %}
                                <span class="badge badge-sm bg-gray-400 text-gray-50 border-none">ðŸ¥ˆ</span>
                                {% elif loop.index == 3 %}
                                <span class="badge badge-sm bg-orange-600 text-orange-50 border-none">ðŸ¥‰</span>
                                {% endif %}
                                <span>{{ item.business.name }}</span>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-base-300/30">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-sm">â€”</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-base">Gs {{ item.current.cash_sales | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-base-300/30">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-sm">â€”</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-base">Gs {{ item.current.credit_sales_total | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-base-300/30">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-sm">â€”</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-base">Gs {{ item.current.card_payments_total | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-base-300/30">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-sm">â€”</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-base">Gs {{ item.current.credit_payments_collected | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-base-300/30">
                            {% if no_current_sessions %}
                                <span class="text-base-content/30 text-sm">â€”</span>
                            {% else %}
                                <span class="font-mono tabular-nums text-base">Gs {{ item.current.bank_transfer_total | format_currency_py }}</span>
                            {% endif %}
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3">
                            <div class="flex flex-col items-end gap-1">
                                {% if no_current_sessions %}
                                    <span class="text-base-content/30 text-sm">â€”</span>
                                {% else %}
                                    <span class="font-bold font-mono tabular-nums text-base">Gs {{ item.current.total_sales | format_currency_py }}</span>
                                {% endif %}
                                <div class="text-xs">
                                    {{ delta_display(item.deltas.total_sales, item.current.total_sales, item.previous.total_sales) }}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    <!-- Totals Row -->
                    <tr class="bg-gradient-to-r from-primary/10 via-primary/5 to-base-200 font-bold border-t-2 border-primary/40">
                        <td class="sticky left-0 z-10 bg-gradient-to-r from-primary/10 via-primary/5 to-base-200 border-r border-primary/30 px-4 py-3 text-sm uppercase tracking-wider shadow-[2px_0_4px_-2px_rgba(0,0,0,0.1)]">
                            {{ _('TOTAL') }}
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-primary/20">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-base text-primary">Gs {{ totals_current.cash_sales | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.cash_sales, totals_current.cash_sales, totals_previous.cash_sales) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-primary/20">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-base text-primary">Gs {{ totals_current.credit_sales_total | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.credit_sales_total, totals_current.credit_sales_total, totals_previous.credit_sales_total) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-primary/20">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-base text-primary">Gs {{ totals_current.card_payments_total | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.card_payments_total, totals_current.card_payments_total, totals_previous.card_payments_total) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-primary/20">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-base text-primary">Gs {{ totals_current.credit_payments_collected | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.credit_payments_collected, totals_current.credit_payments_collected, totals_previous.credit_payments_collected) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3 border-r border-primary/20">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-base text-primary">Gs {{ totals_current.bank_transfer_total | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.bank_transfer_total, totals_current.bank_transfer_total, totals_previous.bank_transfer_total) }}
                                </div>
                            </div>
                        </td>
                        <td class="text-right whitespace-nowrap px-4 py-3">
                            <div class="flex flex-col items-end gap-1">
                                <span class="font-bold font-mono tabular-nums text-base text-primary">Gs {{ totals_current.total_sales | format_currency_py }}</span>
                                <div class="text-xs">
                                    {{ delta_display(totals_deltas.total_sales, totals_current.total_sales, totals_previous.total_sales) }}
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Mobile/Tablet Card View - visible on screens smaller than 1024px -->
        <div class="lg:hidden space-y-3">
            {% for item in businesses %}
            {% set business_closed = item.current.total_sales == 0 and item.previous.total_sales > 0 %}
            {% set no_current_sessions = item.current.total_sales == 0 %}
            <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm hover:shadow-md hover:border-primary/40 transition-all duration-200 p-4">
                <h3 class="text-sm font-bold mb-3 pb-2 border-b border-base-300">{{ item.business.name }}</h3>
                
                <div class="space-y-2.5">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Cash Sales') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">â€”</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.cash_sales | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Credit Sales') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">â€”</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.credit_sales_total | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Cards') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">â€”</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.card_payments_total | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Collections') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">â€”</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.credit_payments_collected | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Bank Transfers') }}</span>
                        {% if no_current_sessions %}
                            <span class="text-sm text-base-content/40">â€”</span>
                        {% else %}
                            <span class="text-sm font-mono tabular-nums">Gs {{ item.current.bank_transfer_total | format_currency_py }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Total Sales') }}</span>
                        <div class="flex items-center gap-2">
                            {% if no_current_sessions %}
                                <span class="text-sm text-base-content/40">â€”</span>
                            {% else %}
                                <span class="text-sm font-bold font-mono tabular-nums">Gs {{ item.current.total_sales | format_currency_py }}</span>
                            {% endif %}
                            {{ delta_display(item.deltas.total_sales, item.current.total_sales, item.previous.total_sales) }}
                        </div>
                    </div>
                </div>

                <!-- More Details Collapsible Section -->
                <div class="collapse collapse-arrow bg-base-200 rounded-lg mt-3">
                    <input
                        type="checkbox"
                        id="business-details-{{ loop.index0 }}"
                        aria-label="{{ _('Toggle more details for') }} {{ item.business.name }}"
                        aria-controls="business-details-panel-{{ loop.index0 }}">
                    <div class="collapse-title text-xs font-semibold text-primary py-2 px-0 min-h-0">
                        {{ _('More Details') }}
                    </div>
                    <div class="collapse-content px-0" id="business-details-panel-{{ loop.index0 }}">
                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Cash Profit') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums {% if item.current.cash_profit >= 0 %}text-success{% else %}text-error{% endif %}">
                                    {% if item.current.cash_profit >= 0 %}+{% endif %}Gs {{ item.current.cash_profit | format_currency_py }}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Total Expenses') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums text-error">âˆ’Gs {{ item.current.total_expenses | format_currency_py }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Sessions Open') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums">{{ item.current.sessions_count_open }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Sessions Closed') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums">{{ item.current.sessions_count_closed }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Need Review') }}</p>
                                <p class="text-sm font-bold font-mono tabular-nums {% if item.current.sessions_need_review > 0 %}text-warning{% endif %}">
                                    {{ item.current.sessions_need_review }}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-wider text-base-content/70 mb-1">{{ _('Payment Mix') }}</p>
                                <p class="text-xs font-mono tabular-nums">
                                    {{ _('Cash') }}:{{ "%.0f"|format(item.current.payment_method_mix.cash_percent) }}% 
                                    {{ _('Card') }}:{{ "%.0f"|format(item.current.payment_method_mix.card_percent) }}% 
                                    {{ _('Bank') }}:{{ "%.0f"|format(item.current.payment_method_mix.bank_percent) }}%
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Business data from template
    const businesses = [
        {% for item in businesses %}
        {
            name: "{{ item.business.name|e }}",
            currentTotal: {{ item.current.total_sales }},
            previousTotal: {{ item.previous.total_sales }},
            cashSales: {{ item.current.cash_sales }},
            cardPayments: {{ item.current.card_payments_total }},
            creditSales: {{ item.current.credit_sales_total }},
            bankTransfer: {{ item.current.bank_transfer_total }},
            delta: {{ item.deltas.total_sales.percent }},
            direction: "{{ item.deltas.total_sales.direction }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    const totalSales = {{ totals_current.total_sales }};

    // Format currency
    function formatCurrency(value) {
        const num = Math.round(parseFloat(value));
        return 'Gs ' + num.toLocaleString('es-PY').replace(/,/g, '.');
    }

    // Get growth context label
    function getGrowthLabel(percent) {
        if (percent > 20) return "{{ _('Strong Growth') }}";
        if (percent > 10) return "{{ _('Growing') }}";
        if (percent > 3) return "{{ _('Slight Growth') }}";
        if (percent >= -3) return "{{ _('Stable') }}";
        if (percent >= -10) return "{{ _('Slight Decline') }}";
        if (percent >= -20) return "{{ _('Declining') }}";
        return "{{ _('Sharp Decline') }}";
    }

    // Calculate top performers
    const sorted = [...businesses].sort((a, b) => b.currentTotal - a.currentTotal);
    const withGrowth = businesses.filter(b => b.currentTotal > 0 && b.previousTotal > 0);
    const sortedByGrowth = [...withGrowth].sort((a, b) => b.delta - a.delta);
    const declining = [...withGrowth].filter(b => b.delta < -10).sort((a, b) => a.delta - b.delta);

    // Display Best Performer
    if (sorted.length > 0 && sorted[0].currentTotal > 0) {
        const best = sorted[0];
        document.getElementById('bestPerformer').innerHTML = `
            <p class="text-lg font-bold text-base-content">${best.name}</p>
            <p class="text-xl font-bold font-mono text-yellow-600">${formatCurrency(best.currentTotal)}</p>
            <p class="text-sm text-base-content/60 mt-1">${(best.currentTotal / totalSales * 100).toFixed(1)}% {{ _('of total') }}</p>
        `;
    } else {
        document.getElementById('bestPerformer').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No data") }}</p>';
    }

    // Display Most Improved
    if (sortedByGrowth.length > 0) {
        const improved = sortedByGrowth[0];
        const arrow = improved.delta > 0 ? 'â†‘' : improved.delta < 0 ? 'â†“' : 'â†’';
        document.getElementById('mostImproved').innerHTML = `
            <p class="text-lg font-bold text-base-content">${improved.name}</p>
            <p class="text-xl font-bold font-mono text-green-600">${arrow} ${improved.delta > 0 ? '+' : ''}${improved.delta}%</p>
            <p class="text-sm text-base-content/60 mt-1">${getGrowthLabel(improved.delta)}</p>
        `;
    } else {
        document.getElementById('mostImproved').innerHTML = '<p class="text-sm text-base-content/60">{{ _("No comparison data") }}</p>';
    }

    // Display Needs Attention
    if (declining.length > 0) {
        const needsAttention = declining[0];
        document.getElementById('needsAttention').innerHTML = `
            <p class="text-lg font-bold text-base-content">${needsAttention.name}</p>
            <p class="text-xl font-bold font-mono text-orange-600">â†“ ${needsAttention.delta}%</p>
            <p class="text-sm text-base-content/60 mt-1">${getGrowthLabel(needsAttention.delta)}</p>
        `;
    } else {
        document.getElementById('needsAttention').innerHTML = '<p class="text-sm text-base-content/60">{{ _("All businesses stable") }}</p>';
    }

    // Stacked Bar Chart
    const stackedCtx = document.getElementById('stackedBarChart');
    if (stackedCtx && typeof Chart !== 'undefined') {
        const activeBusinesses = businesses.filter(b => b.currentTotal > 0);
        new Chart(stackedCtx, {
            type: 'bar',
            data: {
                labels: activeBusinesses.map(b => b.name),
                datasets: [
                    {
                        label: '{{ _("Cash") }}',
                        data: activeBusinesses.map(b => b.cashSales),
                        backgroundColor: 'rgb(34, 197, 94)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Cards") }}',
                        data: activeBusinesses.map(b => b.cardPayments),
                        backgroundColor: 'rgb(59, 130, 246)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Bank Transfer") }}',
                        data: activeBusinesses.map(b => b.bankTransfer),
                        backgroundColor: 'rgb(168, 85, 247)',
                        borderColor: 'rgb(168, 85, 247)',
                        borderWidth: 1
                    },
                    {
                        label: '{{ _("Credit Sales") }}',
                        data: activeBusinesses.map(b => b.creditSales),
                        backgroundColor: 'rgb(249, 115, 22)',
                        borderColor: 'rgb(249, 115, 22)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return 'Gs ' + (value / 1000000).toFixed(1) + 'M';
                                }
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // Contribution Donut Chart
    const donutCtx = document.getElementById('contributionDonutChart');
    if (donutCtx && typeof Chart !== 'undefined') {
        const activeBusinesses = businesses.filter(b => b.currentTotal > 0);
        const colors = [
            'rgb(99, 102, 241)',
            'rgb(34, 197, 94)',
            'rgb(249, 115, 22)',
            'rgb(236, 72, 153)',
            'rgb(168, 85, 247)',
            'rgb(59, 130, 246)',
            'rgb(251, 191, 36)',
            'rgb(20, 184, 166)',
            'rgb(239, 68, 68)',
            'rgb(107, 114, 128)'
        ];

        new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                labels: activeBusinesses.map(b => b.name),
                datasets: [{
                    data: activeBusinesses.map(b => b.currentTotal),
                    backgroundColor: colors.slice(0, activeBusinesses.length),
                    borderWidth: 2,
                    borderColor: 'rgb(255, 255, 255)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + formatCurrency(value) + ' (' + percent + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}
