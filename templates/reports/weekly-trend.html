<!-- File: templates/reports/weekly-trend.html -->
{% extends "base.html" %}

{% block title %}{{ _('Weekly Revenue Trend') }} - CashPilot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-primary/10 rounded-lg">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-base-content">{{ _('Weekly Revenue Trend') }}</h1>
                    <p class="text-xs md:text-sm text-base-content/60 mt-0.5">{{ _('Compare daily revenue across 7-day spans to identify peak/low days and week-over-week growth patterns') }}</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a id="switchToMonthly" href="#" class="btn btn-outline btn-sm gap-2 hidden">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                {{ _('View Monthly') }}
            </a>
            <a href="/reports" class="btn btn-outline btn-sm gap-2" data-back>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                {{ _('Back') }}
            </a>
        </div>
    </div>

    <!-- Controls Section -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-4">
        <!-- Business Selector (Most Important) -->
        <div class="mb-4">
            <label for="businessId" class="label py-1">
                <span class="label-text text-xs font-bold uppercase tracking-wider text-base-content/70">{{ _('Business') }}</span>
            </label>
            <select id="businessId" class="select select-bordered w-full focus:select-primary focus:ring-2 focus:ring-primary/20 transition-all" aria-label="{{ _('Select business to analyze') }}">
                <option value="">{{ _('Select Business') }}</option>
                {% for business in businesses %}
                <option value="{{ business.id }}">{{ business.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="divider my-3 text-xs text-base-content/50">{{ _('Select time period') }}</div>

        <!-- Selected Period Display -->
        <div id="selectedPeriodBanner" class="hidden mb-3 p-3 bg-info/10 border border-info/30 rounded-lg">
            <div class="flex items-center gap-2 text-sm">
                <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="font-medium text-info">{{ _('Viewing') }}:</span>
                <span id="selectedPeriodText" class="text-base-content font-semibold"></span>
            </div>
        </div>

        <!-- Quick Week Buttons -->
        <div class="flex flex-wrap gap-2 mb-4">
            <button class="btn btn-sm btn-outline quick-week-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="0" aria-label="{{ _('Show current week') }}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                {{ _('This Week') }}
            </button>
            <button class="btn btn-sm btn-outline quick-week-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="1" aria-label="{{ _('Show last week') }}">
                {{ _('Last Week') }}
            </button>
            <button class="btn btn-sm btn-outline quick-week-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="2" aria-label="{{ _('Show 2 weeks ago') }}">
                {{ _('2 Weeks Ago') }}
            </button>
            <button class="btn btn-sm btn-outline quick-week-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" data-offset="4" aria-label="{{ _('Show 4 weeks ago') }}">
                {{ _('Last Month') }}
            </button>
        </div>

        <!-- Custom Date Selector -->
        <details class="collapse collapse-arrow bg-base-200/50 rounded-lg border border-base-300">
            <summary class="collapse-title text-sm font-medium cursor-pointer hover:bg-base-200 transition-all">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>{{ _('Pick Custom Date') }}</span>
                </div>
            </summary>
            <div class="collapse-content pt-3">
                <div class="form-control">
                    <label for="reportDate" class="label py-1">
                        <span class="label-text text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Any date in the week') }}</span>
                    </label>
                    <input type="date" id="reportDate" class="input input-bordered w-full focus:input-primary focus:ring-2 focus:ring-primary/20 transition-all" aria-describedby="weekDisplay" />
                    <label class="label pt-2" id="week-display-container">
                        <span class="label-text-alt text-info font-medium flex items-center gap-1" id="weekDisplay">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ _('Select a date to see its week') }}
                        </span>
                    </label>
                </div>
            </div>
        </details>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden">
        <div class="flex items-center justify-center py-12">
            <div class="text-center">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="text-base-content/60 mt-4">{{ _('Loading report data...') }}</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
        <div class="alert alert-error shadow-lg">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <h3 class="font-bold">{{ _('Error Loading Report') }}</h3>
                    <div class="text-sm" id="errorMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div id="reportContent" class="hidden space-y-6">
        <!-- Summary Cards -->
        <div class="bg-gradient-to-br from-primary/5 to-base-100 border border-primary/20 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-2 text-sm text-base-content/70">
                <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ _('Line charts: revenue vs margin when cost data exists. Bar chart: 5-week revenue/margin trend.') }}</span>
            </div>
        </div>

        <div class="flex gap-4 overflow-x-auto pb-2">
            <!-- Highest Revenue Day -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Highest Revenue Day') }}</h3>
                </div>
                <p class="text-xl font-bold text-base-content truncate whitespace-nowrap" id="highestDay">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap" id="highestDayRevenue">-</p>
            </div>

            <!-- Lowest Revenue Day -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Lowest Revenue Day') }}</h3>
                </div>
                <p class="text-xl font-bold text-base-content truncate whitespace-nowrap" id="lowestDay">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap" id="lowestDayRevenue">-</p>
            </div>

            <!-- Week Total Sales -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Week Total') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums text-base-content" id="currentWeekTotal">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap">{{ _('Total sales this week') }}</p>
            </div>

            <!-- Week Cost -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Week Cost') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums text-base-content" id="currentWeekCost">-</p>
                <p class="text-sm text-base-content/60 mt-1 truncate whitespace-nowrap" id="currentWeekCostShare">-</p>
            </div>

            <!-- Week Margin -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Week Margin') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums text-base-content" id="currentWeekMargin">-</p>
                <p class="text-sm font-mono tabular-nums text-base-content/60 mt-1 truncate whitespace-nowrap" id="currentWeekMarginPct">-</p>
            </div>

            <!-- Week-over-Week Growth -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm min-w-[220px] flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <h3 class="font-semibold text-sm text-base-content/70 truncate">{{ _('Growth vs Previous') }}</h3>
                </div>
                <p class="text-xl md:text-2xl font-bold font-mono tabular-nums" id="weekGrowthPercent">-</p>
                <p class="text-sm font-mono tabular-nums text-base-content/60 mt-1 truncate whitespace-nowrap" id="weekGrowthDifference">-</p>
            </div>
        </div>

        <!-- Day Type Revenue Breakdown -->
        <div class="bg-base-100 border border-base-300 rounded-lg p-4 shadow-sm">
            <div class="flex items-center gap-2 mb-3">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <h3 class="font-semibold text-base">{{ _('Revenue by Day Type') }}</h3>
                <span class="text-xs text-base-content/60 ml-2">{{ _('Thu/Fri = 25% discount days | Closed Sundays') }}</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                <div class="text-center p-3 bg-base-200/50 rounded-lg">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ _('Regular Days') }}</div>
                    <div class="text-xs text-base-content/50 mb-2">{{ _('Mon, Tue, Wed') }}</div>
                    <div class="text-2xl font-bold font-mono tabular-nums text-base-content" id="regularDaysRevenue">-</div>
                    <div class="text-xs text-base-content/60 mt-1" id="regularDaysMeta">-</div>
                </div>
                <div class="text-center p-3 bg-warning/10 rounded-lg border border-warning/30">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ _('Discount Days') }}</div>
                    <div class="text-xs text-base-content/50 mb-2">{{ _('Thu, Fri (-25%)') }}</div>
                    <div class="text-2xl font-bold font-mono tabular-nums text-warning" id="discountDaysRevenue">-</div>
                    <div class="text-xs text-base-content/60 mt-1" id="discountDaysMeta">-</div>
                </div>
                <div class="text-center p-3 bg-success/10 rounded-lg border border-success/30">
                    <div class="text-sm font-medium text-base-content/70 mb-1">{{ _('Saturday') }}</div>
                    <div class="text-xs text-base-content/50 mb-2">{{ _('Weekend (full price)') }}</div>
                    <div class="text-2xl font-bold font-mono tabular-nums text-success" id="saturdayRevenue">-</div>
                    <div class="text-xs text-base-content/60 mt-1" id="saturdayMeta">-</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Running Total Progress Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">{{ _('Revenue Progress') }}</h2>
                    <div class="text-xs text-base-content/60">{{ _('Cumulative') }}</div>
                </div>
                <div class="relative" style="height: 280px;">
                    <canvas id="runningTotalChart"></canvas>
                </div>
            </div>

            <!-- Day-by-Day Comparison Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">{{ _('Day-by-Day Comparison') }}</h2>
                    <div class="text-xs text-base-content/60">{{ _('Current vs Previous') }}</div>
                </div>
                <div class="relative" style="height: 280px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Second Row: 3 Equal Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 5-Week Trend (Bar Chart) -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                    <h2 class="text-lg font-semibold mb-4">{{ _('5-Week Trend') }}</h2>
                    <div class="relative" style="height: 280px;">
                        <canvas id="trendChart"></canvas>
                    </div>
            </div>
            
            <!-- Payment Methods Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <h2 class="text-lg font-semibold mb-4">{{ _('Payment Methods') }}</h2>
                <div class="relative" style="height: 280px;">
                    <canvas id="paymentMethodsChart"></canvas>
                </div>
            </div>

            <!-- Day Type Revenue Chart -->
            <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
                <h2 class="text-lg font-semibold mb-4">{{ _('Revenue by Day Type') }}</h2>
                <div class="relative" style="height: 280px;">
                    <canvas id="dayTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Selected Week Details -->
        <div class="bg-base-100 border border-base-300 rounded-lg p-6 shadow-sm">
            <h2 class="text-lg font-semibold mb-4">{{ _('Selected Week Details') }}</h2>
            <div class="overflow-x-auto">
                <table class="table table-sm table-zebra w-full">
                    <thead>
                        <tr>
                            <th>{{ _('Day') }}</th>
                            <th>{{ _('Date') }}</th>
                            <th class="text-right">{{ _('Revenue') }}</th>
                            <th class="text-right">{{ _('Cost') }}</th>
                            <th class="text-right">{{ _('Margin') }}</th>
                            <th class="text-right">{{ _('Margin %') }}</th>
                            <th class="text-right">{{ _('WoW Growth') }}</th>
                            <th class="text-center">{{ _('Trend') }}</th>
                        </tr>
                    </thead>
                    <tbody id="currentWeekTable">
                        <!-- Dynamic rows -->
                    </tbody>
                    <tfoot>
                        <tr class="font-semibold">
                            <td>{{ _('Total') }}</td>
                            <td>-</td>
                            <td class="text-right font-mono" id="weekTotalRevenue">-</td>
                            <td class="text-right font-mono" id="weekTotalCost">-</td>
                            <td class="text-right font-mono" id="weekTotalMargin">-</td>
                            <td class="text-right font-mono" id="weekTotalMarginPct">-</td>
                            <td class="text-right font-mono" id="weekTotalGrowth">-</td>
                            <td class="text-center" id="weekTotalTrend">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous" onerror="console.error('Failed to load Chart.js from CDN')"></script>
<script src="/static/js/currency-formatter.js"></script>

<script>
    // Wait for Chart.js to load before initializing
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load from CDN');
    }
    
    let trendChart = null;

    // Format currency values (Gs 2.500.000 - dot separator, no decimals)
    const formatCurrency = (value) => {
        const num = Math.round(parseFloat(value));
        // es-PY uses comma, but we need dots per design system
        return 'Gs ' + num.toLocaleString('es-PY').replace(/,/g, '.');
    };

    const formatCompactCurrency = (value) => {
        const num = Math.round(parseFloat(value));
        if (!Number.isFinite(num)) {
            return '-';
        }
        const abs = Math.abs(num);
        let formatted = null;
        if (abs >= 1_000_000_000) {
            formatted = (num / 1_000_000_000).toFixed(2).replace(/\.0+$/, '').replace(/(\.\d)0$/, '$1') + 'B';
        } else if (abs >= 1_000_000) {
            formatted = (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
        } else if (abs >= 1_000) {
            formatted = (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
        } else {
            formatted = num.toString();
        }
        return 'Gs ' + formatted;
    };

    const parseNumber = (value) => {
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
    };

    const getCostValue = (day) => {
        if (day.cost_total === null || day.cost_total === undefined) {
            return null;
        }
        return parseNumber(day.cost_total);
    };

    const getTicketValue = (day) => {
        if (day.ticket_count === null || day.ticket_count === undefined) {
            return null;
        }
        const parsed = parseInt(day.ticket_count, 10);
        return Number.isFinite(parsed) ? parsed : null;
    };

    const getMarginValue = (day) => {
        if (!day.has_data) {
            return null;
        }
        const revenue = parseNumber(day.revenue);
        const cost = getCostValue(day);
        if (revenue === null || cost === null) {
            return null;
        }
        return revenue - cost;
    };

    const getCostCoverage = (weekDays) => {
        const daysWithData = weekDays.filter(day => day.has_data);
        const daysWithCost = daysWithData.filter(day => getCostValue(day) !== null);
        return {
            daysWithData,
            daysWithCost,
            isComplete: daysWithData.length > 0 && daysWithCost.length === daysWithData.length,
        };
    };

    const sumTickets = (weekDays) => (
        weekDays.reduce((sum, day) => sum + (getTicketValue(day) || 0), 0)
    );

    // Translate day names from English to Spanish
    const translateDayName = (dayName) => {
        const translations = {
            'Monday': '{{ _("Monday") }}',
            'Tuesday': '{{ _("Tuesday") }}',
            'Wednesday': '{{ _("Wednesday") }}',
            'Thursday': '{{ _("Thursday") }}',
            'Friday': '{{ _("Friday") }}',
            'Saturday': '{{ _("Saturday") }}',
            'Sunday': '{{ _("Sunday") }}'
        };
        return translations[dayName] || dayName;
    };

    const shortenDayName = (dayName) => {
        const shortTranslations = {
            'Monday': '{{ _("Mon") }}',
            'Tuesday': '{{ _("Tue") }}',
            'Wednesday': '{{ _("Wed") }}',
            'Thursday': '{{ _("Thu") }}',
            'Friday': '{{ _("Fri") }}',
            'Saturday': '{{ _("Sat") }}',
            'Sunday': '{{ _("Sun") }}'
        };
        return shortTranslations[dayName] || dayName;
    };

    // Calculate ISO week from date (parse date string to avoid timezone issues)
    function getISOWeek(dateStr) {
        // Parse YYYY-MM-DD string to avoid timezone issues
        const parts = dateStr.split('-');
        const d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
        d.setHours(0, 0, 0, 0);
        // Set to nearest Thursday (current date + 4 - current day number, making Sunday's day number 7)
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        // Get first day of year
        const yearStart = new Date(d.getFullYear(), 0, 1);
        // Calculate full weeks to nearest Thursday
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return { year: d.getFullYear(), week: weekNo };
    }

    // Format date range for week (parse date string to avoid timezone issues)
    function formatWeekRange(dateStr) {
        // Parse YYYY-MM-DD string to avoid timezone issues
        const parts = dateStr.split('-');
        const d = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
        
        // Get Monday of the week
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
        const monday = new Date(d.getFullYear(), d.getMonth(), diff);
        
        // Get Sunday
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        
        const formatDate = (date) => {
            const months = ['{{ _("Jan") }}', '{{ _("Feb") }}', '{{ _("Mar") }}', '{{ _("Apr") }}', '{{ _("May") }}', '{{ _("Jun") }}', 
                          '{{ _("Jul") }}', '{{ _("Aug") }}', '{{ _("Sep") }}', '{{ _("Oct") }}', '{{ _("Nov") }}', '{{ _("Dec") }}'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        };
        
        return `${formatDate(monday)} - ${formatDate(sunday)}`;
    }

    function formatShortDate(dateStr) {
        if (!dateStr) {
            return '-';
        }
        const parts = String(dateStr).split('-');
        if (parts.length !== 3) {
            return dateStr;
        }
        const months = ['{{ _("Jan") }}', '{{ _("Feb") }}', '{{ _("Mar") }}', '{{ _("Apr") }}', '{{ _("May") }}', '{{ _("Jun") }}',
                      '{{ _("Jul") }}', '{{ _("Aug") }}', '{{ _("Sep") }}', '{{ _("Oct") }}', '{{ _("Nov") }}', '{{ _("Dec") }}'];
        const day = parseInt(parts[2], 10);
        const monthIndex = parseInt(parts[1], 10) - 1;
        if (!Number.isFinite(day) || monthIndex < 0 || monthIndex >= months.length) {
            return dateStr;
        }
        return `${day} ${months[monthIndex]}`;
    }

    // Update week display when date changes
    function updateWeekDisplay() {
        const dateInput = document.getElementById('reportDate');
        const weekDisplay = document.getElementById('weekDisplay');
        
        if (dateInput.value) {
            const weekRange = formatWeekRange(dateInput.value);
            weekDisplay.textContent = `{{ _("Week of") }} ${weekRange}`;
        } else {
            weekDisplay.textContent = '{{ _("Select a date to see its week") }}';
        }
        updateSwitchToMonthlyLink();
    }

    function updateSwitchToMonthlyLink() {
        const switchLink = document.getElementById('switchToMonthly');
        if (!switchLink) {
            return;
        }
        const businessId = document.getElementById('businessId').value;
        const dateStr = document.getElementById('reportDate').value;
        if (!businessId || !dateStr) {
            switchLink.classList.add('hidden');
            switchLink.setAttribute('href', '#');
            return;
        }
        const parts = dateStr.split('-');
        if (parts.length !== 3) {
            switchLink.classList.add('hidden');
            switchLink.setAttribute('href', '#');
            return;
        }
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        if (!Number.isFinite(year) || !Number.isFinite(month)) {
            switchLink.classList.add('hidden');
            switchLink.setAttribute('href', '#');
            return;
        }
        switchLink.href = `/reports/monthly-trend?year=${year}&month=${month}&business_id=${businessId}`;
        switchLink.classList.remove('hidden');
    }

    // Initialize date picker with today (use local date to avoid timezone issues)
    function initializeDatePickers() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        document.getElementById('reportDate').value = dateStr;
        updateWeekDisplay();
    }

    // Date change handler
    document.getElementById('reportDate').addEventListener('change', () => {
        updateWeekDisplay();
        if (document.getElementById('businessId').value) {
            generateReport();
        }
    });

    // Business change handler - auto-generate
    document.getElementById('businessId').addEventListener('change', () => {
        updateSwitchToMonthlyLink();
        if (document.getElementById('businessId').value) {
            generateReport();
        }
    });

    // Quick week button handlers
    document.querySelectorAll('.quick-week-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.quick-week-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline');
            });
            
            // Add active class to clicked button
            btn.classList.remove('btn-outline');
            btn.classList.add('btn-primary');
            
            const offset = parseInt(btn.dataset.offset);
            // Use local date to avoid timezone issues
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            const targetDate = new Date(year, month, day - (offset * 7));
            // Format as YYYY-MM-DD for input[type="date"]
            const yearStr = targetDate.getFullYear();
            const monthStr = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(targetDate.getDate()).padStart(2, '0');
            const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
            document.getElementById('reportDate').value = dateStr;
            updateWeekDisplay();
            
            // Auto-generate if business is selected
            if (document.getElementById('businessId').value) {
                generateReport();
            }
        });
    });

    async function generateReport() {
        const businessId = document.getElementById('businessId').value;
        const dateStr = document.getElementById('reportDate').value;

        if (!businessId) {
            showError('{{ _("Please select a business") }}');
            return;
        }

        if (!dateStr) {
            showError('{{ _("Please select a date") }}');
            return;
        }

        // Calculate ISO week from date
        const { year, week } = getISOWeek(dateStr);

        // Update URL with parameters
        const newUrl = `${window.location.pathname}?year=${year}&week=${week}&business_id=${businessId}`;
        window.history.pushState({year, week, businessId}, '', newUrl);

        // Show loading state
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('errorState').classList.add('hidden');
        document.getElementById('reportContent').classList.add('hidden');

        try {
            const response = await fetch(
                `/reports/weekly-trend/data?year=${year}&week=${week}&business_id=${businessId}`,
                {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                    },
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to load report');
            }

            const data = await response.json();
            displayReport(data);
        } catch (error) {
            console.error('Error loading report:', error);
            showError(error.message);
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
        }
    }

    function displayReport(data) {
        // Update selected period banner
        const dateInput = document.getElementById('reportDate');
        if (dateInput.value) {
            const weekRange = formatWeekRange(dateInput.value);
            document.getElementById('selectedPeriodText').textContent = weekRange;
            document.getElementById('selectedPeriodBanner').classList.remove('hidden');
        }

        // Display summary cards
        const highestDayEl = document.getElementById('highestDay');
        const lowestDayEl = document.getElementById('lowestDay');
        
        const weekTotalValue = parseNumber(data.current_week_total) || 0;

        // Update highest day
        if (data.highest_day && data.highest_day.day_name) {
            highestDayEl.innerHTML = `<span class="font-bold">${translateDayName(data.highest_day.day_name)}</span> · <span class="font-normal text-base-content/60">${formatShortDate(data.highest_day.date)}</span>`;
            const highestShare = weekTotalValue > 0 ? (parseNumber(data.highest_day.revenue) / weekTotalValue) * 100 : null;
            const highestShareText = highestShare !== null ? ` · ${highestShare.toFixed(1)}%` : '';
            document.getElementById('highestDayRevenue').textContent = `${formatCompactCurrency(data.highest_day.revenue)}${highestShareText}`;
        } else {
            highestDayEl.textContent = '-';
            document.getElementById('highestDayRevenue').textContent = '-';
        }

        // Update lowest day
        if (data.lowest_day && data.lowest_day.day_name) {
            lowestDayEl.innerHTML = `<span class="font-bold">${translateDayName(data.lowest_day.day_name)}</span> · <span class="font-normal text-base-content/60">${formatShortDate(data.lowest_day.date)}</span>`;
            const lowestShare = weekTotalValue > 0 ? (parseNumber(data.lowest_day.revenue) / weekTotalValue) * 100 : null;
            const lowestShareText = lowestShare !== null ? ` · ${lowestShare.toFixed(1)}%` : '';
            document.getElementById('lowestDayRevenue').textContent = `${formatCompactCurrency(data.lowest_day.revenue)}${lowestShareText}`;
        } else {
            lowestDayEl.textContent = '-';
            document.getElementById('lowestDayRevenue').textContent = '-';
        }

        // Update week-over-week growth
        const currentWeekTotalEl = document.getElementById('currentWeekTotal');
        const growthPercentEl = document.getElementById('weekGrowthPercent');
        const growthDiffEl = document.getElementById('weekGrowthDifference');
        
        // Show current week total
        currentWeekTotalEl.textContent = formatCompactCurrency(data.current_week_total);

        // Week margin summary (uses cost data when available)
        const marginTotalEl = document.getElementById('currentWeekMargin');
        const marginPctEl = document.getElementById('currentWeekMarginPct');
        const weekCostEl = document.getElementById('currentWeekCost');
        const weekCostShareEl = document.getElementById('currentWeekCostShare');
        const costCoverage = getCostCoverage(data.current_week);

        if (costCoverage.daysWithData.length === 0) {
            marginTotalEl.textContent = '-';
            marginTotalEl.className = 'text-2xl font-bold font-mono tabular-nums text-base-content/60';
            marginPctEl.textContent = '{{ _("No data") }}';
            marginPctEl.className = 'text-sm font-mono tabular-nums text-base-content/60';
            weekCostEl.textContent = '-';
            weekCostEl.className = 'text-2xl font-bold font-mono tabular-nums text-base-content/60';
            weekCostShareEl.textContent = '{{ _("No data") }}';
            weekCostShareEl.className = 'text-sm text-base-content/60 mt-1';

        } else if (costCoverage.daysWithCost.length === 0) {
            marginTotalEl.textContent = '-';
            marginTotalEl.className = 'text-2xl font-bold font-mono tabular-nums text-base-content/60';
            marginPctEl.textContent = '{{ _("Cost data missing") }}';
            marginPctEl.className = 'text-sm font-mono tabular-nums text-warning/80';
            weekCostEl.textContent = '-';
            weekCostEl.className = 'text-2xl font-bold font-mono tabular-nums text-base-content/60';
            weekCostShareEl.textContent = '{{ _("Cost data missing") }}';
            weekCostShareEl.className = 'text-sm text-warning/80 mt-1';

        } else {
            const revenueWithCost = costCoverage.daysWithCost.reduce(
                (sum, day) => sum + parseNumber(day.revenue),
                0
            );
            const costTotal = costCoverage.daysWithCost.reduce(
                (sum, day) => sum + getCostValue(day),
                0
            );
            const marginTotal = revenueWithCost - costTotal;
            const marginPct = revenueWithCost > 0 ? (marginTotal / revenueWithCost) * 100 : null;
            const costRatio = revenueWithCost > 0 ? (costTotal / revenueWithCost) * 100 : null;
            const marginColor = marginTotal > 0 ? 'text-success' : marginTotal < 0 ? 'text-error' : 'text-base-content/60';

            marginTotalEl.textContent = formatCompactCurrency(marginTotal);
            marginTotalEl.className = `text-2xl font-bold font-mono tabular-nums ${marginColor}`;
            const marginPctText = marginPct !== null ? `${marginPct > 0 ? '+' : ''}${marginPct.toFixed(1)}%` : '-';
            marginPctEl.className = `text-sm font-mono tabular-nums ${marginColor}`;
            weekCostEl.textContent = formatCompactCurrency(costTotal);
            weekCostEl.className = 'text-2xl font-bold font-mono tabular-nums text-base-content';


            if (costCoverage.isComplete) {
                marginPctEl.textContent = `${marginPctText} · {{ _("Cost data complete") }}`;
                weekCostShareEl.textContent = costRatio !== null
                    ? `${costRatio.toFixed(1)}% {{ _("of sales") }}`
                    : '-';
                weekCostShareEl.className = 'text-sm text-base-content/60 mt-1';

            } else {
                marginPctEl.textContent = `${marginPctText} · {{ _("Cost data incomplete") }} (${costCoverage.daysWithCost.length}/${costCoverage.daysWithData.length})`;
                weekCostShareEl.textContent = '{{ _("Cost data incomplete") }}';
                weekCostShareEl.className = 'text-sm text-warning/80 mt-1';

            }
        }
        
        if (data.week_over_week_growth !== null && data.week_over_week_growth !== undefined) {
            const growth = parseFloat(data.week_over_week_growth);
            const isPositive = growth > 0;
            const isNegative = growth < 0;
            
            // Color and arrow based on growth
            const colorClass = isPositive ? 'text-success' : isNegative ? 'text-error' : 'text-base-content/60';
            const arrow = isPositive ? '↑' : isNegative ? '↓' : '→';
            
            growthPercentEl.className = `text-2xl font-bold font-mono tabular-nums ${colorClass}`;
            growthPercentEl.textContent = `${arrow} ${growth > 0 ? '+' : ''}${growth}%`;
            
            // Show difference
            const diff = parseFloat(data.week_over_week_difference);
            const diffText = diff > 0 ? `+${formatCompactCurrency(Math.abs(diff))}` : 
                            diff < 0 ? `-${formatCompactCurrency(Math.abs(diff))}` : 
                            formatCompactCurrency(0);
            growthDiffEl.className = `text-sm font-mono tabular-nums mt-1 ${colorClass}`;
            growthDiffEl.textContent = diffText;
        } else {
            growthPercentEl.className = 'text-2xl font-bold text-base-content/60';
            growthPercentEl.textContent = '-';
            growthDiffEl.textContent = '{{ _("No previous data") }}';
        }

        // Calculate day-type revenue breakdown
        let regularDaysRev = 0; // Mon, Tue, Wed
        let discountDaysRev = 0; // Thu, Fri (25% discount)
        let saturdayRev = 0; // Sat
        let regularDaysCost = 0;
        let discountDaysCost = 0;
        let saturdayCost = 0;
        let regularCostComplete = true;
        let discountCostComplete = true;
        let saturdayCostComplete = true;
        let regularTickets = 0;
        let discountTickets = 0;
        let saturdayTickets = 0;
        
        data.current_week.forEach(day => {
            if (!day.has_data) return;
            const dayNum = day.day_number; // 1=Mon, 2=Tue, ..., 7=Sun
            const revenue = parseFloat(day.revenue);
            const costValue = getCostValue(day);
            const ticketValue = getTicketValue(day);
            
            if (dayNum >= 1 && dayNum <= 3) { // Mon, Tue, Wed
                regularDaysRev += revenue;
                if (costValue === null) {
                    regularCostComplete = false;
                } else {
                    regularDaysCost += costValue;
                }
                if (ticketValue !== null) {
                    regularTickets += ticketValue;
                }
            } else if (dayNum === 4 || dayNum === 5) { // Thu, Fri
                discountDaysRev += revenue;
                if (costValue === null) {
                    discountCostComplete = false;
                } else {
                    discountDaysCost += costValue;
                }
                if (ticketValue !== null) {
                    discountTickets += ticketValue;
                }
            } else if (dayNum === 6) { // Sat
                saturdayRev += revenue;
                if (costValue === null) {
                    saturdayCostComplete = false;
                } else {
                    saturdayCost += costValue;
                }
                if (ticketValue !== null) {
                    saturdayTickets += ticketValue;
                }
            }
            // Sunday (7) is excluded - closed
        });
        
        const totalRev = regularDaysRev + discountDaysRev + saturdayRev;
        
        const buildMetaLine = (revenue, cost, costComplete, tickets) => {
            const percentText = totalRev > 0 ? `${((revenue / totalRev) * 100).toFixed(1)}% {{ _("of total") }}` : '-';
            const marginText = costComplete ? formatCurrency(revenue - cost) : '-';
            const ticketsText = tickets > 0 ? tickets.toLocaleString('es-PY') : '-';
            return `${percentText} · {{ _("Margin") }}: ${marginText} · {{ _("Tickets") }}: ${ticketsText}`;
        };

        document.getElementById('regularDaysRevenue').textContent = formatCurrency(regularDaysRev);
        document.getElementById('regularDaysMeta').textContent = buildMetaLine(
            regularDaysRev,
            regularDaysCost,
            regularCostComplete,
            regularTickets
        );
        
        document.getElementById('discountDaysRevenue').textContent = formatCurrency(discountDaysRev);
        document.getElementById('discountDaysMeta').textContent = buildMetaLine(
            discountDaysRev,
            discountDaysCost,
            discountCostComplete,
            discountTickets
        );
        
        document.getElementById('saturdayRevenue').textContent = formatCurrency(saturdayRev);
        document.getElementById('saturdayMeta').textContent = buildMetaLine(
            saturdayRev,
            saturdayCost,
            saturdayCostComplete,
            saturdayTickets
        );

        // Display current week table
        const tableBody = document.getElementById('currentWeekTable');
        tableBody.innerHTML = '';
        
        data.current_week.forEach(day => {
            const row = document.createElement('tr');
            
            const growthClass = day.growth_percent > 0 ? 'text-success' : 
                               day.growth_percent < 0 ? 'text-error' : 
                               'text-base-content/60';
            
            const growthText = day.growth_percent !== null ? 
                `${day.growth_percent > 0 ? '+' : ''}${day.growth_percent}%` : 
                '-';
            
            // Show dash if no data, currency if we have data
            const revenueDisplay = day.has_data ? formatCurrency(day.revenue) : '-';
            const revenueClass = day.has_data ? 'font-mono' : 'text-base-content/40';
            
            // Day name cell
            const dayCell = document.createElement('td');
            dayCell.className = 'font-medium';
            dayCell.textContent = translateDayName(day.day_name);
            row.appendChild(dayCell);
            
            // Date cell
            const dateCell = document.createElement('td');
            dateCell.textContent = day.date;
            row.appendChild(dateCell);
            
            // Revenue cell
            const revenueCell = document.createElement('td');
            revenueCell.className = `text-right ${revenueClass}`;
            revenueCell.textContent = revenueDisplay;
            row.appendChild(revenueCell);

            // Cost cell
            const costValue = getCostValue(day);
            const costDisplay = day.has_data && costValue !== null ? formatCurrency(costValue) : '-';
            const costCell = document.createElement('td');
            costCell.className = `text-right ${costValue !== null ? 'font-mono' : 'text-base-content/40'}`;
            costCell.textContent = costDisplay;
            row.appendChild(costCell);

            // Margin cell
            const marginValue = getMarginValue(day);
            const marginDisplay = day.has_data && marginValue !== null ? formatCurrency(marginValue) : '-';
            const marginColor = marginValue > 0 ? 'text-success' : marginValue < 0 ? 'text-error' : 'text-base-content/60';
            const marginCell = document.createElement('td');
            marginCell.className = `text-right font-mono ${marginValue !== null ? marginColor : 'text-base-content/40'}`;
            marginCell.textContent = marginDisplay;
            row.appendChild(marginCell);

            // Margin percent cell
            const revenueValue = day.has_data ? parseNumber(day.revenue) : null;
            const marginPct = revenueValue && marginValue !== null ? (marginValue / revenueValue) * 100 : null;
            const marginPctDisplay = marginPct !== null ? `${marginPct > 0 ? '+' : ''}${marginPct.toFixed(1)}%` : '-';
            const marginPctCell = document.createElement('td');
            marginPctCell.className = `text-right font-mono ${marginPct !== null ? marginColor : 'text-base-content/40'}`;
            marginPctCell.textContent = marginPctDisplay;
            row.appendChild(marginPctCell);
            
            // Growth percent cell
            const growthCell = document.createElement('td');
            growthCell.className = `text-right font-mono ${growthClass}`;
            growthCell.textContent = growthText;
            row.appendChild(growthCell);
            
            // Trend arrow cell
            const trendCell = document.createElement('td');
            trendCell.className = 'text-center text-lg';
            trendCell.textContent = day.trend_arrow || '';
            row.appendChild(trendCell);
            
            tableBody.appendChild(row);
        });

        // Footer totals
        const totalRevenue = data.current_week.reduce(
            (sum, day) => sum + (day.has_data ? parseNumber(day.revenue) : 0),
            0
        );
        const totalCost = costCoverage.isComplete
            ? costCoverage.daysWithCost.reduce((sum, day) => sum + getCostValue(day), 0)
            : null;
        const totalMargin = totalCost !== null ? totalRevenue - totalCost : null;
        const totalMarginPct = totalMargin !== null && totalRevenue > 0
            ? (totalMargin / totalRevenue) * 100
            : null;

        document.getElementById('weekTotalRevenue').textContent = totalRevenue > 0 ? formatCurrency(totalRevenue) : '-';
        document.getElementById('weekTotalCost').textContent = totalCost !== null ? formatCurrency(totalCost) : '-';
        document.getElementById('weekTotalMargin').textContent = totalMargin !== null ? formatCurrency(totalMargin) : '-';
        document.getElementById('weekTotalMarginPct').textContent = totalMarginPct !== null
            ? `${totalMarginPct > 0 ? '+' : ''}${totalMarginPct.toFixed(1)}%`
            : '-';
        const weekGrowthValue = parseNumber(data.week_over_week_growth);
        document.getElementById('weekTotalGrowth').textContent = weekGrowthValue !== null
            ? `${weekGrowthValue > 0 ? '+' : ''}${weekGrowthValue}%`
            : '-';
        const weekTrendArrow = weekGrowthValue > 0 ? '↑' : weekGrowthValue < 0 ? '↓' : '→';
        document.getElementById('weekTotalTrend').textContent = weekGrowthValue !== null
            ? weekTrendArrow
            : '-';

        // Create chart
        createChart(data);

        // Show report content
        document.getElementById('reportContent').classList.remove('hidden');
    }

    let comparisonChart = null;
    let runningTotalChart = null;
    let paymentMethodsChart = null;
    let dayTypeChart = null;
    let miniTrendChart = null;

    function createChart(data) {
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded. Cannot create charts.');
            showError('Chart library failed to load. Please refresh the page.');
            return;
        }
        
        // Chart 1: Running Total Progress (Cumulative)
        const runningTotalCtx = document.getElementById('runningTotalChart');
        
        if (runningTotalChart) {
            runningTotalChart.destroy();
        }

        // Generate labels and cumulative data
        const labels = ['{{ _("Mon") }}', '{{ _("Tue") }}', '{{ _("Wed") }}', '{{ _("Thu") }}', '{{ _("Fri") }}', '{{ _("Sat") }}', '{{ _("Sun") }}'];
        const currentCumulative = [];
        const previousCumulative = [];
        const currentMarginCumulative = [];
        const previousMarginCumulative = [];
        
        let currentSum = 0;
        data.current_week.forEach((day) => {
            if (day.has_data) {
                currentSum += parseFloat(day.revenue);
            }
            currentCumulative.push(currentSum);
        });
        
        // Get previous week cumulative
        let prevSum = 0;
        const previousWeek = data.previous_weeks && data.previous_weeks.length > 0 
            ? data.previous_weeks[data.previous_weeks.length - 1] 
            : null;
        
        if (previousWeek) {
            previousWeek.forEach((day) => {
                if (day.has_data) {
                    prevSum += parseFloat(day.revenue);
                }
                previousCumulative.push(prevSum);
            });
        }

        let currentMarginSum = 0;
        data.current_week.forEach((day) => {
            const marginValue = getMarginValue(day);
            if (marginValue === null) {
                currentMarginCumulative.push(null);
                return;
            }
            currentMarginSum += marginValue;
            currentMarginCumulative.push(currentMarginSum);
        });

        if (previousWeek) {
            let prevMarginSum = 0;
            previousWeek.forEach((day) => {
                const marginValue = getMarginValue(day);
                if (marginValue === null) {
                    previousMarginCumulative.push(null);
                    return;
                }
                prevMarginSum += marginValue;
                previousMarginCumulative.push(prevMarginSum);
            });
        }
        
        // Build datasets
        const datasetsRunning = [];
        
        if (previousWeek && previousCumulative.length > 0) {
            datasetsRunning.push({
                label: '{{ _("Last Week") }}',
                data: previousCumulative,
                borderColor: 'rgb(156, 163, 175)',
                backgroundColor: 'rgba(156, 163, 175, 0.05)',
                borderWidth: 2,
                tension: 0.2,
                pointRadius: 2,
                pointHoverRadius: 4,
                borderDash: [5, 5],
                fill: false,
            });
        }

        if (previousWeek && previousMarginCumulative.some(value => value !== null)) {
            datasetsRunning.push({
                label: '{{ _("Margin (Last Week)") }}',
                data: previousMarginCumulative,
                borderColor: 'rgb(22, 163, 74)',
                backgroundColor: 'rgba(22, 163, 74, 0.05)',
                borderWidth: 2,
                tension: 0.2,
                pointRadius: 2,
                pointHoverRadius: 4,
                borderDash: [4, 4],
                fill: false,
            });
        }
        
        datasetsRunning.push({
            label: '{{ _("This Week") }}',
            data: currentCumulative,
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            tension: 0.2,
            pointRadius: 3,
            pointHoverRadius: 5,
            fill: true,
        });

        if (currentMarginCumulative.some(value => value !== null)) {
            datasetsRunning.push({
                label: '{{ _("Margin (This Week)") }}',
                data: currentMarginCumulative,
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.08)',
                borderWidth: 2,
                tension: 0.2,
                pointRadius: 2,
                pointHoverRadius: 4,
                fill: false,
            });
        }
        
        runningTotalChart = new Chart(runningTotalCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasetsRunning
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y === null) {
                                    label += '{{ _("No data") }}';
                                } else {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
        
        // Chart 2: Week-over-Week Comparison (Current vs Previous week only)
        const comparisonCtx = document.getElementById('comparisonChart');
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }
        
        const previousMarginDaily = previousWeek ? previousWeek.map(day => getMarginValue(day)) : [];
        const currentMarginDaily = data.current_week.map(day => getMarginValue(day));

        // Build datasets array - only include previous week if data exists
        const datasets = [];
        
        if (previousWeek) {
            datasets.push({
                label: '{{ _("Last Week") }}',
                data: previousWeek.map(day => day.has_data ? parseFloat(day.revenue) : null),
                borderColor: 'rgb(156, 163, 175)', // Gray
                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                spanGaps: false,
                borderDash: [5, 5], // Dashed line
            });
        }
        
        datasets.push({
            label: '{{ _("This Week") }}',
            data: data.current_week.map(day => day.has_data ? parseFloat(day.revenue) : null),
            borderColor: 'rgb(99, 102, 241)', // Primary blue
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            spanGaps: false,
            fill: true,
        });

        if (previousWeek && previousMarginDaily.some(value => value !== null)) {
            datasets.push({
                label: '{{ _("Margin (Last Week)") }}',
                data: previousMarginDaily,
                borderColor: 'rgb(22, 163, 74)',
                backgroundColor: 'rgba(22, 163, 74, 0.05)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                spanGaps: false,
                borderDash: [4, 4],
            });
        }

        if (currentMarginDaily.some(value => value !== null)) {
            datasets.push({
                label: '{{ _("Margin (This Week)") }}',
                data: currentMarginDaily,
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.08)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                spanGaps: false,
                fill: false,
            });
        }
        
        comparisonChart = new Chart(comparisonCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y === null) {
                                    label += '{{ _("No data") }}';
                                } else {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });

        // Chart 2: 5-Week Trend (Revenue, cost, margin when available)
        const trendCtx = document.getElementById('trendChart');
        
        if (trendChart) {
            trendChart.destroy();
        }

        const weekLabels = [];
        const weekCostTotals = [];
        const weekMarginTotals = [];
        const weekRevenueFallback = [];
        const weekCostNotes = [];

        const pushWeekTotals = (weekDays, label) => {
            const costCoverage = getCostCoverage(weekDays);
            const revenueTotal = weekDays.reduce(
                (sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0),
                0
            );

            weekLabels.push(label);

            if (costCoverage.daysWithData.length === 0) {
                weekCostTotals.push(null);
                weekMarginTotals.push(null);
                weekRevenueFallback.push(null);
                weekCostNotes.push('{{ _("No data") }}');
                return;
            }

            if (!costCoverage.isComplete) {
                weekCostTotals.push(null);
                weekMarginTotals.push(null);
                weekRevenueFallback.push(revenueTotal);
                if (costCoverage.daysWithCost.length === 0) {
                    weekCostNotes.push('{{ _("Cost data missing") }}');
                } else {
                    weekCostNotes.push('{{ _("Cost data incomplete") }}');
                }
                return;
            }

            const costTotal = costCoverage.daysWithCost.reduce(
                (sum, day) => sum + getCostValue(day),
                0
            );
            const marginTotal = revenueTotal - costTotal;

            weekCostTotals.push(costTotal);
            weekMarginTotals.push(marginTotal);
            weekRevenueFallback.push(null);
            weekCostNotes.push('');
        };

        // Previous 4 weeks
        data.previous_weeks.forEach((week, index) => {
            pushWeekTotals(week, `{{ _("Wk") }} ${index + 1}`);
        });

        // Current week
        pushWeekTotals(data.current_week, '{{ _("Current") }}');

        const trendDatasets = [];

        if (weekCostTotals.some(value => value !== null)) {
            trendDatasets.push({
                label: '{{ _("Cost") }}',
                data: weekCostTotals,
                backgroundColor: 'rgba(248, 113, 113, 0.7)',
                borderColor: 'rgb(248, 113, 113)',
                borderWidth: 1,
                borderRadius: 6,
                stack: 'margin',
            });
        }

        if (weekMarginTotals.some(value => value !== null)) {
            trendDatasets.push({
                label: '{{ _("Margin") }}',
                data: weekMarginTotals,
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1,
                borderRadius: 6,
                stack: 'margin',
            });
        }

        if (weekRevenueFallback.some(value => value !== null)) {
            trendDatasets.push({
                label: '{{ _("Revenue") }}',
                data: weekRevenueFallback,
                backgroundColor: 'rgba(99, 102, 241, 0.4)',
                borderColor: 'rgb(99, 102, 241)',
                borderWidth: 2,
                borderRadius: 6,
                stack: 'revenue',
            });
        }

        trendChart = new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: trendDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y === null) {
                                    return `${context.dataset.label}: {{ _("No data") }}`;
                                }
                                return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                            }
                        },
                        afterBody: function(tooltipItems) {
                            if (!tooltipItems.length) {
                                return [];
                            }
                            const index = tooltipItems[0].dataIndex;
                            const note = weekCostNotes[index];
                            return note ? [note] : [];
                        },
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                        ticks: {
                            callback: function(value) {
                                // Shorten to millions if needed
                                if (value >= 1000000) {
                                    return 'Gs ' + (value / 1000000).toFixed(1) + 'M';
                                }
                                return formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Chart 3: Payment Methods Donut
        const paymentMethodsCtx = document.getElementById('paymentMethodsChart');
        
        if (paymentMethodsChart) {
            paymentMethodsChart.destroy();
        }
        
        // Use payment method totals from API
        const cashTotal = parseFloat(data.current_week_cash_total || 0);
        const cardTotal = parseFloat(data.current_week_card_total || 0);
        const bankTransferTotal = parseFloat(data.current_week_bank_transfer_total || 0);
        const creditTotal = parseFloat(data.current_week_credit_total || 0);
        
        paymentMethodsChart = new Chart(paymentMethodsCtx, {
            type: 'doughnut',
            data: {
                labels: ['{{ _("Cash") }}', '{{ _("Card") }}', '{{ _("Bank Transfer") }}', '{{ _("Credit Sales") }}'],
                datasets: [{
                    data: [cashTotal, cardTotal, bankTransferTotal, creditTotal],
                    backgroundColor: [
                        'rgb(34, 197, 94)',   // Green for cash
                        'rgb(59, 130, 246)',  // Blue for card
                        'rgb(168, 85, 247)',  // Purple for bank transfer
                        'rgb(249, 115, 22)'   // Orange for credit
                    ],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 255, 255)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${formatCurrency(value)} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Chart 4: Day Type Revenue Donut
        const dayTypeCtx = document.getElementById('dayTypeChart');
        
        if (dayTypeChart) {
            dayTypeChart.destroy();
        }
        
        // Calculate day type revenue
        let regularDaysRev = 0;
        let discountDaysRev = 0;
        let saturdayRev = 0;
        
        data.current_week.forEach(day => {
            if (!day.has_data) return;
            const dayNum = day.day_number;
            const revenue = parseFloat(day.revenue);
            
            if (dayNum >= 1 && dayNum <= 3) {
                regularDaysRev += revenue;
            } else if (dayNum === 4 || dayNum === 5) {
                discountDaysRev += revenue;
            } else if (dayNum === 6) {
                saturdayRev += revenue;
            }
        });
        
        dayTypeChart = new Chart(dayTypeCtx, {
            type: 'doughnut',
            data: {
                labels: ['{{ _("Regular Days") }}', '{{ _("Discount Days") }}', '{{ _("Saturday") }}'],
                datasets: [{
                    data: [regularDaysRev, discountDaysRev, saturdayRev],
                    backgroundColor: [
                        'rgb(99, 102, 241)',  // Primary/blue for regular
                        'rgb(251, 191, 36)',  // Warning/yellow for discount
                        'rgb(34, 197, 94)'    // Success/green for Saturday
                    ],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 255, 255)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${formatCurrency(value)} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Chart 5: Mini Trend Sparkline (for week-over-week card)
        const miniTrendCtx = document.getElementById('miniTrendChart');
        if (!miniTrendCtx) {
            return;
        }
        
        if (miniTrendChart) {
            miniTrendChart.destroy();
        }
        
        // Build 5-week data for sparkline
        const sparklineLabels = [];
        const sparklineRevenueData = [];
        const sparklineMarginData = [];
        
        // Previous weeks
        const getWeekRevenueTotal = (weekDays) => (
            weekDays.reduce((sum, day) => sum + (day.has_data ? parseFloat(day.revenue) : 0), 0)
        );

        const getWeekMarginTotal = (weekDays) => {
            const coverage = getCostCoverage(weekDays);
            if (!coverage.isComplete) {
                return null;
            }
            const revenueTotal = getWeekRevenueTotal(weekDays);
            const costTotal = coverage.daysWithCost.reduce(
                (sum, day) => sum + getCostValue(day),
                0
            );
            return revenueTotal - costTotal;
        };

        if (data.previous_weeks && data.previous_weeks.length > 0) {
            data.previous_weeks.forEach((weekData, index) => {
                sparklineLabels.push(`W${index + 1}`);
                sparklineRevenueData.push(getWeekRevenueTotal(weekData));
                sparklineMarginData.push(getWeekMarginTotal(weekData));
            });
        }
        
        // Current week for sparkline
        sparklineLabels.push('{{ _("Now") }}');
        sparklineRevenueData.push(getWeekRevenueTotal(data.current_week));
        sparklineMarginData.push(getWeekMarginTotal(data.current_week));
        
        miniTrendChart = new Chart(miniTrendCtx, {
            type: 'line',
            data: {
                labels: sparklineLabels,
                datasets: [
                    {
                        data: sparklineRevenueData,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.08)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        fill: true,
                    },
                    {
                        data: sparklineMarginData,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.05)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        spanGaps: false,
                        fill: false,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y === null) {
                                    return '{{ _("No data") }}';
                                }
                                return formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        display: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorState').classList.remove('hidden');
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('reportContent').classList.add('hidden');
    }


    // Initialize on load
    initializeDatePickers();
    
    // Auto-click "This Week" button on page load
    document.addEventListener('DOMContentLoaded', () => {
        const thisWeekBtn = document.querySelector('.quick-week-btn[data-offset="0"]');
        if (thisWeekBtn) {
            thisWeekBtn.classList.remove('btn-outline');
            thisWeekBtn.classList.add('btn-primary');
        }
    });
</script>
{% endblock %}
