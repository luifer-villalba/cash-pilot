<!-- File: templates/admin/users.html -->
{% extends "base.html" %}

{% block title %}{{ _('User Management - CashPilot') }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">{{ _('User Management') }}</h1>
        <div class="flex gap-2">
            {% if current_user.role == 'ADMIN' %}
            <button onclick="openCreateUserModal()" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                {{ _('Create User') }}
            </button>
            {% endif %}
            <a href="/dashboard" class="btn btn-outline">{{ _('Back to Dashboard') }}</a>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <!-- Search bar -->
            <div class="mb-4">
                <input
                        type="text"
                        id="user-search"
                        placeholder="{{ _('Search by name or email...') }}"
                        class="input input-bordered w-full max-w-xs"
                        oninput="filterUsers()"
                >
            </div>

            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                    <tr class="border-b-2 border-base-300">
                        <th class="bg-base-200">{{ _('Username') }}</th>
                        <th class="bg-base-200">{{ _('Email') }}</th>
                        <th class="bg-base-200">{{ _('Role') }}</th>
                        <th class="bg-base-200">{{ _('Status') }}</th>
                        <th class="bg-base-200 w-64">{{ _('Assigned Businesses') }}</th>
                        <th class="bg-base-200">{{ _('Created') }}</th>
                        <th class="bg-base-200 text-center">{{ _('Actions') }}</th>
                    </tr>
                    </thead>
                    <tbody id="users-table-body">
                    <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<dialog id="create-user-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-xl mb-4">{{ _('Create New User') }}</h3>

        <form id="create-user-form" class="space-y-4">
            <!-- Name Fields -->
            <div class="grid grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">{{ _('First Name') }} <span
                                class="text-error">*</span></span>
                    </label>
                    <input type="text" id="create-first-name" class="input input-bordered w-full" required>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">{{ _('Last Name') }} <span
                                class="text-error">*</span></span>
                    </label>
                    <input type="text" id="create-last-name" class="input input-bordered w-full" required>
                </div>
            </div>

            <!-- Email -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">{{ _('Email') }} <span class="text-error">*</span></span>
                </label>
                <input type="email" id="create-email" class="input input-bordered w-full" required>
            </div>

            <!-- Role -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">{{ _('Role') }} <span class="text-error">*</span></span>
                </label>
                <select id="create-role" class="select select-bordered w-full" required>
                    <option value="CASHIER">{{ _('Cashier') }}</option>
                    <option value="ADMIN">{{ _('Admin') }}</option>
                </select>
            </div>

            <!-- Password Options -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">{{ _('Password') }} <span class="text-error">*</span></span>
                </label>
                <div class="space-y-3">
                    <label class="label cursor-pointer justify-start gap-3 bg-base-200 p-3 rounded-lg">
                        <input type="radio" name="create-password-type" value="generate" class="radio radio-primary"
                               checked
                               onchange="toggleCreatePasswordInput(false)">
                        <span class="label-text">{{ _('Generate secure password') }}</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-3 bg-base-200 p-3 rounded-lg">
                        <input type="radio" name="create-password-type" value="custom" class="radio radio-primary"
                               onchange="toggleCreatePasswordInput(true)">
                        <span class="label-text">{{ _('Enter custom password') }}</span>
                    </label>
                </div>
                <input type="text" id="create-custom-password" class="input input-bordered w-full mt-3"
                       placeholder="{{ _('Enter custom password...') }}" disabled minlength="8">
            </div>

            <!-- Business Assignment -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">{{ _('Assign Businesses') }} <span class="text-gray-500">({{ _('Optional') }})</span></span>
                </label>
                <input type="text" id="create-business-search" placeholder="{{ _('Search businesses...') }}"
                       class="input input-bordered input-sm w-full mb-2" oninput="filterCreateBusinessCheckboxes()">
                <div id="create-business-checkbox-list"
                     class="border-2 border-base-300 rounded-lg p-3 max-h-60 overflow-y-auto bg-base-50">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </form>

        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="closeCreateUserModal()">{{ _('Cancel') }}</button>
            <button type="button" class="btn btn-primary" onclick="submitCreateUser()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                {{ _('Create User') }}
            </button>
        </div>
    </div>
</dialog>

<!-- Reset Password Modal -->
<dialog id="reset-password-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">{{ _('Reset Password') }}</h3>

        <div class="alert alert-info mb-4">
            <span>{{ _('Resetting password for') }} <strong id="reset-username"></strong></span>
        </div>

        <div class="form-control mb-4">
            <label class="label cursor-pointer justify-start gap-3">
                <input type="radio" name="reset-type" class="radio radio-primary" value="generate" checked
                       onchange="document.getElementById('custom-password').disabled = true; document.getElementById('custom-password').value = '';">
                <span class="label-text">{{ _('Generate secure password') }}</span>
            </label>
        </div>

        <div class="form-control mb-4">
            <label class="label cursor-pointer justify-start gap-3">
                <input type="radio" name="reset-type" class="radio radio-primary" value="custom"
                       onchange="document.getElementById('custom-password').disabled = false; document.getElementById('custom-password').focus();">
                <span class="label-text">{{ _('Enter custom password') }}</span>
            </label>
        </div>

        <div class="form-control">
            <label class="label">
                <span class="label-text font-semibold">{{ _('New Password') }}</span>
            </label>
            <input type="text" id="custom-password" class="input input-bordered w-full"
                   placeholder="Enter password..." disabled minlength="8">
            <label class="label">
                <span class="label-text-alt">{{ _('Minimum 8 characters') }}</span>
            </label>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="closeResetPasswordModal()">{{ _('Cancel') }}</button>
            <button type="button" class="btn btn-primary"
                    onclick="submitPasswordReset(document.querySelector('input[name=reset-type]:checked').value === 'generate')">
                {{ _('Reset Password') }}
            </button>
        </div>
    </div>
</dialog>

<!-- Generated Password Display Modal -->
<dialog id="generated-password-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">{{ _('Password Reset Successful') }}</h3>

        <div class="alert alert-success mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                 viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>{{ _('New password generated for') }} <strong id="pwd-username"></strong></span>
        </div>

        <div class="form-control">
            <label class="label">
                <span class="label-text font-semibold">{{ _('New Password') }}</span>
            </label>
            <div class="join w-full">
                <input type="text" id="generated-password-display"
                       class="input input-bordered join-item flex-1 font-mono" readonly>
                <button type="button" class="btn btn-primary join-item" onclick="copyPassword(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    {{ _('Copy') }}
                </button>
            </div>
            <label class="label">
                <span class="label-text-alt flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    {{ _('Save this password - it won\'t be shown again') }}
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-primary" onclick="closeGeneratedPasswordModal()">{{ _('Done') }}
            </button>
        </div>
    </div>
</dialog>

<!-- Assign Businesses Modal -->
<dialog id="assign-businesses-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-xl mb-4">{{ _('Assign Businesses') }}</h3>

        <div class="bg-base-200 rounded-lg p-4 mb-4 border-l-4 border-primary">
            <p class="text-sm text-gray-600">{{ _('Assigning businesses to') }}</p>
            <p class="font-bold text-lg" id="assign-username"></p>
        </div>

        <div class="form-control mb-3">
            <input type="text" id="business-search" placeholder="{{ _('Search businesses...') }}"
                   class="input input-bordered w-full" oninput="filterBusinessCheckboxes()">
        </div>

        <div class="form-control">
            <div class="flex justify-between items-center mb-2">
                <span class="label-text font-semibold">{{ _('Select Businesses') }}</span>
                <div class="flex gap-2">
                    <button type="button" class="btn btn-xs btn-ghost" onclick="selectAllBusinesses()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        {{ _('All') }}
                    </button>
                    <button type="button" class="btn btn-xs btn-ghost" onclick="deselectAllBusinesses()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        {{ _('None') }}
                    </button>
                </div>
            </div>

            <div id="business-checkbox-list"
                 class="border-2 border-base-300 rounded-lg p-3 max-h-96 overflow-y-auto bg-base-50">
                <!-- Populated by JavaScript -->
            </div>

            <div class="label">
                <span class="label-text-alt" id="selected-count">0 {{ _('selected') }}</span>
            </div>
        </div>

        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="closeAssignBusinessesModal()">{{ _('Cancel') }}
            </button>
            <button type="button" class="btn btn-primary" onclick="submitAssignBusinesses()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                {{ _('Save') }}
            </button>
        </div>
    </div>
</dialog>

<script>
    const i18n = {
        loadingError: "{{ _('Failed to load users') }}",
        resetError: "{{ _('Reset failed') }}",
        operationError: "{{ _('Operation failed') }}",
        resetSuccess: "{{ _('Password reset successfully') }}",
        businessesUpdated: "{{ _('Businesses assigned successfully') }}",
        businessRemoved: "{{ _('Business unassigned successfully') }}",
        confirmDisable: "{{ _('Are you sure you want to disable this user?') }}",
        confirmEnable: "{{ _('Are you sure you want to enable this user?') }}",
        admin: "{{ _('Admin') }}",
        active: "{{ _('Active') }}",
        disabled: "{{ _('Disabled') }}",
        resetPassword: "{{ _('Reset Password') }}",
        assignBusinesses: "{{ _('Assign Businesses') }}",
        disable: "{{ _('Disable') }}",
        enable: "{{ _('Enable') }}",
        copied: '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> {{ _("Copied!") }}',
        noBusinesses: "{{ _('No businesses assigned') }}",
        selected: "{{ _('selected') }}",
        assigned: "{{ _('Assigned') }}",
        cannotDisableSelf: "{{ _('You cannot disable yourself') }}",
        userCreated: "{{ _('User created successfully') }}",
        emailAlreadyExists: "{{ _('Email already registered') }}",
        passwordTooShort: "{{ _('Password must be at least 8 characters') }}",
        createError: "{{ _('Failed to create user') }}",
        fillRequired: "{{ _('Please fill all required fields') }}",
        currentUser: "{{ _('(You)') }}",
        adminRole: "{{ _('ADMIN') }}",
        cashierRole: "{{ _('CASHIER') }}"
    };

    let allBusinesses = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadBusinesses();
        await loadUsers();
    });

    async function loadBusinesses() {
        try {
            const response = await fetch('/admin/businesses');
            const data = await response.json();
            allBusinesses = data.businesses;
        } catch (error) {
            allBusinesses = [];
        }
    }

    async function loadUsers() {
        try {
            const response = await fetch('/admin/users');
            const data = await response.json();

            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = data.users.map(user => {
                const isCurrentUser = user.email === '{{ current_user.email }}';

                return `
        <tr>
            <td>
                <div class="flex items-center gap-2">
                    <span class="font-medium">${user.username}</span>
                    ${user.role === 'ADMIN'
                    ? `<span class="badge badge-sm bg-purple-100 text-purple-700 border-purple-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            ${i18n.admin}
                        </span>`
                    : ''
                }
                    ${isCurrentUser ? `<span class="badge badge-sm badge-info">${i18n.currentUser}</span>` : ''}
                </div>
            </td>
            <td class="text-gray-600">${user.email || '-'}</td>
            <td>
                ${user.role === 'ADMIN'
                    ? `<span class="badge bg-purple-500 text-white border-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        ${i18n.adminRole}
                    </span>`
                    : `<span class="badge bg-blue-100 text-blue-700 border-blue-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        ${i18n.cashierRole}
                    </span>`
                }
            </td>
            <td>
                ${user.is_active
                    ? `<span class="badge bg-green-100 text-green-700 border-green-300 gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ${i18n.active}
                    </span>`
                    : `<span class="badge bg-red-100 text-red-700 border-red-300 gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ${i18n.disabled}
                    </span>`
                }
            </td>
            <td>
                <div class="flex flex-col gap-1 max-w-xs">
                    ${user.businesses.length > 0
                    ? user.businesses.map(b => `
                            <span class="badge badge-sm gap-1 w-full justify-between ${b.is_active ? 'bg-gray-100 text-gray-700 border-gray-300' : 'bg-orange-100 text-orange-700 border-orange-300'}">
                                <span class="truncate flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    ${b.name}
                                </span>
                                <button
                                    class="btn btn-xs btn-ghost btn-circle p-0 h-4 w-4 min-h-0 flex-shrink-0 hover:bg-red-100 hover:text-red-600"
                                    onclick="unassignBusiness('${user.id}', '${b.id}')"
                                    title="Remove"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </span>
                        `).join('')
                    : `<span class="text-gray-400 text-sm italic flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            ${i18n.noBusinesses}
                        </span>`
                }
                </div>
            </td>
            <td class="text-gray-600">${new Date(user.created_at).toLocaleDateString()}</td>
            <td class="text-center">
                <div class="flex gap-2 justify-center">
                    <button
                        class="btn btn-sm btn-ghost tooltip tooltip-top hover:bg-gray-100"
                        data-tip="${i18n.resetPassword}"
                        onclick="openResetPasswordModal('${user.id}', '${user.username}')"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                        </svg>
                    </button>
                    <button
                        class="btn btn-sm btn-primary tooltip tooltip-top"
                        data-tip="${i18n.assignBusinesses}"
                        onclick="openAssignBusinessesModal('${user.id}', '${user.username}', ${JSON.stringify(user.businesses).replace(/"/g, '&quot;')})"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </button>
                    ${isCurrentUser
                    ? `<button class="btn btn-sm btn-disabled tooltip tooltip-top" data-tip="${i18n.cannotDisableSelf}" disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </button>`
                    : `<button
                            class="btn btn-sm ${user.is_active ? 'btn-warning hover:btn-error' : 'btn-success'} tooltip tooltip-top"
                            data-tip="${user.is_active ? i18n.disable : i18n.enable}"
                            onclick="toggleUserActive('${user.id}', ${!user.is_active})"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${user.is_active ? 'M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z' : 'M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z'}" />
                            </svg>
                        </button>`
                }
                </div>
            </td>
        </tr>
    `;
            }).join('');

            // Reinitialize DaisyUI tooltips after DOM update
            setTimeout(() => {
                document.querySelectorAll('[data-tip]').forEach(el => {
                    if (!el.classList.contains('tooltip')) {
                        el.classList.add('tooltip');
                    }
                });
            }, 50);
        } catch (error) {
            alert(i18n.loadingError);
        }
    }

    // ===== CREATE USER MODAL =====
    function openCreateUserModal() {
        document.getElementById('create-user-form').reset();
        document.getElementById('create-custom-password').disabled = true;

        // Populate business checkboxes
        const container = document.getElementById('create-business-checkbox-list');
        container.innerHTML = allBusinesses.map(b => `
            <label class="label cursor-pointer justify-start gap-3 hover:bg-base-200 rounded-lg px-3 py-2">
                <input type="checkbox" class="checkbox checkbox-primary create-business-checkbox" value="${b.id}">
                <span class="label-text">${b.name}</span>
            </label>
        `).join('');

        document.getElementById('create-user-modal').showModal();
    }

    function closeCreateUserModal() {
        document.getElementById('create-user-modal').close();
    }

    function toggleCreatePasswordInput(enabled) {
        const input = document.getElementById('create-custom-password');
        input.disabled = !enabled;
        if (enabled) input.focus();
        else input.value = '';
    }

    function filterCreateBusinessCheckboxes() {
        const search = document.getElementById('create-business-search').value.toLowerCase();
        const labels = document.querySelectorAll('#create-business-checkbox-list label');
        labels.forEach(label => {
            const text = label.textContent.toLowerCase();
            label.style.display = text.includes(search) ? '' : 'none';
        });
    }

    async function submitCreateUser() {
        const firstName = document.getElementById('create-first-name').value.trim();
        const lastName = document.getElementById('create-last-name').value.trim();
        const email = document.getElementById('create-email').value.trim();
        const role = document.getElementById('create-role').value;
        const isGenerate = document.querySelector('input[name="create-password-type"]:checked').value === 'generate';
        const customPassword = document.getElementById('create-custom-password').value;

        if (!firstName || !lastName || !email || !role) {
            alert(i18n.fillRequired);
            return;
        }

        if (!isGenerate && customPassword.length < 8) {
            alert(i18n.passwordTooShort);
            return;
        }

        const checkboxes = document.querySelectorAll('.create-business-checkbox:checked');
        const businessIds = Array.from(checkboxes).map(cb => cb.value);

        try {
            // Send everything in body, not query params
            const response = await fetch('/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user: {
                        email,
                        password: isGenerate ? null : customPassword,
                        first_name: firstName,
                        last_name: lastName,
                        role
                    },
                    business_ids: businessIds.length > 0 ? businessIds : null
                })
            });

            if (!response.ok) {
                const error = await response.json();

                if (error.detail === 'Email already registered') {
                    alert(i18n.emailAlreadyExists);
                } else {
                    alert(`Error: ${JSON.stringify(error.detail || error)}`);
                    throw new Error(error.detail || 'Failed to create user');
                }
                return;
            }

            const data = await response.json();

            if (data.generated_password) {
                document.getElementById('pwd-username').textContent = `${firstName} ${lastName}`;
                document.getElementById('generated-password-display').value = data.generated_password;
                document.getElementById('generated-password-modal').showModal();
            } else {
                alert(i18n.userCreated);
            }

            closeCreateUserModal();
            await loadUsers();
        } catch (error) {
            alert(i18n.createError);
        }
    }

    // ===== SEARCH & FILTER =====
    function filterUsers() {
        const search = document.getElementById('user-search').value.toLowerCase();
        const rows = document.querySelectorAll('#users-table-body tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function filterBusinessCheckboxes() {
        const search = document.getElementById('business-search').value.toLowerCase();
        const labels = document.querySelectorAll('#business-checkbox-list label');
        labels.forEach(label => {
            const name = label.getAttribute('data-business-name');
            label.style.display = name.includes(search) ? '' : 'none';
        });
    }

    function updateSelectedCount() {
        const checked = document.querySelectorAll('.business-checkbox:checked').length;
        const total = document.querySelectorAll('.business-checkbox').length;
        document.getElementById('selected-count').textContent = `${checked} de ${total} ${i18n.selected}`;
    }

    // ===== ASSIGN BUSINESSES MODAL =====
    let currentAssignUserId = null;

    function openAssignBusinessesModal(userId, username, currentBusinesses) {
        currentAssignUserId = userId;
        document.getElementById('assign-username').textContent = username;

        const currentIds = currentBusinesses.map(b => b.id);
        const container = document.getElementById('business-checkbox-list');

        container.innerHTML = allBusinesses.map((b) => `
        <label class="label cursor-pointer justify-start gap-3 hover:bg-base-200 rounded-lg px-3 py-3 transition-colors border border-transparent hover:border-base-300" data-business-name="${b.name.toLowerCase()}">
            <input type="checkbox" class="checkbox checkbox-primary business-checkbox" value="${b.id}"
                ${currentIds.includes(b.id) ? 'checked' : ''} onchange="updateSelectedCount()">
            <span class="label-text flex-1 font-medium">${b.name}</span>
            ${currentIds.includes(b.id) ? `<span class="badge badge-sm badge-primary">${i18n.assigned}</span>` : ''}
        </label>
    `).join('');

        updateSelectedCount();
        document.getElementById('business-search').value = '';
        document.getElementById('assign-businesses-modal').showModal();
    }

    function closeAssignBusinessesModal() {
        document.getElementById('assign-businesses-modal').close();
        currentAssignUserId = null;
    }

    async function submitAssignBusinesses() {
        const checkboxes = document.querySelectorAll('.business-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);

        try {
            const response = await fetch(`/admin/users/${currentAssignUserId}/businesses`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({business_ids: selectedIds}),
            });

            if (!response.ok) throw new Error('Failed to assign businesses');

            alert(i18n.businessesUpdated);
            closeAssignBusinessesModal();
            await loadUsers();
        } catch (error) {
            alert(i18n.operationError);
        }
    }

    function selectAllBusinesses() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.business-checkbox'))
            .filter(cb => cb.closest('label').style.display !== 'none');
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateSelectedCount();
    }

    function deselectAllBusinesses() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.business-checkbox'))
            .filter(cb => cb.closest('label').style.display !== 'none');
        visibleCheckboxes.forEach(cb => cb.checked = false);
        updateSelectedCount();
    }

    async function unassignBusiness(userId, businessId) {
        try {
            const response = await fetch(`/admin/users/${userId}/businesses/${businessId}`, {
                method: 'DELETE',
            });

            if (!response.ok) throw new Error('Failed to unassign business');

            alert(i18n.businessRemoved);
            await loadUsers();
        } catch (error) {
            alert(i18n.operationError);
        }
    }

    // ===== RESET PASSWORD MODAL =====
    let currentResetUserId = null;
    let currentResetUsername = null;

    function openResetPasswordModal(userId, username) {
        currentResetUserId = userId;
        currentResetUsername = username;
        document.getElementById('reset-username').textContent = username;
        document.getElementById('custom-password').value = '';
        document.getElementById('reset-password-modal').showModal();
    }

    function closeResetPasswordModal() {
        document.getElementById('reset-password-modal').close();
        currentResetUserId = null;
        currentResetUsername = null;
    }

    async function submitPasswordReset(generate = false) {
        const customPassword = document.getElementById('custom-password').value;

        if (!generate && !customPassword) {
            alert('Please enter a password or choose to generate one');
            return;
        }

        try {
            const response = await fetch(`/admin/users/${currentResetUserId}/reset-password`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    generate: generate,
                    new_password: generate ? null : customPassword,
                }),
            });

            if (!response.ok) throw new Error('Failed to reset password');

            const data = await response.json();

            if (data.new_password) {
                document.getElementById('pwd-username').textContent = currentResetUsername;
                document.getElementById('generated-password-display').value = data.new_password;
                document.getElementById('generated-password-modal').showModal();
            } else {
                alert(i18n.resetSuccess);
            }

            closeResetPasswordModal();
            await loadUsers();
        } catch (error) {
            alert(i18n.resetError);
        }
    }

    function closeGeneratedPasswordModal() {
        document.getElementById('generated-password-modal').close();
    }

    async function copyPassword(event) {
        const input = document.getElementById('generated-password-display');
        await navigator.clipboard.writeText(input.value);

        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = i18n.copied;
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 2000);
    }

    // ===== TOGGLE ACTIVE STATUS =====
    async function toggleUserActive(userId, newStatus) {
        const confirmMsg = newStatus ? i18n.confirmEnable : i18n.confirmDisable;
        if (!confirm(confirmMsg)) return;

        try {
            const response = await fetch(`/admin/users/${userId}/toggle-active`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({is_active: newStatus}),
            });

            if (!response.ok) throw new Error('Failed to toggle user status');

            await loadUsers();
        } catch (error) {
            alert(i18n.operationError);
        }
    }

    window.addEventListener('error', (e) => {
        // Suppress DaisyUI tooltip initialization errors
        if (e.message && e.message.includes('dataset')) {
            e.preventDefault();
            return true;
        }
    });
</script>
{% endblock %}