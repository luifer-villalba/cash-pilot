<!-- File: templates/admin/reconciliation_compare.html -->
{% extends "base.html" %}

{% block title %}{{ _('Daily Reconciliation Comparison') }} - CashPilot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg border border-primary/20 shadow-sm">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-base-content">{{ _('Daily Reconciliation Comparison') }}</h1>
                    <p class="text-xs md:text-sm text-base-content/60 mt-0.5">{{ _('Compare system entries vs manual records') }}</p>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/reconciliation/daily?date={{ comparison_date.isoformat() }}" class="btn btn-outline btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                {{ _('Edit Entries') }}
            </a>
            <a href="/" class="btn btn-outline btn-sm gap-2" data-back>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                {{ _('Back to Dashboard') }}
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-4">
        <form method="get" action="/admin/reconciliation/compare" id="filter-form">
            <!-- Business Selector (Most Important - Full Width) -->
            <div class="mb-4">
                <label for="business_id" class="label py-1">
                    <span class="label-text text-xs font-bold uppercase tracking-wider text-base-content/70">{{ _('Business') }}</span>
                </label>
                <select
                    id="business_id"
                    name="business_id"
                    class="select select-bordered w-full focus:select-primary focus:ring-2 focus:ring-primary/20 transition-all"
                    aria-label="{{ _('Select business to analyze') }}"
                >
                    <option value="">{{ _('All Businesses') }}</option>
                    {% for business in businesses %}
                    <option value="{{ business.id }}" {% if selected_business_id == business.id|string %}selected{% endif %}>
                        {{ business.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="divider my-3 text-xs text-base-content/50">{{ _('Select date') }}</div>

            <!-- Selected Period Banner -->
            <div id="selectedPeriodBanner" class="mb-3 p-3 bg-info/10 border border-info/30 rounded-lg">
                <div class="flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="font-medium text-info">{{ _('Viewing') }}:</span>
                    <span id="selectedPeriodText" class="text-base-content font-semibold">{{ comparison_date.strftime('%B %d, %Y') if comparison_date else '' }}</span>
                </div>
            </div>

            <!-- Quick Action Buttons (First button with icon, starts as btn-outline) -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="0" 
                    aria-label="{{ _('Select today') }}"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    {{ _('Today') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="1" 
                    aria-label="{{ _('Select yesterday') }}"
                >
                    {{ _('Yesterday') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="2" 
                    aria-label="{{ _('Select 2 days ago') }}"
                >
                    {{ _('2 Days Ago') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="7" 
                    aria-label="{{ _('Select 7 days ago') }}"
                >
                    {{ _('7 Days Ago') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="30" 
                    aria-label="{{ _('Select 30 days ago') }}"
                >
                    {{ _('30 Days Ago') }}
                </button>
            </div>

            <!-- Custom Date Selector (Collapsed by Default) -->
            <details class="collapse collapse-arrow bg-base-200/50 rounded-lg border border-base-300">
                <summary class="collapse-title text-sm font-medium cursor-pointer hover:bg-base-200 transition-all">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>{{ _('Pick Custom Date') }}</span>
                    </div>
                </summary>
                <div class="collapse-content pt-3">
                    <div class="form-control">
                        <label for="date" class="label py-1">
                            <span class="label-text text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Date') }}</span>
                        </label>
                        <input
                            type="date"
                            name="date"
                            id="date"
                            value="{{ comparison_date.isoformat() }}"
                            class="input input-bordered w-full focus:input-primary focus:ring-2 focus:ring-primary/20 transition-all"
                            aria-describedby="date-help"
                        />
                        <label class="label pt-2" id="date-help-container">
                            <span class="label-text-alt text-info font-medium flex items-center gap-1" id="date-help">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                {{ _('Select a date to compare reconciliation data') }}
                            </span>
                        </label>
                    </div>
                </div>
            </details>
        </form>
    </div>

    <!-- Comparison Results (Auto-refreshed via HTMX) -->
    <div
        id="comparison-results"
        hx-get="/admin/reconciliation/compare-results?date={{ comparison_date.isoformat() }}{% if selected_business_id %}&business_id={{ selected_business_id }}{% endif %}"
        hx-trigger="load, every 45s"
        hx-swap="innerHTML"
        aria-live="polite"
        aria-busy="false"
        class="space-y-8 htmx-settling"
    >
        <!-- Content will be loaded via HTMX -->
        <div class="text-center py-12">
            <div class="flex flex-col items-center justify-center gap-3">
                <span class="loading loading-spinner loading-lg"></span>
                <span class="text-sm text-base-content/60">{{ _('Loading comparison data') }}...</span>
            </div>
        </div>
    </div>
    <!-- Margin Comparison Table -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm">
        <div class="px-4 pt-4">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-gradient-to-br from-info/10 to-info/5 rounded-lg border border-info/20 shadow-sm">
                    <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M9 17V9m4 8V5m4 12v-6"/>
                    </svg>
                </div>
                <div>
                    <h2 class="text-base md:text-lg font-semibold text-base-content">{{ _('Margin Comparison') }}</h2>
                    <p class="text-xs text-base-content/60">{{ _('Sales vs daily cost totals by business') }}</p>
                </div>
            </div>
        </div>
        <!-- Mobile Cards (visible on mobile only) -->
        <div class="lg:hidden px-4 pb-4 space-y-4">
            {% set totals = namespace(system_sales=0, manual_sales=0, cost=0, gross_margin=0, has_any=false) %}
            {% for item in comparison_data %}
            {% set manual_sales = item.manual.total_sales if item.manual and item.manual.total_sales is not none else none %}
            {% set system_sales = item.system.total_sales if item.system and item.system.total_sales is not none else none %}
            {% set cost_total = item.manual_entry.daily_cost_total if item.manual_entry and item.manual_entry.daily_cost_total is not none else none %}
            {% if manual_sales is not none and cost_total is not none %}
            {% set gross_margin = manual_sales - cost_total %}
            {% if manual_sales != 0 %}
            {% set margin_pct = (gross_margin / manual_sales) * 100 %}
            {% set cost_pct = (cost_total / manual_sales) * 100 %}
            {% else %}
            {% set margin_pct = none %}
            {% set cost_pct = none %}
            {% endif %}
            {% else %}
            {% set gross_margin = none %}
            {% set margin_pct = none %}
            {% set cost_pct = none %}
            {% endif %}
            {% if manual_sales is not none %}
            {% set totals.manual_sales = totals.manual_sales + manual_sales %}
            {% set totals.has_any = true %}
            {% endif %}
            {% if manual_sales is not none and cost_total is not none %}
            {% set totals.cost = totals.cost + cost_total %}
            {% set totals.gross_margin = totals.gross_margin + gross_margin %}
            {% set totals.has_any = true %}
            {% endif %}
            <div class="border border-base-300 rounded-lg p-4 bg-base-100{% if item.status == 'Needs Review' %} border-warning bg-base-200/40{% endif %}">
                <div class="font-semibold text-base-content">{{ item.business.name }}</div>
                <div class="mt-3 grid grid-cols-1 gap-2 text-xs">
                    <div class="rounded-lg border border-base-200 p-3">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-base-content/70">{{ _('Sales Total') }}</span>
                            <span class="font-mono text-base-content/70">
                                {% if manual_sales is not none %}{{ "{:,.0f}".format(manual_sales) }}{% else %}-{% endif %}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-base-content/50 mt-1">
                            <span>{{ _('System') }}</span>
                            <span class="font-mono">{% if system_sales is not none %}{{ "{:,.0f}".format(system_sales) }}{% else %}-{% endif %}</span>
                        </div>
                    </div>
                    <div class="rounded-lg border border-base-200 p-3">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-base-content/70">{{ _('Daily Cost Total') }}</span>
                            <span class="font-mono text-base-content/70">
                                {% if cost_total is not none %}{{ "{:,.0f}".format(cost_total) }}{% else %}-{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="rounded-lg border border-base-200 p-3">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-base-content/70">{{ _('Gross Margin') }}</span>
                            <span class="font-mono {% if gross_margin is not none and gross_margin >= 0 %}text-success{% elif gross_margin is not none %}text-error{% else %}text-base-content/40{% endif %}">
                                {% if gross_margin is not none %}{{ "{:,.0f}".format(gross_margin) }}{% else %}-{% endif %}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-base-content/50 mt-1">
                            <span>{{ _('Margin %') }}</span>
                            <span class="{% if margin_pct is not none and margin_pct >= 0 %}text-success{% elif margin_pct is not none %}text-error{% else %}text-base-content/40{% endif %}">
                                {% if margin_pct is not none %}{{ "{:+.2f}".format(margin_pct) }}%{% else %}-{% endif %}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-base-content/50 mt-1">
                            <span>{{ _('Cost percentage of Sales') }}</span>
                            <span>{% if cost_pct is not none %}{{ "{:.2f}".format(cost_pct) }}%{% else %}-{% endif %}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not comparison_data %}
            <div class="bg-base-200/50 border border-dashed border-base-300 rounded-lg p-6 text-center text-sm text-base-content/60 italic">
                {{ _('No businesses found') }}
            </div>
            {% elif totals.has_any %}
            {% if totals.manual_sales != 0 %}
            {% set total_margin_pct = (totals.gross_margin / totals.manual_sales) * 100 %}
            {% set total_cost_pct = (totals.cost / totals.manual_sales) * 100 %}
            {% else %}
            {% set total_margin_pct = none %}
            {% set total_cost_pct = none %}
            {% endif %}
            <div class="rounded-lg border border-base-300 bg-base-100 p-4">
                <div class="text-xs font-semibold uppercase tracking-wider text-base-content/60">{{ _('Totals') }}</div>
                <div class="mt-2 grid grid-cols-1 gap-2 text-xs">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-base-content/70">{{ _('Sales Total') }}</span>
                        <span class="font-mono text-primary font-semibold">{{ "{:,.0f}".format(totals.manual_sales) }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-base-content/70">{{ _('Daily Cost Total') }}</span>
                        <span class="font-mono font-semibold">{{ "{:,.0f}".format(totals.cost) }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-base-content/70">{{ _('Gross Margin') }}</span>
                        <span class="font-mono font-semibold {% if totals.gross_margin >= 0 %}text-success{% else %}text-error{% endif %}">{{ "{:,.0f}".format(totals.gross_margin) }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-base-content/70">{{ _('Margin %') }}</span>
                        <span class="{% if total_margin_pct is not none and total_margin_pct >= 0 %}text-success{% elif total_margin_pct is not none %}text-error{% else %}text-base-content/40{% endif %}">
                            {% if total_margin_pct is not none %}{{ "{:+.2f}".format(total_margin_pct) }}%{% else %}-{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-base-content/70">{{ _('Cost percentage of Sales') }}</span>
                        <span class="text-base-content/70">{% if total_cost_pct is not none %}{{ "{:.2f}".format(total_cost_pct) }}%{% else %}-{% endif %}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="overflow-x-auto hidden lg:block">
        <table class="table table-sm w-full mt-2">
            <thead>
                <tr class="bg-base-200">
                    <th class="text-xs font-bold uppercase tracking-wider">{{ _('Business') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Sales Total') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Daily Cost Total') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Gross Margin') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Margin %') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Cost Percent of Sales') }}</th>
                </tr>
            </thead>
            <tbody>
                {% set totals = namespace(system_sales=0, manual_sales=0, cost=0, gross_margin=0, has_any=false) %}
                {% for item in comparison_data %}
                {% set manual_sales = item.manual.total_sales if item.manual and item.manual.total_sales is not none else none %}
                {% set system_sales = item.system.total_sales if item.system and item.system.total_sales is not none else none %}
                {% set cost_total = item.manual_entry.daily_cost_total if item.manual_entry and item.manual_entry.daily_cost_total is not none else none %}
                {% if manual_sales is not none and cost_total is not none %}
                {% set gross_margin = manual_sales - cost_total %}
                {% if manual_sales != 0 %}
                {% set margin_pct = (gross_margin / manual_sales) * 100 %}
                {% set cost_pct = (cost_total / manual_sales) * 100 %}
                {% else %}
                {% set margin_pct = none %}
                {% set cost_pct = none %}
                {% endif %}
                {% else %}
                {% set gross_margin = none %}
                {% set margin_pct = none %}
                {% set cost_pct = none %}
                {% endif %}
                {% if manual_sales is not none %}
                {% set totals.manual_sales = totals.manual_sales + manual_sales %}
                {% set totals.has_any = true %}
                {% endif %}
                {% if manual_sales is not none and cost_total is not none %}
                {% set totals.cost = totals.cost + cost_total %}
                {% set totals.gross_margin = totals.gross_margin + gross_margin %}
                {% set totals.has_any = true %}
                {% endif %}
                <tr class="session-row transition-all duration-200 border-l-2 border-transparent{% if item.status == 'Needs Review' %} flagged border-l-4 border-warning bg-base-200/50{% endif %}">
                    <td class="font-medium">
                        {{ item.business.name }}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if manual_sales is not none %}
                        <span class="font-semibold text-primary">{{ "{:,.0f}".format(manual_sales) }}</span>
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if cost_total is not none %}
                        {{ "{:,.0f}".format(cost_total) }}
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if gross_margin is not none %}
                        {% if gross_margin >= 0 %}
                        <span class="text-success font-semibold">{{ "{:,.0f}".format(gross_margin) }}</span>
                        {% else %}
                        <span class="text-error font-semibold">{{ "{:,.0f}".format(gross_margin) }}</span>
                        {% endif %}
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if margin_pct is not none %}
                        <span class="text-xs font-semibold {% if margin_pct >= 0 %}text-success{% else %}text-error{% endif %}">
                            {{ "{:+.2f}".format(margin_pct) }}%
                        </span>
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if cost_pct is not none %}
                        <span class="text-xs text-base-content/70">{{ "{:.2f}".format(cost_pct) }}%</span>
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not comparison_data %}
                <tr>
                    <td colspan="7" class="text-center py-6 text-sm text-base-content/60 italic">
                        {{ _('No businesses found') }}
                    </td>
                </tr>
                {% elif totals.has_any %}
                {% if totals.manual_sales != 0 %}
                {% set total_margin_pct = (totals.gross_margin / totals.manual_sales) * 100 %}
                {% set total_cost_pct = (totals.cost / totals.manual_sales) * 100 %}
                {% else %}
                {% set total_margin_pct = none %}
                {% set total_cost_pct = none %}
                {% endif %}
                <tr class="bg-base-200/70 border-t border-base-300">
                    <td class="font-semibold uppercase text-xs tracking-wider text-base-content/70">
                        {{ _('Totals') }}
                    </td>
                    <td class="text-right font-mono tabular-nums font-semibold text-primary">
                        {{ "{:,.0f}".format(totals.manual_sales) }}
                    </td>
                    <td class="text-right font-mono tabular-nums font-semibold">
                        {{ "{:,.0f}".format(totals.cost) }}
                    </td>
                    <td class="text-right font-mono tabular-nums font-semibold {% if totals.gross_margin >= 0 %}text-success{% else %}text-error{% endif %}">
                        {{ "{:,.0f}".format(totals.gross_margin) }}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if total_margin_pct is not none %}
                        <span class="text-xs font-semibold {% if total_margin_pct >= 0 %}text-success{% else %}text-error{% endif %}">
                            {{ "{:+.2f}".format(total_margin_pct) }}%
                        </span>
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if total_cost_pct is not none %}
                        <span class="text-xs text-base-content/70">{{ "{:.2f}".format(total_cost_pct) }}%</span>
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        </div>
        <div class="bg-base-200/50 border-t border-base-300 px-4 py-3">
            <div class="flex items-center gap-2 text-xs text-base-content/70">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="font-medium text-base-content">{{ _('Margin Tips:') }}</span>
                <span>{{ _('Gross margin uses manual sales minus daily cost total when available.') }}</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* HTMX loading animation */
    #comparison-results.htmx-swapping {
        opacity: 0.5;
    }
    
    #comparison-results.htmx-settling {
        animation: tableFlash 0.6s ease-out;
    }
    
    @keyframes tableFlash {
        0% {
            background-color: rgba(34, 197, 94, 0.08);
        }
        100% {
            background-color: transparent;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('filter-form');
        const businessSelect = document.getElementById('business_id');
        const dateInput = document.getElementById('date');
        
        // Auto-submit form when business or date changes
        function autoSubmit() {
            if (form) {
                form.submit();
            }
        }
        
        // Auto-generate when business changes
        if (businessSelect) {
            businessSelect.addEventListener('change', autoSubmit);
        }
        
        // Auto-generate when date changes (from custom date picker)
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                // Clear quick button highlights when custom date is used
                document.querySelectorAll('.quick-date-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline');
                });
                autoSubmit();
            });
        }
        
        // Quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const daysAgo = parseInt(this.getAttribute('data-days'));
                // Use local date to avoid timezone issues
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const day = today.getDate();
                const targetDate = new Date(year, month, day - daysAgo);
                // Format as YYYY-MM-DD for input[type="date"]
                const yearStr = targetDate.getFullYear();
                const monthStr = String(targetDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(targetDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                // Update the date input
                if (dateInput) {
                    dateInput.value = dateStr;
                }
                
                // Highlight active button
                document.querySelectorAll('.quick-date-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline');
                });
                this.classList.remove('btn-outline');
                this.classList.add('btn-primary');
                
                // Auto-submit form
                autoSubmit();
            });
        });

        // Highlight active button based on current date
        if (dateInput) {
            const currentDate = dateInput.value;
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            
            function formatLocalDate(d) {
                const yearStr = d.getFullYear();
                const monthStr = String(d.getMonth() + 1).padStart(2, '0');
                const dayStr = String(d.getDate()).padStart(2, '0');
                return `${yearStr}-${monthStr}-${dayStr}`;
            }
            
            const todayStr = formatLocalDate(today);
            const yesterday = new Date(year, month, day - 1);
            const yesterdayStr = formatLocalDate(yesterday);
            const twoDaysAgo = new Date(year, month, day - 2);
            const twoDaysAgoStr = formatLocalDate(twoDaysAgo);
            const sevenDaysAgo = new Date(year, month, day - 7);
            const sevenDaysAgoStr = formatLocalDate(sevenDaysAgo);
            const thirtyDaysAgo = new Date(year, month, day - 30);
            const thirtyDaysAgoStr = formatLocalDate(thirtyDaysAgo);
            
            let activeBtn = null;
            if (currentDate === todayStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="0"]');
            } else if (currentDate === yesterdayStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="1"]');
            } else if (currentDate === twoDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="2"]');
            } else if (currentDate === sevenDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="7"]');
            } else if (currentDate === thirtyDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="30"]');
            }
            
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline');
                activeBtn.classList.add('btn-primary');
            }
        }

        // Handle session expansion/collapse
        document.addEventListener('click', function(e) {
            const expandBtn = e.target.closest('.expand-sessions-btn');
            if (expandBtn) {
                const businessId = expandBtn.getAttribute('data-business-id');
                const detailRow = document.getElementById(`sessions-row-${businessId}`);
                const chevron = expandBtn.querySelector('.chevron-icon');
                
                if (detailRow) {
                    if (detailRow.classList.contains('hidden')) {
                        // Expand
                        detailRow.classList.remove('hidden');
                        chevron.style.transform = 'rotate(180deg)';
                    } else {
                        // Collapse
                        detailRow.classList.add('hidden');
                        chevron.style.transform = 'rotate(0deg)';
                    }
                }
            }
        });
        
        // Update ARIA busy state during HTMX requests
        document.addEventListener('htmx:xhr:loadstart', function(evt) {
            const resultsDiv = document.getElementById('comparison-results');
            if (evt.detail.xhr.readyState !== 0) {
                if (resultsDiv) resultsDiv.setAttribute('aria-busy', 'true');
            }
        });
        
        document.addEventListener('htmx:xhr:loadend', function(evt) {
            const resultsDiv = document.getElementById('comparison-results');
            if (resultsDiv) resultsDiv.setAttribute('aria-busy', 'false');
        });
    });
</script>
{% endblock %}
