<!-- File: templates/admin/reconciliation_compare.html -->
{% extends "base.html" %}

{% block title %}{{ _('Daily Reconciliation Comparison') }} - CashPilot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg border border-primary/20 shadow-sm">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-base-content">{{ _('Daily Reconciliation Comparison') }}</h1>
                    <p class="text-xs md:text-sm text-base-content/60 mt-0.5">{{ _('Compare manual entries vs system records') }}</p>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/reconciliation/daily?date={{ comparison_date.isoformat() }}" class="btn btn-outline btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                {{ _('Edit Entries') }}
            </a>
            <a href="/" class="btn btn-outline btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                {{ _('Back to Dashboard') }}
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-4">
        <form method="get" action="/admin/reconciliation/compare" id="filter-form">
            <!-- Business Selector (Most Important - Full Width) -->
            <div class="mb-4">
                <label for="business_id" class="label py-1">
                    <span class="label-text text-xs font-bold uppercase tracking-wider text-base-content/70">{{ _('Business') }}</span>
                </label>
                <select
                    id="business_id"
                    name="business_id"
                    class="select select-bordered w-full focus:select-primary focus:ring-2 focus:ring-primary/20 transition-all"
                    aria-label="{{ _('Select business to analyze') }}"
                >
                    <option value="">{{ _('All Businesses') }}</option>
                    {% for business in businesses %}
                    <option value="{{ business.id }}" {% if selected_business_id == business.id|string %}selected{% endif %}>
                        {{ business.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="divider my-3 text-xs text-base-content/50">{{ _('Select date') }}</div>

            <!-- Selected Period Banner -->
            <div id="selectedPeriodBanner" class="mb-3 p-3 bg-info/10 border border-info/30 rounded-lg">
                <div class="flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="font-medium text-info">{{ _('Viewing') }}:</span>
                    <span id="selectedPeriodText" class="text-base-content font-semibold">{{ comparison_date.strftime('%B %d, %Y') if comparison_date else '' }}</span>
                </div>
            </div>

            <!-- Quick Action Buttons (First button with icon, starts as btn-outline) -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="0" 
                    aria-label="{{ _('Select today') }}"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    {{ _('Today') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="1" 
                    aria-label="{{ _('Select yesterday') }}"
                >
                    {{ _('Yesterday') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="2" 
                    aria-label="{{ _('Select 2 days ago') }}"
                >
                    {{ _('2 Days Ago') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="7" 
                    aria-label="{{ _('Select 7 days ago') }}"
                >
                    {{ _('7 Days Ago') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="30" 
                    aria-label="{{ _('Select 30 days ago') }}"
                >
                    {{ _('30 Days Ago') }}
                </button>
            </div>

            <!-- Custom Date Selector (Collapsed by Default) -->
            <details class="collapse collapse-arrow bg-base-200/50 rounded-lg border border-base-300">
                <summary class="collapse-title text-sm font-medium cursor-pointer hover:bg-base-200 transition-all">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>{{ _('Pick Custom Date') }}</span>
                    </div>
                </summary>
                <div class="collapse-content pt-3">
                    <div class="form-control">
                        <label for="date" class="label py-1">
                            <span class="label-text text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Date') }}</span>
                        </label>
                        <input
                            type="date"
                            name="date"
                            id="date"
                            value="{{ comparison_date.isoformat() }}"
                            class="input input-bordered w-full focus:input-primary focus:ring-2 focus:ring-primary/20 transition-all"
                            aria-describedby="date-help"
                        />
                        <label class="label pt-2" id="date-help-container">
                            <span class="label-text-alt text-info font-medium flex items-center gap-1" id="date-help">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                {{ _('Select a date to compare reconciliation data') }}
                            </span>
                        </label>
                    </div>
                </div>
            </details>
        </form>
    </div>

    <!-- Comparison Table -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-x-auto">
        <table class="table table-sm w-full">
            <thead>
                <tr class="bg-base-200">
                    <th class="text-xs font-bold uppercase tracking-wider">{{ _('Business') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Status') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Cash Sales') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Card Sales') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Credit Sales') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Total Sales') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Difference') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Sessions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in comparison_data %}
                <tr class="hover:bg-base-200/50">
                    <td class="font-medium">{{ item.business.name }}</td>
                    <td class="text-right">
                        {% if item.is_closed %}
                        <span class="badge badge-warning badge-sm">{{ _('Closed') }}</span>
                        {% elif item.status == 'Needs Review' %}
                        <span class="badge badge-error badge-sm">{{ _('Needs Review') }}</span>
                        {% elif item.manual_entry %}
                        <span class="badge badge-success badge-sm">{{ _('Entered') }}</span>
                        {% else %}
                        <span class="badge badge-ghost badge-sm">{{ _('Not Entered') }}</span>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="text-sm">
                            {% if item.manual.cash_sales is not none %}
                            <div class="text-base-content font-semibold">{{ "{:,.0f}".format(item.manual.cash_sales) }}</div>
                            {% else %}
                            <div class="text-base-content/40">-</div>
                            {% endif %}
                            <div class="text-xs text-base-content/60">{{ _('Sessions') }}: {{ "{:,.0f}".format(item.system.cash_sales) }}</div>
                            {% if item.differences.cash_sales is not none and item.differences.cash_sales != 0 %}
                            {% set cash_diff = item.differences.cash_sales %}
                            <div class="text-xs {% if cash_diff > 0 %}text-error{% else %}text-success{% endif %}">
                                {% if cash_diff > 0 %}+{% endif %}{{ "{:,.0f}".format(cash_diff) }}
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="text-sm">
                            {% if item.manual.card_sales is not none %}
                            <div class="text-base-content font-semibold">{{ "{:,.0f}".format(item.manual.card_sales) }}</div>
                            {% else %}
                            <div class="text-base-content/40">-</div>
                            {% endif %}
                            <div class="text-xs text-base-content/60">{{ _('Sessions') }}: {{ "{:,.0f}".format(item.system.card_sales) }}</div>
                            {% if item.differences.card_sales is not none and item.differences.card_sales != 0 %}
                            {% set card_diff = item.differences.card_sales %}
                            <div class="text-xs {% if card_diff > 0 %}text-error{% else %}text-success{% endif %}">
                                {% if card_diff > 0 %}+{% endif %}{{ "{:,.0f}".format(card_diff) }}
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="text-sm">
                            {% if item.manual.credit_sales is not none %}
                            <div class="text-base-content font-semibold">{{ "{:,.0f}".format(item.manual.credit_sales) }}</div>
                            {% else %}
                            <div class="text-base-content/40">-</div>
                            {% endif %}
                            <div class="text-xs text-base-content/60">{{ _('Sessions') }}: {{ "{:,.0f}".format(item.system.credit_sales) }}</div>
                            {% if item.differences.credit_sales is not none and item.differences.credit_sales != 0 %}
                            {% set credit_diff = item.differences.credit_sales %}
                            <div class="text-xs {% if credit_diff > 0 %}text-error{% else %}text-success{% endif %}">
                                {% if credit_diff > 0 %}+{% endif %}{{ "{:,.0f}".format(credit_diff) }}
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="text-sm">
                            {% if item.manual.total_sales is not none %}
                            <div class="text-base-content font-bold">{{ "{:,.0f}".format(item.manual.total_sales) }}</div>
                            {% else %}
                            <div class="text-base-content/40">-</div>
                            {% endif %}
                            <div class="text-xs text-base-content/60">{{ _('Sessions') }}: {{ "{:,.0f}".format(item.system.total_sales) }}</div>
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if item.differences.total_sales is not none %}
                        {% set diff = item.differences.total_sales %}
                        {% set variance_pct = item.variance.total_sales %}
                        {% if diff != 0 %}
                            {% if variance_pct is not none and (variance_pct > 2.0 or variance_pct < -2.0) %}
                            <div class="flex flex-col items-end gap-1">
                                <span class="badge badge-error badge-sm font-bold">
                                    {% if diff > 0 %}+{% endif %}{{ "{:,.0f}".format(diff) }}
                                </span>
                                <span class="text-xs text-error/70">{{ "{:+.2f}".format(variance_pct) }}%</span>
                            </div>
                            {% elif variance_pct is not none and variance_pct != 0 %}
                            <div class="flex flex-col items-end gap-1">
                                <span class="badge badge-warning badge-sm font-semibold">
                                    {% if diff > 0 %}+{% endif %}{{ "{:,.0f}".format(diff) }}
                                </span>
                                <span class="text-xs text-warning/70">{{ "{:+.2f}".format(variance_pct) }}%</span>
                            </div>
                            {% else %}
                            <span class="badge badge-success badge-sm">
                                {% if diff > 0 %}+{% endif %}{{ "{:,.0f}".format(diff) }}
                            </span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-success badge-sm">0</span>
                        {% endif %}
                        {% else %}
                        <span class="text-base-content/40">-</span>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {% if item.system.session_count > 0 %}
                        <a 
                            href="/?business_id={{ item.business.id }}&from_date={{ comparison_date.isoformat() }}&to_date={{ comparison_date.isoformat() }}&from_report={{ comparison_date.isoformat() }}" 
                            class="badge badge-info badge-sm hover:badge-primary transition-all cursor-pointer"
                            title="{{ _('View sessions for this business and date') }}"
                        >
                            {{ item.system.session_count }}
                        </a>
                        {% else %}
                        <span class="badge badge-ghost badge-sm">{{ item.system.session_count }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not comparison_data %}
                <tr>
                    <td colspan="8" class="text-center py-8">
                        <div class="bg-base-200/50 border border-dashed border-base-300 rounded-lg p-6 text-center transition-all duration-200">
                            <svg class="w-8 h-8 mx-auto text-base-content/30 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <p class="text-sm text-base-content/60 italic">{{ _('No businesses found') }}</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('filter-form');
        const businessSelect = document.getElementById('business_id');
        const dateInput = document.getElementById('date');
        
        // Auto-submit form when business or date changes
        function autoSubmit() {
            if (form) {
                form.submit();
            }
        }
        
        // Auto-generate when business changes
        if (businessSelect) {
            businessSelect.addEventListener('change', autoSubmit);
        }
        
        // Auto-generate when date changes (from custom date picker)
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                // Clear quick button highlights when custom date is used
                document.querySelectorAll('.quick-date-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline');
                });
                autoSubmit();
            });
        }
        
        // Quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const daysAgo = parseInt(this.getAttribute('data-days'));
                // Use local date to avoid timezone issues
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const day = today.getDate();
                const targetDate = new Date(year, month, day - daysAgo);
                // Format as YYYY-MM-DD for input[type="date"]
                const yearStr = targetDate.getFullYear();
                const monthStr = String(targetDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(targetDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                // Update the date input
                if (dateInput) {
                    dateInput.value = dateStr;
                }
                
                // Highlight active button
                document.querySelectorAll('.quick-date-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline');
                });
                this.classList.remove('btn-outline');
                this.classList.add('btn-primary');
                
                // Auto-submit form
                autoSubmit();
            });
        });

        // Highlight active button based on current date
        if (dateInput) {
            const currentDate = dateInput.value;
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            
            function formatLocalDate(d) {
                const yearStr = d.getFullYear();
                const monthStr = String(d.getMonth() + 1).padStart(2, '0');
                const dayStr = String(d.getDate()).padStart(2, '0');
                return `${yearStr}-${monthStr}-${dayStr}`;
            }
            
            const todayStr = formatLocalDate(today);
            const yesterday = new Date(year, month, day - 1);
            const yesterdayStr = formatLocalDate(yesterday);
            const twoDaysAgo = new Date(year, month, day - 2);
            const twoDaysAgoStr = formatLocalDate(twoDaysAgo);
            const sevenDaysAgo = new Date(year, month, day - 7);
            const sevenDaysAgoStr = formatLocalDate(sevenDaysAgo);
            const thirtyDaysAgo = new Date(year, month, day - 30);
            const thirtyDaysAgoStr = formatLocalDate(thirtyDaysAgo);
            
            let activeBtn = null;
            if (currentDate === todayStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="0"]');
            } else if (currentDate === yesterdayStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="1"]');
            } else if (currentDate === twoDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="2"]');
            } else if (currentDate === sevenDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="7"]');
            } else if (currentDate === thirtyDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="30"]');
            }
            
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline');
                activeBtn.classList.add('btn-primary');
            }
        }
    });
</script>
{% endblock %}

