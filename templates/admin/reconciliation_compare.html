<!-- File: templates/admin/reconciliation_compare.html -->
{% extends "base.html" %}

{% block title %}{{ _('Daily Reconciliation Comparison') }} - CashPilot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg border border-primary/20 shadow-sm">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-base-content">{{ _('Daily Reconciliation Comparison') }}</h1>
                    <p class="text-xs md:text-sm text-base-content/60 mt-0.5">{{ _('Compare system entries vs manual records') }}</p>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/reconciliation/daily?date={{ comparison_date.isoformat() }}" class="btn btn-outline btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                {{ _('Edit Entries') }}
            </a>
            <a href="/" class="btn btn-outline btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                {{ _('Back to Dashboard') }}
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-4">
        <form method="get" action="/admin/reconciliation/compare" id="filter-form">
            <!-- Business Selector (Most Important - Full Width) -->
            <div class="mb-4">
                <label for="business_id" class="label py-1">
                    <span class="label-text text-xs font-bold uppercase tracking-wider text-base-content/70">{{ _('Business') }}</span>
                </label>
                <select
                    id="business_id"
                    name="business_id"
                    class="select select-bordered w-full focus:select-primary focus:ring-2 focus:ring-primary/20 transition-all"
                    aria-label="{{ _('Select business to analyze') }}"
                >
                    <option value="">{{ _('All Businesses') }}</option>
                    {% for business in businesses %}
                    <option value="{{ business.id }}" {% if selected_business_id == business.id|string %}selected{% endif %}>
                        {{ business.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="divider my-3 text-xs text-base-content/50">{{ _('Select date') }}</div>

            <!-- Selected Period Banner -->
            <div id="selectedPeriodBanner" class="mb-3 p-3 bg-info/10 border border-info/30 rounded-lg">
                <div class="flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="font-medium text-info">{{ _('Viewing') }}:</span>
                    <span id="selectedPeriodText" class="text-base-content font-semibold">{{ comparison_date.strftime('%B %d, %Y') if comparison_date else '' }}</span>
                </div>
            </div>

            <!-- Quick Action Buttons (First button with icon, starts as btn-outline) -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="0" 
                    aria-label="{{ _('Select today') }}"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    {{ _('Today') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="1" 
                    aria-label="{{ _('Select yesterday') }}"
                >
                    {{ _('Yesterday') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="2" 
                    aria-label="{{ _('Select 2 days ago') }}"
                >
                    {{ _('2 Days Ago') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="7" 
                    aria-label="{{ _('Select 7 days ago') }}"
                >
                    {{ _('7 Days Ago') }}
                </button>
                <button 
                    type="button"
                    class="btn btn-sm btn-outline quick-date-btn transition-all hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/20" 
                    data-days="30" 
                    aria-label="{{ _('Select 30 days ago') }}"
                >
                    {{ _('30 Days Ago') }}
                </button>
            </div>

            <!-- Custom Date Selector (Collapsed by Default) -->
            <details class="collapse collapse-arrow bg-base-200/50 rounded-lg border border-base-300">
                <summary class="collapse-title text-sm font-medium cursor-pointer hover:bg-base-200 transition-all">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>{{ _('Pick Custom Date') }}</span>
                    </div>
                </summary>
                <div class="collapse-content pt-3">
                    <div class="form-control">
                        <label for="date" class="label py-1">
                            <span class="label-text text-xs font-semibold uppercase tracking-wider text-base-content/70">{{ _('Date') }}</span>
                        </label>
                        <input
                            type="date"
                            name="date"
                            id="date"
                            value="{{ comparison_date.isoformat() }}"
                            class="input input-bordered w-full focus:input-primary focus:ring-2 focus:ring-primary/20 transition-all"
                            aria-describedby="date-help"
                        />
                        <label class="label pt-2" id="date-help-container">
                            <span class="label-text-alt text-info font-medium flex items-center gap-1" id="date-help">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                {{ _('Select a date to compare reconciliation data') }}
                            </span>
                        </label>
                    </div>
                </div>
            </details>
        </form>
    </div>

    <!-- Comparison Table -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm overflow-x-auto">
        <style>
            /* Hover tint */
            .table tbody tr.session-row:hover td {
                background-color: hsl(var(--p) / 0.10) !important;
            }
        
            .table tbody tr.session-row.flagged:hover td {
                background-color: hsl(var(--b2) / 0.7) !important;
            }
        
            /* Horizontal borders between rows */
            .table tbody tr {
                border-bottom: 1px solid hsl(var(--b2));
            }
        
            /* Vertical borders between columns */
            .table tbody td:not(:last-child),
            .table thead th:not(:last-child) {
                border-right: 1px solid hsl(var(--bc) / 0.1);
            }

            /* Fade in animation for session details */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
        <table class="table table-sm w-full">
            <thead>
                <tr class="bg-base-200">
                    <th class="text-xs font-bold uppercase tracking-wider">{{ _('Business') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider">{{ _('Cashiers') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Entry Status') }}</th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Cash Sales') }}<br><span class="text-[10px] font-normal normal-case text-base-content/50">{{ _('System vs Manual') }}</span></th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Card Sales') }}<br><span class="text-[10px] font-normal normal-case text-base-content/50">{{ _('System vs Manual') }}</span></th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Credit Sales') }}<br><span class="text-[10px] font-normal normal-case text-base-content/50">{{ _('System vs Manual') }}</span></th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Total Sales') }}<br><span class="text-[10px] font-normal normal-case text-base-content/50">{{ _('System vs Manual') }}</span></th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Total Difference') }}<br><span class="text-[10px] font-normal normal-case text-base-content/50">{{ _('(Manual - System)') }}</span></th>
                    <th class="text-xs font-bold uppercase tracking-wider text-right">{{ _('Sessions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in comparison_data %}
                <tr class="session-row transition-all duration-200 border-l-2 border-transparent{% if item.status == 'Needs Review' %} flagged border-l-4 border-warning bg-base-200/50{% endif %}" data-business-id="{{ item.business.id }}">
                    <td class="font-medium">{{ item.business.name }}</td>
                    <td class="text-xs text-base-content/70">{{ item.cashiers }}</td>
                    <td class="text-right">
                        {% if item.is_closed %}
                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-base-300 dark:bg-base-700 text-xs font-medium text-base-content/60">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 15.636 5.636m12.728 12.728L5.636 5.636"/>
                            </svg>
                            {{ _('Closed') }}
                        </span>
                        {% elif item.status == 'Needs Review' %}
                        <a href="/reconciliation/daily?date={{ comparison_date.isoformat() }}{% if item.business %}&business_id={{ item.business.id }}{% endif %}" 
                           class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-amber-50 dark:bg-amber-950/50 text-xs font-medium text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-950/70 hover:scale-105 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-amber-500/50 cursor-pointer group"
                           title="{{ _('Click to review and edit') }}"
                           aria-label="{{ _('Review differences for') }} {{ item.business.name }}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            {{ _('Review') }}
                            <svg class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                        {% elif item.manual_entry %}
                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-emerald-50 dark:bg-emerald-950/50 text-xs font-medium text-emerald-700 dark:text-emerald-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            {{ _('Completed') }}
                        </span>
                        {% else %}
                        <a href="/reconciliation/daily?date={{ comparison_date.isoformat() }}{% if item.business %}&business_id={{ item.business.id }}{% endif %}" 
                           class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-base-200 dark:bg-base-800 text-xs font-medium text-base-content/60 hover:bg-base-300 dark:hover:bg-base-700 hover:text-base-content hover:scale-105 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-base-content/30 cursor-pointer group"
                           title="{{ _('Click to add manual entry') }}"
                           aria-label="{{ _('Add manual entry for') }} {{ item.business.name }}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ _('Pending') }}
                            <svg class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                        {% endif %}
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="space-y-1">
                            {% if item.manual.cash_sales is not none %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-sm font-bold text-primary">{{ "{:,.0f}".format(item.manual.cash_sales) }}</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-xs text-base-content/60">{{ "{:,.0f}".format(item.system.cash_sales) }}</span>
                            </div>
                            {% if item.differences.cash_sales is not none and item.differences.cash_sales != 0 %}
                            {% set cash_diff = item.differences.cash_sales %}
                            <div class="flex items-center justify-end gap-1.5 pt-0.5 border-t border-base-content/10">
                                <span class="text-[10px] font-sans {% if cash_diff > 0 %}text-success{% else %}text-error{% endif %}">{{ _('Diff:') }}</span>
                                <span class="text-xs font-bold {% if cash_diff > 0 %}text-success{% else %}text-error{% endif %}">
                                    {% if cash_diff > 0 %}+{% endif %}{{ "{:,.0f}".format(cash_diff) }}
                                </span>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-sm text-base-content/40">-</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-xs text-base-content/60">{{ "{:,.0f}".format(item.system.cash_sales) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="space-y-1">
                            {% if item.manual.card_sales is not none %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-sm font-bold text-primary">{{ "{:,.0f}".format(item.manual.card_sales) }}</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-xs text-base-content/60">{{ "{:,.0f}".format(item.system.card_sales) }}</span>
                            </div>
                            {% if item.differences.card_sales is not none and item.differences.card_sales != 0 %}
                            {% set card_diff = item.differences.card_sales %}
                            <div class="flex items-center justify-end gap-1.5 pt-0.5 border-t border-base-content/10">
                                <span class="text-[10px] font-sans {% if card_diff > 0 %}text-success{% else %}text-error{% endif %}">{{ _('Diff:') }}</span>
                                <span class="text-xs font-bold {% if card_diff > 0 %}text-success{% else %}text-error{% endif %}">
                                    {% if card_diff > 0 %}+{% endif %}{{ "{:,.0f}".format(card_diff) }}
                                </span>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-sm text-base-content/40">-</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-xs text-base-content/60">{{ "{:,.0f}".format(item.system.card_sales) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="space-y-1">
                            {% if item.manual.credit_sales is not none %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-sm font-bold text-primary">{{ "{:,.0f}".format(item.manual.credit_sales) }}</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-xs text-base-content/60">{{ "{:,.0f}".format(item.system.credit_sales) }}</span>
                            </div>
                            {% if item.differences.credit_sales is not none and item.differences.credit_sales != 0 %}
                            {% set credit_diff = item.differences.credit_sales %}
                            <div class="flex items-center justify-end gap-1.5 pt-0.5 border-t border-base-content/10">
                                <span class="text-[10px] font-sans {% if credit_diff > 0 %}text-success{% else %}text-error{% endif %}">{{ _('Diff:') }}</span>
                                <span class="text-xs font-bold {% if credit_diff > 0 %}text-success{% else %}text-error{% endif %}">
                                    {% if credit_diff > 0 %}+{% endif %}{{ "{:,.0f}".format(credit_diff) }}
                                </span>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-sm text-base-content/40">-</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-xs text-base-content/60">{{ "{:,.0f}".format(item.system.credit_sales) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        <div class="space-y-1">
                            {% if item.manual.total_sales is not none %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-sm font-bold text-primary">{{ "{:,.0f}".format(item.manual.total_sales) }}</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-sm text-base-content/60">{{ "{:,.0f}".format(item.system.total_sales) }}</span>
                            </div>
                            {% else %}
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('Manual:') }}</span>
                                <span class="text-sm text-base-content/40">-</span>
                            </div>
                            <div class="flex items-center justify-end gap-1.5">
                                <span class="text-[10px] text-base-content/50 font-sans">{{ _('System:') }}</span>
                                <span class="text-sm text-base-content/60">{{ "{:,.0f}".format(item.system.total_sales) }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-right font-mono tabular-nums">
                        {% if item.differences.total_sales is not none %}
                        {% set diff = item.differences.total_sales %}
                        {% set variance_pct = item.variance.total_sales %}
                        {% if diff != 0 %}
                            {% if variance_pct is not none and (variance_pct > 2.0 or variance_pct < -2.0) %}
                            <div class="space-y-0.5">
                                {% if diff > 0 %}
                                <div class="text-sm font-bold text-success">
                                    +{{ "{:,.0f}".format(diff) }}
                                </div>
                                <div class="text-xs text-success/70">{{ "{:+.2f}".format(variance_pct) }}%</div>
                                {% else %}
                                <div class="text-sm font-bold text-error">
                                    {{ "{:,.0f}".format(diff) }}
                                </div>
                                <div class="text-xs text-error/70">{{ "{:+.2f}".format(variance_pct) }}%</div>
                                {% endif %}
                            </div>
                            {% elif variance_pct is not none and variance_pct != 0 %}
                            <div class="space-y-0.5">
                                {% if diff > 0 %}
                                <div class="text-sm font-semibold text-success/80">
                                    +{{ "{:,.0f}".format(diff) }}
                                </div>
                                <div class="text-xs text-success/60">{{ "{:+.2f}".format(variance_pct) }}%</div>
                                {% else %}
                                <div class="text-sm font-semibold text-error/80">
                                    {{ "{:,.0f}".format(diff) }}
                                </div>
                                <div class="text-xs text-error/60">{{ "{:+.2f}".format(variance_pct) }}%</div>
                                {% endif %}
                            </div>
                            {% else %}
                            {% if diff > 0 %}
                            <div class="text-sm font-medium text-success/60">
                                +{{ "{:,.0f}".format(diff) }}
                            </div>
                            {% else %}
                            <div class="text-sm font-medium text-error/60">
                                {{ "{:,.0f}".format(diff) }}
                            </div>
                            {% endif %}
                            {% endif %}
                        {% else %}
                            <div class="text-sm text-base-content/60">0</div>
                        {% endif %}
                        {% else %}
                        <div class="text-sm text-base-content/40">-</div>
                        {% endif %}
                    </td>
                    <td class="text-right">
                        <div class="flex justify-end">
                            {% if item.system.session_count > 0 %}
                            <button 
                                hx-get="/admin/reconciliation/sessions?business_id={{ item.business.id }}&date={{ comparison_date.isoformat() }}"
                                hx-target="#sessions-detail-{{ item.business.id }}"
                                hx-swap="innerHTML"
                                hx-indicator="#sessions-loading-{{ item.business.id }}"
                                class="expand-sessions-btn inline-flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg bg-info/10 hover:bg-info/20 text-info hover:text-info-focus font-medium text-sm transition-all duration-200 hover:scale-105 active:scale-95 border border-info/30 hover:border-info/50 hover:shadow-md min-w-[3rem] focus:outline-none focus:ring-2 focus:ring-info/50"
                                title="{{ _('Click to view sessions detail') }}"
                                data-business-id="{{ item.business.id }}"
                                aria-label="{{ _('View sessions for') }} {{ item.business.name }}"
                            >
                                <span class="loading loading-spinner loading-xs hidden" id="sessions-loading-{{ item.business.id }}"></span>
                                <svg class="w-4 h-4 flex-shrink-0 chevron-icon transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                                <span class="font-mono tabular-nums font-semibold">{{ item.system.session_count }}</span>
                            </button>
                            {% else %}
                            <span class="inline-flex items-center gap-1.5 text-sm text-base-content/40 font-mono tabular-nums">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {{ item.system.session_count }}
                            </span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <!-- Expandable row for session details -->
                {% if item.system.session_count > 0 %}
                <tr class="sessions-detail-row hidden transition-all duration-300" id="sessions-row-{{ item.business.id }}">
                    <td colspan="9" class="!p-0 bg-gradient-to-br from-base-200/30 to-base-100 border-t border-b-2 border-info/20">
                        <div id="sessions-detail-{{ item.business.id }}" class="p-4 animate-[fadeIn_0.3s_ease-in-out]">
                            <!-- Sessions will be loaded here via HTMX -->
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
                {% if not comparison_data %}
                <tr>
                    <td colspan="9" class="text-center py-8">
                        <div class="bg-base-200/50 border border-dashed border-base-300 rounded-lg p-6 text-center transition-all duration-200">
                            <svg class="w-8 h-8 mx-auto text-base-content/30 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <p class="text-sm text-base-content/60 italic">{{ _('No businesses found') }}</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <!-- Color Legend -->
        <div class="bg-base-200/50 border-t border-base-300 px-4 py-3">
            <div class="flex items-center gap-2 text-xs text-base-content/70">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="font-medium text-base-content">{{ _('Difference Colors:') }}</span>
                <span class="text-success font-semibold">{{ _('Green (Surplus)') }}</span>
                <span>=</span>
                <span>{{ _('Manual has MORE than System (positive difference)') }}.</span>
                <span class="text-error font-semibold ml-4">{{ _('Red (Deficit)') }}</span>
                <span>=</span>
                <span>{{ _('Manual has LESS than System (negative difference)') }}.</span>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('filter-form');
        const businessSelect = document.getElementById('business_id');
        const dateInput = document.getElementById('date');
        
        // Auto-submit form when business or date changes
        function autoSubmit() {
            if (form) {
                form.submit();
            }
        }
        
        // Auto-generate when business changes
        if (businessSelect) {
            businessSelect.addEventListener('change', autoSubmit);
        }
        
        // Auto-generate when date changes (from custom date picker)
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                // Clear quick button highlights when custom date is used
                document.querySelectorAll('.quick-date-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline');
                });
                autoSubmit();
            });
        }
        
        // Quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const daysAgo = parseInt(this.getAttribute('data-days'));
                // Use local date to avoid timezone issues
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const day = today.getDate();
                const targetDate = new Date(year, month, day - daysAgo);
                // Format as YYYY-MM-DD for input[type="date"]
                const yearStr = targetDate.getFullYear();
                const monthStr = String(targetDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(targetDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                // Update the date input
                if (dateInput) {
                    dateInput.value = dateStr;
                }
                
                // Highlight active button
                document.querySelectorAll('.quick-date-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline');
                });
                this.classList.remove('btn-outline');
                this.classList.add('btn-primary');
                
                // Auto-submit form
                autoSubmit();
            });
        });

        // Highlight active button based on current date
        if (dateInput) {
            const currentDate = dateInput.value;
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            
            function formatLocalDate(d) {
                const yearStr = d.getFullYear();
                const monthStr = String(d.getMonth() + 1).padStart(2, '0');
                const dayStr = String(d.getDate()).padStart(2, '0');
                return `${yearStr}-${monthStr}-${dayStr}`;
            }
            
            const todayStr = formatLocalDate(today);
            const yesterday = new Date(year, month, day - 1);
            const yesterdayStr = formatLocalDate(yesterday);
            const twoDaysAgo = new Date(year, month, day - 2);
            const twoDaysAgoStr = formatLocalDate(twoDaysAgo);
            const sevenDaysAgo = new Date(year, month, day - 7);
            const sevenDaysAgoStr = formatLocalDate(sevenDaysAgo);
            const thirtyDaysAgo = new Date(year, month, day - 30);
            const thirtyDaysAgoStr = formatLocalDate(thirtyDaysAgo);
            
            let activeBtn = null;
            if (currentDate === todayStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="0"]');
            } else if (currentDate === yesterdayStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="1"]');
            } else if (currentDate === twoDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="2"]');
            } else if (currentDate === sevenDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="7"]');
            } else if (currentDate === thirtyDaysAgoStr) {
                activeBtn = document.querySelector('.quick-date-btn[data-days="30"]');
            }
            
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline');
                activeBtn.classList.add('btn-primary');
            }
        }

        // Handle session expansion/collapse
        document.addEventListener('click', function(e) {
            const expandBtn = e.target.closest('.expand-sessions-btn');
            if (expandBtn) {
                const businessId = expandBtn.getAttribute('data-business-id');
                const detailRow = document.getElementById(`sessions-row-${businessId}`);
                const chevron = expandBtn.querySelector('.chevron-icon');
                
                if (detailRow) {
                    if (detailRow.classList.contains('hidden')) {
                        // Expand
                        detailRow.classList.remove('hidden');
                        chevron.style.transform = 'rotate(180deg)';
                    } else {
                        // Collapse
                        detailRow.classList.add('hidden');
                        chevron.style.transform = 'rotate(0deg)';
                    }
                }
            }
        });
    });
</script>
{% endblock %}

