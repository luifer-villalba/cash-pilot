<!-- File: src/cashpilot/templates/index.html -->
{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - CashPilot{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-6">
        <div class="flex-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg border border-primary/20 shadow-sm transition-all duration-200 hover:scale-105">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-base-content">{{ _('Dashboard') }}</h1>
                    <p class="text-xs md:text-sm text-base-content/60 mt-0.5">{{ _('Monitor cash sessions and
                        reconciliation') }}</p>
                </div>
            </div>
        </div>
        {% if current_user.role == 'ADMIN' %}
        <div class="flex gap-2">
            {% if from_report %}
            <a href="/admin/reconciliation/compare?date={{ from_report }}" class="btn btn-outline btn-sm gap-2 transition-all hover:scale-105 active:scale-95">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                {{ _('Back to Report') }}
            </a>
            {% endif %} 
        </div>
        {% endif %}
    </div>

    <!-- Filters Section -->
    <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
        <div class="p-4 md:p-6 space-y-6">
            <!-- Filter Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-base-content/70 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        {{ _('Filter Sessions') }}
                    </h2>
                </div>
                <div class="flex gap-2 items-center">
                    {% if current_user.role == 'ADMIN' %}
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" 
                               id="include-deleted-toggle" 
                               class="toggle toggle-sm toggle-primary"
                               {% if include_deleted %}checked{% endif %}
                               onchange="toggleDeletedSessions()">
                        <span class="text-xs text-base-content/70">{{ _('Show Deleted') }}</span>
                    </label>
                    {% endif %}
                    <button
                            type="button"
                            id="filter-toggle"
                            class="btn btn-sm btn-ghost gap-2 hover:bg-base-200 transition-all duration-200 hover:scale-105 active:scale-95"
                            aria-label="{{ _('Toggle filters') }}"
                            aria-expanded="false"
                    >
                        <span>{{ _('More Options') }}</span>
                        <svg id="filter-chevron" class="w-4 h-4 transition-transform duration-300" fill="none"
                             stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Preset Buttons + Business Selector (Always Visible) -->
            <div class="flex flex-col sm:flex-row flex-wrap gap-2 items-start sm:items-center">
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="preset-btn btn btn-sm btn-outline gap-1 hover:btn-primary transition-all duration-200 hover:scale-105 active:scale-95" data-preset="today">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="2" x2="16" y2="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="8" y1="2" x2="8" y2="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="3" y1="10" x2="21" y2="10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>{{ _('Today') }}</span>
                    </button>
                    <button type="button" class="preset-btn btn btn-sm btn-outline gap-1 hover:btn-primary transition-all duration-200 hover:scale-105 active:scale-95" data-preset="yesterday">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="2" x2="16" y2="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="8" y1="2" x2="8" y2="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="3" y1="10" x2="21" y2="10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 14 L9 16 L7 18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>{{ _('Yesterday') }}</span>
                    </button>
                    <button type="button" class="preset-btn btn btn-sm btn-outline gap-1 hover:btn-primary transition-all duration-200 hover:scale-105 active:scale-95" data-preset="week">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="16" y1="2" x2="16" y2="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="8" y1="2" x2="8" y2="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="3" y1="10" x2="21" y2="10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="7" y="14" width="3" height="3" rx="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="14" y="14" width="3" height="3" rx="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>{{ _('Last 7 Days') }}</span>
                    </button>
                    <button type="button" class="preset-btn btn btn-sm btn-outline gap-1 hover:btn-primary transition-all duration-200 hover:scale-105 active:scale-95" data-preset="month">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="7" y="13" width="3" height="6" rx="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="11" y="9" width="3" height="10" rx="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="15" y="6" width="3" height="13" rx="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>{{ _('Last 30 Days') }}</span>
                    </button>
                </div>
                
                <!-- Business Quick Filter -->
                <div class="form-control sm:ml-auto">
                    <select id="business_quick" class="select select-sm select-bordered w-full sm:w-56">
                        <option value="">{{ _('All Businesses') }}</option>
                        {% for biz in businesses %}
                        <option value="{{ biz.id }}" {% if current_filters.business_id==biz.id|string %}selected{% endif %}>{{ biz.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Collapsible Filter Form (Hidden by default, controlled by toggle) -->
            <form id="filter-form" class="hidden transition-all duration-300 pt-2">
                <!-- Hidden business_id input -->
                <input type="hidden" id="business_id" name="business_id" value="{{ current_filters.business_id or '' }}">
                
                <!-- Single Row: All Filters -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 items-end">
                    <!-- From Date -->
                    <div class="form-control">
                        <label class="label py-1 px-0">
                            <span class="label-text text-xs font-semibold text-base-content/70">{{ _('From Date') }}</span>
                        </label>
                        <div class="relative">
                            <input
                                    type="date"
                                    id="from_date"
                                    name="from_date"
                                    class="input input-sm input-bordered w-full pr-10 h-9{% if current_filters.from_date %} input-primary{% endif %}"
                                    value="{{ current_filters.from_date }}"
                            />
                            <button type="button"
                                    class="clear-filter-btn absolute right-3 top-1/2 -translate-y-1/2 text-base-content/30 hover:text-base-content/60 opacity-0 transition-all pointer-events-none"
                                    data-field="from_date"
                                    aria-label="{{ _('Clear from date') }}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- To Date -->
                    <div class="form-control">
                        <label class="label py-1 px-0">
                            <span class="label-text text-xs font-semibold text-base-content/70">{{ _('To Date') }}</span>
                        </label>
                        <div class="relative">
                            <input
                                    type="date"
                                    id="to_date"
                                    name="to_date"
                                    class="input input-sm input-bordered w-full pr-10 h-9{% if current_filters.to_date %} input-primary{% endif %}"
                                    value="{{ current_filters.to_date }}"
                            />
                            <button type="button"
                                    class="clear-filter-btn absolute right-3 top-1/2 -translate-y-1/2 text-base-content/30 hover:text-base-content/60 opacity-0 transition-all pointer-events-none"
                                    data-field="to_date"
                                    aria-label="{{ _('Clear to date') }}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="form-control">
                        <label class="label py-1 px-0">
                            <span class="label-text text-xs font-semibold text-base-content/70">{{ _('Status') }}</span>
                        </label>
                        <div class="relative">
                            <select id="status" name="status" class="select select-sm select-bordered w-full pr-10 h-9{% if current_filters.status %} select-primary{% endif %}">
                                <option value="">{{ _('All') }}</option>
                                <option value="OPEN" {% if current_filters.status=='OPEN' %}selected{% endif %}>{{ _('Open') }}</option>
                                <option value="CLOSED" {% if current_filters.status=='CLOSED' %}selected{% endif %}>{{ _('Closed') }}</option>
                            </select>
                            <button type="button"
                                    class="clear-filter-btn absolute right-3 top-1/2 -translate-y-1/2 text-base-content/30 hover:text-base-content/60 opacity-0 transition-all pointer-events-none"
                                    data-field="status"
                                    aria-label="{{ _('Clear status') }}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Cashier Name -->
                    <div class="form-control">
                        <label class="label py-1 px-0">
                            <span class="label-text text-xs font-semibold text-base-content/70">{{ _('Cashier Name') }}</span>
                        </label>
                        <div class="relative">
                            <input
                                    type="text"
                                    id="cashier_name"
                                    name="cashier_name"
                                    class="input input-sm input-bordered w-full pr-10 h-9{% if current_filters.cashier_name %} input-primary{% endif %}"
                                    placeholder="{{ _('Search...') }}"
                                    value="{{ current_filters.cashier_name or '' }}"
                            />
                            <button type="button"
                                    class="clear-filter-btn absolute right-3 top-1/2 -translate-y-1/2 text-base-content/30 hover:text-base-content/60 opacity-0 transition-all pointer-events-none"
                                    data-field="cashier_name"
                                    aria-label="{{ _('Clear cashier name') }}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Clear All Button -->
                    <a href="/" class="btn btn-outline btn-sm px-4 h-9 hover:btn-error transition-all duration-200 hover:scale-105 active:scale-95">{{ _('Clear All') }}</a>
                </div>
            </form>
        </div>
    </div>

        <!-- Stats Row (ONLY FOR ADMIN) -->
    {% if current_user.role == 'ADMIN' %}
    <div id="stats-row"
         hx-get="/stats"
         hx-include="#filter-form"
         hx-trigger="load, #filter-form input changed delay:500ms, #filter-form select changed"
         hx-swap="outerHTML"
         hx-indicator="#stats-loading">
        <div id="stats-loading" class="htmx-indicator">
            <!-- Skeleton: 5 metric cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
                <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
                <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
                <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
                <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
            </div>
        </div>
        <!-- Initial skeleton (shown before HTMX loads) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
            <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
            <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
            <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
            <div class="bg-base-200 rounded-lg h-28 animate-pulse"></div>
        </div>
    </div>
    {% endif %}

    <!-- Sessions Table (HTMX TARGET) -->
    <div id="sessions-table"
         hx-get="/sessions/table{% if include_deleted %}?include_deleted=true{% endif %}"
         hx-include="#filter-form"
         hx-trigger="load"
         hx-swap="innerHTML"
         hx-indicator="#sessions-loading">
        <div id="sessions-loading" class="htmx-indicator">
            <div class="bg-base-100 border border-base-300 rounded-lg shadow-sm p-8">
                <div class="flex flex-col items-center justify-center space-y-4">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                    <p class="text-sm text-base-content/60">{{ _('Loading sessions...') }}</p>
                </div>
            </div>
        </div>
        {% include "partials/sessions_table.html" %}
    </div>
</div>

<script>
    // Get local date (not UTC)
    function getLocalDateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // CRITICAL: Set client dates and redirect if missing
    const urlParams = new URLSearchParams(window.location.search);
    const hasFromDate = urlParams.has('from_date');
    const hasToDate = urlParams.has('to_date');

    if (!hasFromDate || !hasToDate) {
        const today = getLocalDateString();
        urlParams.set('from_date', today);
        urlParams.set('to_date', today);
        window.location.search = urlParams.toString();
    }

    // Filter Toggle
    const filterToggle = document.getElementById('filter-toggle');
    const filterForm = document.getElementById('filter-form');
    const filterChevron = document.getElementById('filter-chevron');

    filterToggle.addEventListener('click', function () {
        const isExpanded = filterForm.classList.contains('hidden');
        filterForm.classList.toggle('hidden');
        filterChevron.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
        filterToggle.setAttribute('aria-expanded', isExpanded);
    });


    // Helper to trigger both stats and table updates
    function applyFilters() {
        const params = new URLSearchParams(new FormData(document.getElementById('filter-form')));
        const includeDeletedToggle = document.getElementById('include-deleted-toggle');
        if (includeDeletedToggle && includeDeletedToggle.checked) {
            params.set('include_deleted', 'true');
        }
        const queryString = '?' + params.toString();

        window.history.pushState({}, '', queryString);
        
        // Update visual indicators on inputs
        updateFilterIndicators();

        // Only load stats if element exists (Admin only)
        // Stats should NEVER include deleted sessions
        const statsRow = document.getElementById('stats-row');
        if (statsRow) {
            const statsParams = new URLSearchParams(params);
            statsParams.delete('include_deleted'); // Remove include_deleted from stats
            htmx.ajax('GET', '/stats?' + statsParams.toString(), '#stats-row');
        }

        htmx.ajax('GET', '/sessions/table' + queryString, '#sessions-table');
    }
    
    // Update visual indicators on filter inputs
    function updateFilterIndicators() {
        const inputs = {
            'from_date': document.getElementById('from_date'),
            'to_date': document.getElementById('to_date'),
            'status': document.getElementById('status'),
            'cashier_name': document.getElementById('cashier_name')
        };
        
        Object.entries(inputs).forEach(([id, input]) => {
            if (!input) return;
            const hasValue = input.value && input.value.trim() !== '';
            if (hasValue) {
                input.classList.add('input-primary');
                if (input.tagName === 'SELECT') {
                    input.classList.add('select-primary');
                }
            } else {
                input.classList.remove('input-primary');
                if (input.tagName === 'SELECT') {
                    input.classList.remove('select-primary');
                }
            }
        });
    }

    // Mark active preset button
    function setActivePreset(preset) {
        document.querySelectorAll('.preset-btn').forEach(btn => {
            if (btn.dataset.preset === preset) {
                btn.classList.remove('btn-outline');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            }
        });
    }

    // Check which preset matches current dates on load
    function detectActivePreset() {
        const fromDate = document.getElementById('from_date').value;
        const toDate = document.getElementById('to_date').value;
        
        function formatLocalDate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        const now = new Date();
        const today = formatLocalDate(now);
        
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = formatLocalDate(yesterday);
        
        // Last 7 days: today - 6 days to today (7 days total)
        const weekStartDate = new Date(now);
        weekStartDate.setDate(weekStartDate.getDate() - 6);
        const weekStart = formatLocalDate(weekStartDate);
        const weekEndStr = today;
        
        // Last 30 days: today - 29 days to today (30 days total)
        const monthStartDate = new Date(now);
        monthStartDate.setDate(monthStartDate.getDate() - 29);
        const monthStart = formatLocalDate(monthStartDate);
        const monthEnd = today;
        
        if (fromDate === today && toDate === today) {
            setActivePreset('today');
        } else if (fromDate === yesterdayStr && toDate === yesterdayStr) {
            setActivePreset('yesterday');
        } else if (fromDate === weekStart && toDate === weekEndStr) {
            setActivePreset('week');
        } else if (fromDate === monthStart && toDate === monthEnd) {
            setActivePreset('month');
        }
    }

    // Preset button handlers
    document.querySelectorAll('[data-preset]').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const preset = this.dataset.preset;
            const now = new Date();
            let startDate, endDate;

            if (preset === 'today') {
                startDate = endDate = now;
            } else if (preset === 'yesterday') {
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 1);
                endDate = startDate;
            } else if (preset === 'week') {
                // Last 7 days: today - 6 days to today (7 days total)
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 6);
                endDate = new Date(now);
            } else if (preset === 'month') {
                // Last 30 days: today - 29 days to today (30 days total)
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 29);
                endDate = new Date(now);
            }

            function formatLocalDate(d) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            document.getElementById('from_date').value = formatLocalDate(startDate);
            document.getElementById('to_date').value = formatLocalDate(endDate);

            setActivePreset(preset);
            updateReconciliationLinks();
            applyFilters();
        });
    });

    // Detect active preset on page load
    detectActivePreset();
    
    // Initialize filter indicators
    updateFilterIndicators();

    // Update reconciliation links with current filter date
    function updateReconciliationLinks() {
        const fromDateInput = document.getElementById('from_date');
        const toDateInput = document.getElementById('to_date');
        const addReconLink = document.getElementById('add-reconciliation-link');
        const viewReconLink = document.getElementById('view-reconciliations-link');
        
        if (!fromDateInput || !toDateInput) return;
        
        const fromDate = fromDateInput.value;
        const toDate = toDateInput.value;
        
        // Use to_date if available, otherwise from_date, otherwise today
        let selectedDate = toDate || fromDate;
        if (!selectedDate) {
            const today = new Date();
            selectedDate = today.toISOString().split('T')[0];
        }
        
        // If both dates are the same, use that date; otherwise use to_date
        if (fromDate && toDate && fromDate === toDate) {
            selectedDate = fromDate;
        } else if (toDate) {
            selectedDate = toDate;
        } else if (fromDate) {
            selectedDate = fromDate;
        }
        
        // Update links if they exist
        if (addReconLink) {
            addReconLink.href = `/reconciliation/daily?date=${selectedDate}`;
        }
        if (viewReconLink) {
            viewReconLink.href = `/admin/reconciliation/compare?date=${selectedDate}`;
        }
    }
    
    // Update reconciliation links on page load and filter changes
    updateReconciliationLinks();
    
    // Filter form change handler
    document.getElementById('filter-form').addEventListener('change', function() {
        applyFilters();
        updateReconciliationLinks();
    });
    
    // Toggle deleted sessions (Admin only)
    function toggleDeletedSessions() {
        const toggle = document.getElementById('include-deleted-toggle');
        const includeDeleted = toggle.checked;
        const urlParams = new URLSearchParams(window.location.search);
        
        if (includeDeleted) {
            urlParams.set('include_deleted', 'true');
        } else {
            urlParams.delete('include_deleted');
        }
        
        window.location.search = urlParams.toString();
    }

    // Business quick filter handler
    document.getElementById('business_quick').addEventListener('change', function() {
        document.getElementById('business_id').value = this.value;
        applyFilters();
    });

    // Filter field clear handlers
    document.querySelectorAll('.clear-filter-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const field = this.dataset.field;
            document.getElementById(field).value = '';
            applyFilters();
        });
    });

    // Show clear button on input
    document.querySelectorAll('#filter-form input, #filter-form select').forEach(input => {
        input.addEventListener('focus', function () {
            if (this.value) {
                this.parentElement.querySelector('.clear-filter-btn')?.classList.remove('opacity-0', 'pointer-events-none');
            }
        });
        input.addEventListener('blur', function () {
            if (!this.value) {
                this.parentElement.querySelector('.clear-filter-btn')?.classList.add('opacity-0', 'pointer-events-none');
            }
        });
    });
</script>
{% endblock %}