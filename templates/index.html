<!-- File: templates/index.html -->

{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - CashPilot{% endblock %}

{% block content %}
<div class="grid grid-cols-1 gap-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-bold">{{ _('Dashboard') }}</h1>
        <a href="/sessions/create" class="btn btn-primary">{{ _('+ New Session') }}</a>
    </div>

    <!-- Stats Row (HTMX TARGET) -->
    <div id="stats-row"
         hx-get="/stats"
         hx-include="#filter-form"
         hx-trigger="load"
         hx-swap="outerHTML">
        <!-- Skeleton while loading -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="stat bg-base-100 rounded-lg shadow animate-pulse h-24"></div>
            <div class="stat bg-base-100 rounded-lg shadow animate-pulse h-24"></div>
            <div class="stat bg-base-100 rounded-lg shadow animate-pulse h-24"></div>
            <div class="stat bg-base-100 rounded-lg shadow animate-pulse h-24"></div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h3 class="card-title">{{ _('Filters') }}</h3>

            <!-- Preset Buttons -->
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text text-sm font-semibold">{{ _('Quick Presets') }}</span>
                </label>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="btn btn-sm btn-outline" data-preset="today">
                        {{ _('Today') }}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline" data-preset="week">
                        {{ _('This Week') }}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline" data-preset="month">
                        {{ _('This Month') }}
                    </button>
                </div>
            </div>

            <form id="filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <!-- Date From -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm">{{ _('From Date') }}</span>
                    </label>
                    <input
                        type="date"
                        id="from_date"
                        name="from_date"
                        class="input input-bordered input-sm"
                        value="{{ current_filters.from_date }}"
                        hx-get="/sessions/table"
                        hx-include="#filter-form"
                        hx-target="#sessions-table"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        hx-on="change: htmx.ajax('GET', '/stats?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target:'#stats-row', swap:'outerHTML'})"
                    />
                </div>

                <!-- Date To -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm">{{ _('To Date') }}</span>
                    </label>
                    <input
                        type="date"
                        id="to_date"
                        name="to_date"
                        class="input input-bordered input-sm"
                        value="{{ current_filters.to_date }}"
                        hx-get="/sessions/table"
                        hx-include="#filter-form"
                        hx-target="#sessions-table"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        hx-on="change: htmx.ajax('GET', '/stats?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target:'#stats-row', swap:'outerHTML'})"
                    />
                </div>

                <!-- Cashier Name -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm">{{ _('Cashier Name') }}</span>
                    </label>
                    <input
                        type="text"
                        name="cashier_name"
                        class="input input-bordered input-sm"
                        placeholder="{{ _('Search...') }}"
                        value="{{ current_filters.cashier_name or '' }}"
                        hx-get="/sessions/table"
                        hx-include="#filter-form"
                        hx-target="#sessions-table"
                        hx-swap="innerHTML"
                        hx-trigger="changed delay:500ms"
                        hx-on="changed: htmx.ajax('GET', '/stats?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target:'#stats-row', swap:'outerHTML'})"
                    />
                </div>

                <!-- Session Status -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm">{{ _('Status') }}</span>
                    </label>
                    <select
                        name="status"
                        class="select select-bordered select-sm"
                        hx-get="/sessions/table"
                        hx-include="#filter-form"
                        hx-target="#sessions-table"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        hx-on="change: htmx.ajax('GET', '/stats?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target:'#stats-row', swap:'outerHTML'})"
                    >
                        <option value="">{{ _('All Statuses') }}</option>
                        <option value="OPEN" {% if current_filters.status == 'OPEN' %}selected{% endif %}>{{ _('Open') }}</option>
                        <option value="CLOSED" {% if current_filters.status == 'CLOSED' %}selected{% endif %}>{{ _('Closed') }}</option>
                    </select>
                </div>

                <!-- Business Dropdown -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm">{{ _('Business') }}</span>
                    </label>
                    <select
                        name="business_id"
                        class="select select-bordered select-sm"
                        hx-get="/sessions/table"
                        hx-include="#filter-form"
                        hx-target="#sessions-table"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        hx-on="change: htmx.ajax('GET', '/stats?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target:'#stats-row', swap:'outerHTML'})"
                    >
                        <option value="">{{ _('All Businesses') }}</option>
                        {% for biz in businesses %}
                            <option value="{{ biz.id }}" {% if current_filters.business_id == biz.id|string %}selected{% endif %}>
                                {{ biz.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Clear Filters Button -->
                <div class="form-control">
                    <a href="/" class="btn btn-outline btn-sm">{{ _('Clear Filters') }}</a>
                </div>
            </form>

            <!-- Active Filters Chips -->
            {% if active_filters.from_date or active_filters.to_date or active_filters.cashier_name or active_filters.business_id or active_filters.status %}
            <div class="mt-4">
                <div class="flex flex-wrap gap-2">
                    {% if active_filters.from_date %}
                        <div class="badge badge-primary gap-2">
                            {{ _('From:') }} {{ active_filters.from_date }}
                        </div>
                    {% endif %}
                    {% if active_filters.to_date %}
                        <div class="badge badge-primary gap-2">
                            {{ _('To:') }} {{ active_filters.to_date }}
                        </div>
                    {% endif %}
                    {% if active_filters.cashier_name %}
                        <div class="badge badge-primary gap-2">
                            {{ _('Cashier:') }} {{ active_filters.cashier_name }}
                        </div>
                    {% endif %}
                    {% if active_filters.business_id %}
                        <div class="badge badge-primary gap-2">
                            {{ _('Business:') }}
                            {% for biz in businesses %}
                                {% if biz.id|string == active_filters.business_id %}{{ biz.name }}{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if active_filters.status %}
                        <div class="badge badge-primary gap-2">
                            {{ _('Status:') }}
                            {% if active_filters.status == 'OPEN' %}
                                {{ _('Open') }}
                            {% elif active_filters.status == 'CLOSED' %}
                                {{ _('Closed') }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sessions Table (HTMX TARGET) -->
    <div id="sessions-table"
         hx-get="/sessions/table"
         hx-include="#filter-form"
         hx-trigger="load"
         hx-swap="innerHTML">
        {% include "partials/sessions_table.html" %}
    </div>
</div>

<script>
// Date preset logic
document.querySelectorAll('[data-preset]').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        const preset = e.target.dataset.preset;
        const today = new Date();
        let fromDate, toDate;

        if (preset === 'today') {
            fromDate = toDate = today;
        } else if (preset === 'week') {
            // Monday to Sunday of current week
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            fromDate = new Date(today.setDate(diff));
            toDate = new Date(fromDate);
            toDate.setDate(toDate.getDate() + 6);
        } else if (preset === 'month') {
            // First to last day of current month
            fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
            toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        }

        // Set input values in YYYY-MM-DD format
        document.getElementById('from_date').value = fromDate.toISOString().split('T')[0];
        document.getElementById('to_date').value = toDate.toISOString().split('T')[0];

        // Trigger both table and stats updates
        htmx.ajax('GET', '/sessions/table?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target: '#sessions-table', swap: 'innerHTML'});
        htmx.ajax('GET', '/stats?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(), {target: '#stats-row', swap: 'outerHTML'});
    });
});
</script>
{% endblock %}