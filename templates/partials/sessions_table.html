<!-- File: templates/partials/sessions_table.html -->
<div class="bg-base-100 border border-base-300 rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
    <div class="p-4 md:p-6">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
            <div class="flex items-center gap-2">
                <h2 class="text-sm font-bold uppercase tracking-widest text-base-content/70 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    {{ _('Cash Sessions') }}
                </h2>
                {% if total_sessions is defined %}
                <span class="badge badge-sm badge-ghost text-xs">{{ total_sessions }} {% if total_sessions == 1 %}{{ _('session') }}{% else %}{{ _('sessions') }}{% endif %}</span>
                {% endif %}
            </div>
            <div class="flex gap-2 items-center">
                <a href="/sessions/create" class="btn btn-primary btn-sm gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    {{ _('Open Cash Session') }}
                </a>
                {% if current_user.role == 'ADMIN' %}
                <div class="dropdown dropdown-end">
                    <button tabindex="0" class="btn btn-success btn-sm gap-2 transition-all hover:scale-105 active:scale-95">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        {{ _('Actions') }}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-lg w-56 border border-base-200 mt-2">
                        <li class="menu-title">{{ _('Reconciliation') }}</li>
                        <li>
                            <a href="/reconciliation/daily" id="add-reconciliation-link" class="gap-2 transition-colors hover:bg-primary/10">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                {{ _('Add Reconciliation') }}
                            </a>
                        </li>
                        <li>
                            <a href="/admin/reconciliation/compare" id="view-reconciliations-link" class="gap-2 transition-colors hover:bg-primary/10">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                {{ _('View Reconciliations') }}
                            </a>
                        </li>
                        <li class="menu-title mt-2">{{ _('Export') }}</li>
                        <li>
                            <a href="#" onclick="exportSessions('csv'); return false;" class="gap-2 transition-colors hover:bg-success/10">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                {{ _('Export as CSV') }}
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="exportSessions('xlsx'); return false;" class="gap-2 transition-colors hover:bg-success/10">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                {{ _('Export as Excel') }}
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>

        <style>
            /* Hover tint */
            .table tbody tr.session-row:hover td {
                background-color: hsl(var(--p) / 0.10) !important;
            }
        
            .table tbody tr.session-row.flagged:hover td {
                background-color: hsl(var(--er) / 0.14) !important;
            }
        
            /* Horizontal borders between rows */
            .table tbody tr {
                border-bottom: 1px solid hsl(var(--b2));
            }
        
            /* Vertical borders between columns */
            .table tbody td:not(:last-child),
            .table thead th:not(:last-child) {
                border-right: 1px solid hsl(var(--bc) / 0.1);
            }

            /* Sortable column headers */
            .sortable-header {
                cursor: pointer;
                user-select: none;
                position: relative;
                padding-right: 1.5rem;
            }

            .sortable-header:hover {
                background-color: hsl(var(--b2));
            }

            .sort-icon {
                position: absolute;
                right: 0.25rem;
                top: 50%;
                transform: translateY(-50%);
                opacity: 0.3;
            }

            .sortable-header.active .sort-icon {
                opacity: 1;
            }
        </style>

        {% if sessions %}
        <!-- Desktop Table (hidden on mobile) -->
        <div class="overflow-x-auto hidden lg:block">
            <table class="table table-sm w-full">
                <thead>
                    <tr class="border-b border-base-300">
                        <th class="text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50 sortable-header{% if sort_by == 'status' %} active{% endif %}"
                            onclick="sortTable('status')" title="{{ _('Click to sort') }}">
                            {{ _('Status') }}
                            <span class="sort-icon">{% if sort_by == 'status' and sort_order == 'asc' %}↑{% else %}↓{% endif %}</span>
                        </th>
                        <th class="text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50 p-0">
                            <div class="flex">
                                <div class="flex-1 sortable-header{% if sort_by == 'cashier' %} active{% endif %} text-center" onclick="sortTable('cashier')" title="{{ _('Click to sort by cashier') }}">
                                    {{ _('Cashier') }}
                                    <span class="sort-icon">{% if sort_by == 'cashier' and sort_order == 'asc' %}↑{% else %}↓{% endif %}</span>
                                </div>
                                <div class="flex-1 sortable-header{% if sort_by == 'business' %} active{% endif %} text-center" onclick="sortTable('business')" title="{{ _('Click to sort by business') }}">
                                    {{ _('Business') }}
                                    <span class="sort-icon">{% if sort_by == 'business' and sort_order == 'asc' %}↑{% else %}↓{% endif %}</span>
                                </div>
                            </div>
                        </th>
                        <th class="text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50 sortable-header{% if sort_by == 'date' %} active{% endif %}"
                            onclick="sortTable('date')" title="{{ _('Click to sort') }}">
                            {{ _('Date & Time') }}
                            <span class="sort-icon">{% if sort_by == 'date' and sort_order == 'asc' %}↑{% else %}↓{% endif %}</span>
                        </th>
                        <th class="text-right text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50">{{ _('Register') }}</th>
                        <th class="text-right text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50">{{ _('Cash Sales') }}</th>
                        <th class="text-right text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50">{{ _('Cards') }}</th>
                        <th class="text-right text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50">{{ _('Transfer') }}</th>
                        <th class="text-right text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50 sortable-header{% if sort_by == 'sales' %} active{% endif %}"
                            onclick="sortTable('sales')" title="{{ _('Click to sort') }}">
                            {{ _('Sales Total') }}
                            <span class="sort-icon">{% if sort_by == 'sales' and sort_order == 'asc' %}↑{% else %}↓{% endif %}</span>
                        </th>
                        <th class="text-center text-xs font-bold uppercase tracking-wider text-base-content/60 bg-base-50">{{ _('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr class="session-row transition-all duration-200 cursor-pointer hover:shadow-md border-l-2 border-transparent hover:!border-primary/70{% if session.is_deleted %} border-l-4 border-base-content/30 bg-base-200/50 hover:bg-base-200/70 opacity-75{% elif session.status == 'CLOSED' and session.flagged %} flagged border-l-4 border-error bg-error/10 hover:bg-error/20{% endif %}" {% if not session.is_deleted %}onclick="window.location.href='/sessions/{{ session.id|string }}'" onkeydown="if(event.key==='Enter'||event.key===' '){window.location.href='/sessions/{{ session.id|string }}';}"{% endif %} role="button" tabindex="0" aria-label="{{ _('View session') }}">
                        <!-- Status -->
                        <td onclick="event.stopPropagation()">
                            {% if session.is_deleted %}
                                <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-base-300 dark:bg-base-700 text-xs font-medium text-base-content/60">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    {{ _('Deleted') }}
                                </span>
                            {% elif session.status == 'OPEN' %}
                                <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-sky-50 dark:bg-sky-950/50 text-xs font-medium text-sky-700 dark:text-sky-300">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                    </svg>
                                    {{ _('Open') }}
                                </span>
                            {% elif session.status == 'CLOSED' and session.flagged %}
                                <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-amber-50 dark:bg-amber-950/50 text-xs font-medium text-amber-700 dark:text-amber-300">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                    {{ _('Review') }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-emerald-50 dark:bg-emerald-950/50 text-xs font-medium text-emerald-700 dark:text-emerald-300">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    {{ _('Closed') }}
                                </span>
                            {% endif %}
                        </td>
                        <!-- Cashier / Business -->
                        <td>
                            <div class="font-semibold text-sm text-base-content">{{ session.cashier.display_name }}</div>
                            <div class="text-xs text-base-content/60">{{ session.business.name }}</div>
                        </td>
                        <!-- Date & Time -->
                        <td class="text-xs text-base-content/70 font-mono">
                            <div><span class="font-semibold">#{{ "%03d" | format(session.session_number) }}</span> • {{ session.session_date.strftime('%d/%m/%Y') }}</div>
                            <div class="opacity-80">
                                {{ session.opened_at | format_time_business if session.opened_at else '' }}
                                {% if session.closed_at %}
                                    → {{ session.closed_at | format_time_business }}
                                {% else %}
                                    → <span class="text-sky-600 dark:text-sky-400">{{ _('Open') }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <!-- Cash Flow -->
                        <td class="text-right text-xs">
                            <div>Gs {{ session.initial_cash | format_currency_py }} → {% if session.final_cash %}{{ session.final_cash | format_currency_py }}{% else %}<span class="text-sky-600 dark:text-sky-400">{{ _('Open') }}</span>{% endif %}</div>
                            {% if session.envelope_amount and session.envelope_amount > 0 %}
                                <div class="text-[10px] text-base-content/60">└─ {{ _('Envelope') }}: Gs {{ session.envelope_amount | format_currency_py }}</div>
                            {% endif %}
                        </td>
                        <!-- Cash Sales -->
                        <td class="text-right text-sm">Gs {{ session.cash_sales | format_currency_py }}</td>
                        <!-- Card Sales -->
                        <td class="text-right text-sm">Gs {{ session.card_total | format_currency_py }}</td>
                        <!-- Bank Transfer -->
                        <td class="text-right text-sm">Gs {{ session.bank_transfer_total | format_currency_py }}</td>
                        <!-- Sales Total -->
                        <td class="text-right text-sm font-bold text-base-content">Gs {{ (session.cash_sales + session.card_total + session.bank_transfer_total) | format_currency_py }}</td>
                        <!-- Actions -->
                        <td class="text-center" onclick="event.stopPropagation()">
                            <div class="flex gap-1 justify-center">
                                {% if session.is_deleted %}
                                    <!-- Restore button (Admin only) -->
                                    {% if current_user.role == 'ADMIN' %}
                                        <button
                                            hx-post="/sessions/{{ session.id|string }}/restore"
                                            hx-confirm="{{ _('Restore this deleted session?') }}"
                                            hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                            class="btn btn-ghost btn-xs btn-circle hover:!bg-success/20 focus-visible:ring-2 focus-visible:ring-success/30"
                                            title="{{ _('Restore session') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                        </button>
                                    {% endif %}
                                {% elif session.status == 'OPEN' %}
                                    {% if current_user.role == 'ADMIN' or session.created_by == current_user.id %}
                                        <!-- Edit icon -->
                                        <a href="/sessions/{{ session.id|string }}/edit-open" 
                                           class="btn btn-ghost btn-xs btn-circle hover:!bg-primary/20 focus-visible:ring-2 focus-visible:ring-primary/30" 
                                           title="{{ _('Edit session') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </a>
                                        <!-- Close icon -->
                                        <a href="/sessions/{{ session.id|string }}/edit" 
                                           class="btn btn-ghost btn-xs btn-circle hover:!bg-primary/20 focus-visible:ring-2 focus-visible:ring-primary/30" 
                                           title="{{ _('Close session') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                            </svg>
                                        </a>
                                    {% else %}
                                        <button disabled class="btn btn-ghost btn-xs btn-circle opacity-40 cursor-not-allowed" 
                                                title="{{ _('Only admins and session creator can edit') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </button>
                                        <button disabled class="btn btn-ghost btn-xs btn-circle opacity-40 cursor-not-allowed" 
                                                title="{{ _('Only admins and session creator can close') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                            </svg>
                                        </button>
                                    {% endif %}
                                
                                {% elif session.status == 'CLOSED' %}
                                    <!-- Edit closed session -->
                                    {% if current_user.role == 'ADMIN' or (current_user.id == session.cashier_id) %}
                                        {% if session.can_edit_closed is defined and session.can_edit_closed %}
                                            <a href="/sessions/{{ session.id|string }}/edit-closed" 
                                               class="btn btn-ghost btn-xs btn-circle hover:!bg-primary/20 focus-visible:ring-2 focus-visible:ring-primary/30" 
                                               title="{{ _('Edit closed session') }}">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </a>
                                        {% else %}
                                            <div class="tooltip tooltip-left" data-tip="{{ _('Edit window expired (32 hours passed)') }}">
                                                <button disabled class="btn btn-ghost btn-xs btn-circle opacity-50 cursor-not-allowed" title="{{ _('Edit window expired (32 hours passed)') }}">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                
                                <!-- Delete icon (only show if session is not deleted) -->
                                {% if not session.is_deleted %}
                                    {% if current_user.role == 'ADMIN' %}
                                        <button
                                            hx-delete="/cash-sessions/{{ session.id|string }}"
                                            hx-confirm="{{ _('Delete this session? This can be undone by admins.') }}"
                                            hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                            class="btn btn-ghost btn-xs btn-circle hover:!bg-error/20 focus-visible:ring-2 focus-visible:ring-error/30"
                                            title="{{ _('Delete session') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    {% elif session.cashier_id == current_user.id %}
                                        {% if session.status == 'CLOSED' %}
                                            {% if session.can_edit_closed is defined and session.can_edit_closed %}
                                                <button
                                                    hx-delete="/cash-sessions/{{ session.id|string }}"
                                                    hx-confirm="{{ _('Delete this session? This can be undone by admins.') }}"
                                                    hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                                    class="btn btn-ghost btn-xs btn-circle hover:!bg-error/20 focus-visible:ring-2 focus-visible:ring-error/30"
                                                    title="{{ _('Delete session') }}">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                </button>
                                            {% else %}
                                                <div class="tooltip tooltip-left" data-tip="{{ _('Cannot modify session after 32 hours') }}">
                                                    <button disabled class="btn btn-ghost btn-xs btn-circle opacity-40 cursor-not-allowed" 
                                                            title="{{ _('Cannot modify session after 32 hours') }}">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <button
                                                hx-delete="/cash-sessions/{{ session.id|string }}"
                                                hx-confirm="{{ _('Delete this session? This can be undone by admins.') }}"
                                                hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                                class="btn btn-ghost btn-xs btn-circle hover:!bg-error/20 focus-visible:ring-2 focus-visible:ring-error/30"
                                                title="{{ _('Delete session') }}">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <button disabled class="btn btn-ghost btn-xs btn-circle opacity-40 cursor-not-allowed" 
                                                title="{{ _('Only admins and session creator can delete') }}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Card Layout (visible on mobile only) -->
        <div class="lg:hidden grid grid-cols-1 gap-4">
            {% for session in sessions %}
            <div class="border border-base-300 rounded-lg p-4 space-y-3 bg-base-100{% if session.is_deleted %} bg-base-200/50 border-l-4 border-base-content/30 opacity-75{% elif session.status == 'CLOSED' and session.flagged %} bg-error/10 border-l-4 border-error{% else %} cursor-pointer hover:shadow-lg transition-all duration-200 hover:scale-[1.01]{% endif %}" {% if not session.is_deleted %}onclick="window.location.href='/sessions/{{ session.id|string }}'" onkeydown="if(event.key==='Enter'||event.key===' '||event.key==='Spacebar'){event.preventDefault();window.location.href='/sessions/{{ session.id|string }}';}" role="button" tabindex="0"{% endif %}>
                <!-- Status Badge -->
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-base text-base-content">{{ session.cashier.display_name }}</h3>
                        <p class="text-sm text-base-content/70">{{ session.business.name }}</p>
                    </div>
                    {% if session.is_deleted %}
                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-base-300 dark:bg-base-700 text-xs font-medium text-base-content/60">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            {{ _('Deleted') }}
                        </span>
                    {% elif session.status == 'OPEN' %}
                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-sky-50 dark:bg-sky-950/50 text-xs font-medium text-sky-700 dark:text-sky-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                            </svg>
                            {{ _('Open') }}
                        </span>
                    {% elif session.status == 'CLOSED' and session.flagged %}
                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-amber-50 dark:bg-amber-950/50 text-xs font-medium text-amber-700 dark:text-amber-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            {{ _('Review') }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md bg-emerald-50 dark:bg-emerald-950/50 text-xs font-medium text-emerald-700 dark:text-emerald-300">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            {{ _('Closed') }}
                        </span>
                    {% endif %}
                </div>

                <!-- Date & Period -->
                <div class="space-y-1 py-2 border-b border-base-200">
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs text-base-content/60">{{ _('Session') }}</span>
                        <span class="font-semibold text-sm font-mono">#{{ "%03d" | format(session.session_number) }}</span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs text-base-content/60">{{ _('Date') }}</span>
                        <span class="font-semibold text-sm font-mono">{{ session.session_date.strftime('%d/%m/%Y') }}</span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs text-base-content/60">{{ _('Time') }}</span>
                        <span class="text-sm font-mono">
                            {{ session.opened_at | format_time_business if session.opened_at else '—' }}
                            →
                            {% if session.closed_at %}
                                {{ session.closed_at | format_time_business }}
                            {% else %}
                                <span class="font-semibold text-sky-600 dark:text-sky-400">{{ _('Open') }}</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Financial Summary -->
                <div class="space-y-2 py-2">
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs text-base-content/60">{{ _('Register') }}</span>
                        <span class="text-sm font-mono">Gs {{ session.initial_cash | format_currency_py }} → {% if session.final_cash %}{{ session.final_cash | format_currency_py }}{% else %}<span class="font-semibold text-sky-600 dark:text-sky-400">{{ _('Open') }}</span>{% endif %}</span>
                    </div>
                    {% if session.envelope_amount and session.envelope_amount > 0 %}
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs text-base-content/60 pl-3">└─ {{ _('Envelope') }}</span>
                        <span class="text-sm font-mono">Gs {{ session.envelope_amount | format_currency_py }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between items-baseline pt-2 border-t border-base-200">
                        <span class="text-xs font-semibold text-base-content/80">{{ _('Sales Total') }}</span>
                        <span class="text-base font-bold font-mono">Gs {{ (session.cash_sales + session.card_total + session.bank_transfer_total) | format_currency_py }}</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 pt-2 border-t border-base-200" onclick="event.stopPropagation()">
                    {% if session.is_deleted %}
                        <!-- Restore button (Admin only) -->
                        {% if current_user.role == 'ADMIN' %}
                            <button
                                hx-post="/sessions/{{ session.id|string }}/restore"
                                hx-confirm="{{ _('Restore this deleted session?') }}"
                                hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                class="btn btn-success btn-xs flex-1 hover:!bg-success/20 focus-visible:ring-2 focus-visible:ring-success/30"
                                title="{{ _('Restore session') }}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                {{ _('Restore') }}
                            </button>
                        {% endif %}
                    {% elif session.status == 'OPEN' %}
                        {% if current_user.role == 'ADMIN' or session.created_by == current_user.id %}
                            <a href="/sessions/{{ session.id|string }}/edit-open" class="btn btn-ghost btn-xs flex-1 hover:!bg-primary/20 focus-visible:ring-2 focus-visible:ring-primary/30">{{ _('Edit') }}</a>
                            <a href="/sessions/{{ session.id|string }}/edit" class="btn btn-primary btn-xs flex-1">{{ _('Close') }}</a>
                        {% else %}
                            <button disabled class="btn btn-ghost btn-xs flex-1 opacity-40 cursor-not-allowed" title="{{ _('Only admins and session creator can edit') }}">{{ _('Edit') }}</button>
                            <button disabled class="btn btn-primary btn-xs flex-1 opacity-40 cursor-not-allowed" title="{{ _('Only admins and session creator can close') }}">{{ _('Close') }}</button>
                        {% endif %}
                    {% elif session.status == 'CLOSED' %}
                        {% if current_user.role == 'ADMIN' or (current_user.id == session.cashier_id) %}
                            {% if session.can_edit_closed is defined and session.can_edit_closed %}
                                <a href="/sessions/{{ session.id|string }}/edit-closed" class="btn btn-ghost btn-xs flex-1 hover:!bg-primary/20 focus-visible:ring-2 focus-visible:ring-primary/30" title="{{ _('Edit closed session') }}">{{ _('Edit') }}</a>
                            {% else %}
                                <button disabled class="btn btn-ghost btn-xs flex-1 opacity-50 cursor-not-allowed" title="{{ _('Edit window expired (32 hours passed)') }}">{{ _('Edit') }}</button>
                            {% endif %}
                        {% endif %}
                    {% endif %}

                    <!-- Delete button (only show if session is not deleted) -->
                    {% if not session.is_deleted %}
                        {% if current_user.role == 'ADMIN' %}
                            <button
                                hx-delete="/cash-sessions/{{ session.id|string }}"
                                hx-confirm="{{ _('Delete this session? This can be undone by admins.') }}"
                                hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                class="btn btn-ghost btn-xs flex-1 hover:!bg-error/20 focus-visible:ring-2 focus-visible:ring-error/30"
                                title="{{ _('Delete session') }}">
                                {{ _('Delete') }}
                            </button>
                        {% elif session.cashier_id == current_user.id %}
                            {% if session.status == 'CLOSED' %}
                                {% if session.can_edit_closed is defined and session.can_edit_closed %}
                                    <button
                                        hx-delete="/cash-sessions/{{ session.id|string }}"
                                        hx-confirm="{{ _('Delete this session? This can be undone by admins.') }}"
                                        hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                        class="btn btn-ghost btn-xs flex-1 hover:!bg-error/20 focus-visible:ring-2 focus-visible:ring-error/30"
                                        title="{{ _('Delete session') }}">
                                        {{ _('Delete') }}
                                    </button>
                                {% else %}
                                    <button disabled class="btn btn-ghost btn-xs flex-1 opacity-40 cursor-not-allowed" title="{{ _('Cannot modify session after 32 hours') }}">
                                        {{ _('Delete') }}
                                    </button>
                                {% endif %}
                            {% else %}
                                <button
                                    hx-delete="/cash-sessions/{{ session.id|string }}"
                                    hx-confirm="{{ _('Delete this session? This can be undone by admins.') }}"
                                    hx-on="htmx:afterRequest: if(event.detail.successful) window.location.reload()"
                                    class="btn btn-ghost btn-xs flex-1 hover:!bg-error/20 focus-visible:ring-2 focus-visible:ring-error/30"
                                    title="{{ _('Delete session') }}">
                                    {{ _('Delete') }}
                                </button>
                            {% endif %}
                        {% else %}
                            <button disabled class="btn btn-ghost btn-xs flex-1 opacity-40 cursor-not-allowed" title="{{ _('Only admins and session creator can delete') }}">
                                {{ _('Delete') }}
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-6 pt-6 border-t border-base-300">
            <p class="text-xs text-base-content/60">
                {{ _('Showing') }} <span class="font-semibold">{{ (page - 1) * 10 + 1 }}-{{ [page * 10, total_sessions] | min }}</span> {{ _('of') }} <span class="font-semibold">{{ total_sessions }}</span>
            </p>
            <div class="join">
                {% set pagination_params = query_string %}
                {% if include_deleted %}
                    {% if pagination_params %}
                        {% set pagination_params = pagination_params + "&include_deleted=true" %}
                    {% else %}
                        {% set pagination_params = "&include_deleted=true" %}
                    {% endif %}
                {% endif %}
                {% if page > 1 %}
                    <a href="/sessions/table?page=1{{ pagination_params }}" hx-get="/sessions/table?page=1{{ pagination_params }}" hx-target="#sessions-table" hx-swap="innerHTML" class="join-item btn btn-sm btn-ghost" title="{{ _('First page') }}">«</a>
                    <a href="/sessions/table?page={{ page - 1 }}{{ pagination_params }}" hx-get="/sessions/table?page={{ page - 1 }}{{ pagination_params }}" hx-target="#sessions-table" hx-swap="innerHTML" class="join-item btn btn-sm btn-ghost" title="{{ _('Previous page') }}">‹</a>
                {% endif %}
                {% set page_start = [1, page - 2] | max %}
                {% set page_end = [total_pages + 1, page + 3] | min %}
                {% for p in range(page_start, page_end) %}
                    {% if p == page %}
                        <button class="join-item btn btn-sm btn-primary">{{ p }}</button>
                    {% else %}
                        <a href="/sessions/table?page={{ p }}{{ pagination_params }}" hx-get="/sessions/table?page={{ p }}{{ pagination_params }}" hx-target="#sessions-table" hx-swap="innerHTML" class="join-item btn btn-sm btn-ghost">{{ p }}</a>
                    {% endif %}
                {% endfor %}
                {% if page < total_pages %}
                    <a href="/sessions/table?page={{ page + 1 }}{{ pagination_params }}" hx-get="/sessions/table?page={{ page + 1 }}{{ pagination_params }}" hx-target="#sessions-table" hx-swap="innerHTML" class="join-item btn btn-sm btn-ghost" title="{{ _('Next page') }}">›</a>
                    <a href="/sessions/table?page={{ total_pages }}{{ pagination_params }}" hx-get="/sessions/table?page={{ total_pages }}{{ pagination_params }}" hx-target="#sessions-table" hx-swap="innerHTML" class="join-item btn btn-sm btn-ghost" title="{{ _('Last page') }}">»</a>
                {% endif %}
            </div>
        </div>

        {% else %}
        <div class="flex flex-col items-center justify-center py-12 px-4 text-center">
            <div class="mb-4 p-4 bg-base-200 rounded-full">
                <svg class="w-12 h-12 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-base-content mb-2">{{ _('No sessions found') }}</h3>
            <p class="text-sm text-base-content/60 mb-4 max-w-md">
                {{ _('No cash sessions match your current filters. Try adjusting your search criteria or create a new session.') }}
            </p>
            <a href="/sessions/create" class="btn btn-primary btn-sm gap-2 shadow-sm hover:shadow-md transition-all duration-200 hover:scale-105 active:scale-95">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                {{ _('Create New Session') }}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
/**
 * Sort table by column
 * @param {string} column - Column to sort by ('date', 'business', 'cashier', 'status', 'sales')
 */
function sortTable(column) {
    var urlParams = new URLSearchParams(window.location.search);
    var currentSort = urlParams.get('sort_by') || 'date';
    var currentOrder = urlParams.get('sort_order') || 'desc';
    var newOrder = 'desc';
    if (currentSort === column) {
        newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    }
    urlParams.set('sort_by', column);
    urlParams.set('sort_order', newOrder);
    urlParams.set('page', '1');

    var newUrl = window.location.pathname + '?' + urlParams.toString();
    // Actualizar la URL del navegador para mantener el estado
    if (window.history && window.history.pushState) {
        window.history.pushState({}, '', newUrl);
    }

    // Usar HTMX para recargar solo la tabla
    var target = document.getElementById('sessions-table');
    if (target && window.htmx) {
        var url = '/sessions/table?' + urlParams.toString();
        window.htmx.ajax('GET', url, {target: '#sessions-table', swap: 'innerHTML'});
    } else {
        // Fallback: recargar toda la página si no hay HTMX
        window.location.search = urlParams.toString();
    }
}

/**
 * Export sessions with current filters applied
 * @param {string} format - Export format: 'csv' or 'xlsx'
 */
function exportSessions(format) {
    // Get current URL parameters (filters)
    const urlParams = new URLSearchParams(window.location.search);
    
    // Build export URL with filters
    const exportParams = new URLSearchParams();
    exportParams.set('format', format);
    
    // Copy filter parameters to export URL
    const filterParams = ['from_date', 'to_date', 'cashier_name', 'business_id', 'status'];
    filterParams.forEach(param => {
        if (urlParams.has(param)) {
            exportParams.set(param, urlParams.get(param));
        }
    });
    
    // Construct export URL
    const exportUrl = `/api/export/sessions?${exportParams.toString()}`;
    
    // Trigger download
    window.location.href = exportUrl;
}
</script>
