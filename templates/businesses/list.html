<!-- File: templates/businesses/list.html -->
{% extends "base.html" %}

{% block title %}{{ _('Businesses') }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">{{ _('Businesses') }}</h1>
        {% if current_user.role == 'ADMIN' %}
            <a href="/businesses/new" class="btn btn-primary">{{ _('+ New Business') }}</a>
        {% else %}
            <button disabled class="btn btn-primary opacity-40 cursor-not-allowed" title="{{ _('Only admins can create businesses') }}">{{ _('+ New Business') }}</button>
        {% endif %}
    </div>

    <!-- Search and Filters -->
    <div class="card bg-base-100 shadow-lg mb-4">
        <div class="card-body p-4">
            <div class="flex gap-2 flex-wrap">
                <input type="text" id="search-input" placeholder="{{ _('Search businesses...') }}"
                       class="input input-bordered flex-1 min-w-[200px]" />
                <select id="sort-select" class="select select-bordered">
                    <option value="name">{{ _('Sort by Name') }}</option>
                    <option value="active">{{ _('Active First') }}</option>
                    <option value="inactive">{{ _('Inactive First') }}</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Business Cards Grid -->
    {% if businesses %}
    <div id="businesses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        {% for business in businesses %}
        <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow business-card"
             data-name="{{ business.name|lower }}"
             data-active="{{ business.is_active|lower }}">
            <div class="card-body p-3 flex flex-col">
                <!-- Header with Status Badge -->
                <div class="flex items-start justify-between gap-2 mb-2">
                    <h2 class="card-title text-lg flex-1 break-words">
                        {{ business.name }}
                    </h2>
                    {% if not business.is_active %}
                        <span class="badge badge-warning badge-sm">{{ _('Inactive') }}</span>
                    {% endif %}
                </div>

                <!-- Business Details -->
                <div class="space-y-1 text-sm flex-1">
                    {% if business.address %}
                    <div class="flex items-start gap-2">
                        <span class="text-gray-400">ğŸ“</span>
                        <span class="text-gray-600 break-words flex-1">{{ business.address }}</span>
                    </div>
                    {% endif %}

                    {% if business.phone %}
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400">ğŸ“</span>
                        <span class="text-gray-600">{{ business.phone }}</span>
                    </div>
                    {% endif %}

                    <!-- Assigned Users Count -->
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400">ğŸ‘¥</span>
                        <span class="text-gray-600">{{ business.users|length }} {{ _('assigned users') }}</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card-actions gap-2 mt-auto pt-2 border-t border-base-200">
                    {% if current_user.role == 'ADMIN' %}
                        <a href="/businesses/{{ business.id }}/edit" class="btn btn-xs btn-outline btn-primary flex-1">
                            âœï¸ {{ _('Edit') }}
                        </a>
                    {% else %}
                        <button disabled class="btn btn-xs btn-outline btn-primary flex-1 opacity-40 cursor-not-allowed" title="{{ _('Only admins can edit businesses') }}">
                            âœï¸ {{ _('Edit') }}
                        </button>
                    {% endif %}
                    <a href="/sessions?business_id={{ business.id }}" class="btn btn-xs btn-outline flex-1">
                        ğŸ“Š {{ _('Sessions') }}
                    </a>
                    {% if current_user.role == 'ADMIN' %}
                        <button class="btn btn-xs btn-ghost" onclick="confirm('{{ _('Delete') }}?') && alert('Coming soon')">
                            ğŸ—‘ï¸
                        </button>
                    {% else %}
                        <button disabled class="btn btn-xs btn-ghost opacity-40 cursor-not-allowed" title="{{ _('Only admins can delete') }}">
                            ğŸ—‘ï¸
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Loading State (hidden, shown when fetching) -->
    <div id="loading-skeleton" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 hidden">
        {% for i in range(6) %}
        <div class="card bg-base-100 shadow animate-pulse">
            <div class="card-body p-3">
                <div class="h-5 bg-base-300 rounded w-2/3 mb-4"></div>
                <div class="space-y-2 mb-4">
                    <div class="h-4 bg-base-300 rounded w-full"></div>
                    <div class="h-4 bg-base-300 rounded w-4/5"></div>
                </div>
                <div class="flex gap-2 mt-auto">
                    <div class="h-8 bg-base-300 rounded flex-1"></div>
                    <div class="h-8 bg-base-300 rounded flex-1"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center py-12 px-4">
        <div class="text-6xl mb-4">ğŸ¢</div>
        <h2 class="text-2xl font-bold mb-2">{{ _('No businesses found') }}</h2>
        <p class="text-gray-500 text-center mb-6 max-w-sm">
            {{ _('Create your first business to start managing cash sessions and reconciliations.') }}
        </p>
        {% if current_user.role == 'ADMIN' %}
            <a href="/businesses/new" class="btn btn-primary">{{ _('+ New Business') }}</a>
        {% else %}
            <p class="text-sm text-gray-400">{{ _('Only admins can create businesses') }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Client-side search and sort
const searchInput = document.getElementById('search-input');
const sortSelect = document.getElementById('sort-select');
const grid = document.getElementById('businesses-grid');
const cards = Array.from(document.querySelectorAll('.business-card'));

function filterAndSort() {
    const query = searchInput.value.toLowerCase();
    const sortBy = sortSelect.value;

    // Filter
    let filtered = cards.filter(card => {
        const name = card.dataset.name;
        return name.includes(query);
    });

    // Sort
    filtered.sort((a, b) => {
        if (sortBy === 'name') {
            return a.dataset.name.localeCompare(b.dataset.name);
        } else if (sortBy === 'active') {
            return b.dataset.active.localeCompare(a.dataset.active);
        } else if (sortBy === 'inactive') {
            return a.dataset.active.localeCompare(b.dataset.active);
        }
        return 0;
    });

    // Re-render
    cards.forEach(card => card.style.display = 'none');
    filtered.forEach(card => {
        card.style.display = 'flex';
        grid.appendChild(card);
    });
}

searchInput.addEventListener('input', filterAndSort);
sortSelect.addEventListener('change', filterAndSort);
</script>
{% endblock %}