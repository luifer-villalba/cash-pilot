{% extends "base.html" %}

{% block title %}{{ _('Businesses') }} - CashPilot{% endblock %}

{% block content %}
<div class="px-4 py-6 md:px-6">
    <!-- Header with Search -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
        <h1 class="text-3xl md:text-4xl font-bold">{{ _('Businesses') }}</h1>
        <a href="/businesses/new" class="btn btn-primary w-full sm:w-auto">
            {{ _('+ New Business') }}
        </a>
    </div>

    <!-- Search & Sort -->
    <div class="flex flex-col sm:flex-row gap-3 mb-6">
        <input
            type="text"
            id="search-businesses"
            placeholder="{{ _('Search businesses...') }}"
            class="input input-bordered input-sm flex-1"
        />
        <select id="sort-businesses" class="select select-bordered select-sm">
            <option value="name">{{ _('Sort by Name') }}</option>
            <option value="active">{{ _('Active First') }}</option>
            <option value="inactive">{{ _('Inactive First') }}</option>
        </select>
    </div>

    <!-- Businesses Grid -->
    {% if businesses %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="businesses-container">
        {% for business in businesses %}
        <div class="card bg-base-100 shadow hover:shadow-lg transition-shadow duration-200 business-card" data-name="{{ business.name | lower }}" data-active="{{ 'true' if business.is_active else 'false' }}">
            <div class="card-body p-3">
                <!-- Header: Name + Status -->
                <div class="flex justify-between items-start gap-2 mb-2">
                    <h2 class="card-title text-base md:text-lg break-words flex-1">{{ business.name }}</h2>
                    {% if business.is_active %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-success/20 text-success font-semibold text-xs whitespace-nowrap flex-shrink-0">
                            <span class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"></span>
                            {{ _('Active') }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-neutral/20 text-neutral font-semibold text-xs whitespace-nowrap flex-shrink-0">
                            <span class="w-1.5 h-1.5 rounded-full bg-neutral"></span>
                            {{ _('Inactive') }}
                        </span>
                    {% endif %}
                </div>

                <!-- Contact Info -->
                <div class="space-y-1.5 text-sm mb-3">
                    {% if business.address %}
                    <div class="flex gap-2">
                        <span class="text-gray-500 min-w-fit">ğŸ“</span>
                        <span class="break-words text-xs md:text-sm">{{ business.address }}</span>
                    </div>
                    {% endif %}

                    {% if business.phone %}
                    <div class="flex gap-2">
                        <span class="text-gray-500 min-w-fit">ğŸ“</span>
                        <a href="tel:{{ business.phone }}" class="link link-hover text-xs md:text-sm">{{ business.phone }}</a>
                    </div>
                    {% endif %}
                </div>

                <!-- Cashiers Count -->
                <div class="mb-3">
                    <p class="text-xs font-semibold text-gray-500 mb-1">ğŸ‘¥ {{ _('Cashiers') }} ({{ business.cashiers|length }})</p>
                    {% if business.cashiers %}
                    <div class="flex flex-wrap gap-1.5">
                        {% for cashier in business.cashiers[:3] %}
                            <span class="inline-flex items-center px-2 py-0.5 bg-info text-info-content rounded text-xs font-medium">
                                {{ cashier }}
                            </span>
                        {% endfor %}
                        {% if business.cashiers|length > 3 %}
                            <span class="inline-flex items-center px-2 py-0.5 bg-base-300 text-base-content rounded text-xs font-medium">
                                +{{ business.cashiers|length - 3 }}
                            </span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-xs text-gray-400">{{ _('None') }}</p>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="card-actions gap-2 mt-auto pt-2 border-t border-base-200">
                    <a href="/businesses/{{ business.id }}/edit" class="btn btn-xs btn-outline btn-primary flex-1">
                        âœï¸ {{ _('Edit') }}
                    </a>
                    <a href="/sessions?business_id={{ business.id }}" class="btn btn-xs btn-outline flex-1">
                        ğŸ“Š {{ _('Sessions') }}
                    </a>
                    <button class="btn btn-xs btn-ghost" onclick="confirm('{{ _('Delete') }}?') && alert('Coming soon')">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Loading State (hidden, shown when fetching) -->
    <div id="loading-skeleton" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 hidden">
        {% for i in range(6) %}
        <div class="card bg-base-100 shadow animate-pulse">
            <div class="card-body p-3">
                <div class="h-5 bg-base-300 rounded w-2/3 mb-4"></div>
                <div class="space-y-2 mb-4">
                    <div class="h-4 bg-base-300 rounded w-full"></div>
                    <div class="h-4 bg-base-300 rounded w-4/5"></div>
                </div>
                <div class="flex gap-2 mt-auto">
                    <div class="h-8 bg-base-300 rounded flex-1"></div>
                    <div class="h-8 bg-base-300 rounded flex-1"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center py-12 px-4">
        <div class="text-6xl mb-4">ğŸ¢</div>
        <h2 class="text-2xl font-bold mb-2">{{ _('No businesses found') }}</h2>
        <p class="text-gray-500 text-center mb-6 max-w-sm">
            {{ _('Create your first business to start managing cash sessions and reconciliations.') }}
        </p>
        <a href="/businesses/new" class="btn btn-primary gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            {{ _('Create First Business') }}
        </a>
    </div>
    {% endif %}
</div>

<script>
    // Search functionality
    document.getElementById('search-businesses')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.business-card').forEach(card => {
            const name = card.dataset.name;
            card.style.display = name.includes(query) ? '' : 'none';
        });
    });

    // Sort functionality
    document.getElementById('sort-businesses')?.addEventListener('change', (e) => {
        const container = document.getElementById('businesses-container');
        const cards = Array.from(document.querySelectorAll('.business-card'));

        cards.sort((a, b) => {
            const sortBy = e.target.value;
            if (sortBy === 'name') {
                return a.dataset.name.localeCompare(b.dataset.name);
            } else if (sortBy === 'active') {
                return b.dataset.active.localeCompare(a.dataset.active);
            } else if (sortBy === 'inactive') {
                return a.dataset.active.localeCompare(b.dataset.active);
            }
        });

        container.innerHTML = '';
        cards.forEach(card => container.appendChild(card));
    });
</script>
{% endblock %}