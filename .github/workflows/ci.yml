name: CI/CD

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSE_DOCKER_CLI_BUILD: 1
  DOCKER_BUILDKIT: 1

jobs:
  lint:
    uses: ./.github/workflows/ci-job.yml
    with:
      timeout_minutes: 20
      use_db: false
      run_command: |
        docker compose run --rm --no-deps app bash -lc "ruff check src && black --check src && isort --check-only src"
        docker compose run --rm --no-deps app bash -lc "pip-audit --desc"

  test:
    uses: ./.github/workflows/ci-job.yml
    needs: lint
    with:
      timeout_minutes: 30
      use_db: true
      run_command: |
        docker compose run --rm app bash -lc "pytest -q"
